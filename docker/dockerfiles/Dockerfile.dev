# ============================================================================
# FARMERS MARKET PLATFORM - DEVELOPMENT DOCKER IMAGE
# Optimized for fast development with hot-reload and debugging
# HP OMEN Hardware Optimization: 12 threads, 64GB RAM, RTX 2070 Max-Q
# ============================================================================

FROM node:20-alpine

# Install development tools and dependencies
RUN apk add --no-cache \
    libc6-compat \
    openssl \
    openssl-dev \
    python3 \
    make \
    g++ \
    git \
    curl \
    bash

WORKDIR /app

# Create necessary directories with proper ownership BEFORE installing packages
RUN mkdir -p /app/uploads /app/logs /app/.next /app/node_modules /app/node_modules/.cache && \
    chown -R node:node /app && \
    chmod -R 775 /app

# Copy and set up entrypoint script
COPY docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh && \
    chown node:node /usr/local/bin/docker-entrypoint.sh

# Switch to node user EARLY to ensure all installs happen as node user
USER node

# Copy package files first for better layer caching
COPY --chown=node:node package.json package-lock.json* ./

# Install ALL dependencies (including devDependencies) as node user
RUN npm ci --legacy-peer-deps

# Copy Prisma schema
COPY --chown=node:node prisma ./prisma/

# Generate Prisma Client with correct binary target for Alpine Linux
RUN npx prisma generate --generator client

# Copy application source (will be overridden by volume mount in dev)
COPY --chown=node:node . .

# Force regenerate Prisma with Linux binaries (after all files copied)
RUN rm -rf /app/node_modules/.prisma /app/node_modules/@prisma/client && \
    npx prisma generate

# Expose ports
EXPOSE 3001 5555 9229

# Set development environment variables
ENV NODE_ENV=development \
    NEXT_TELEMETRY_DISABLED=1 \
    PORT=3001 \
    HOSTNAME="0.0.0.0" \
    # HP OMEN Optimization
    NODE_OPTIONS="--max-old-space-size=16384 --max-semi-space-size=512"

# Health check for development
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:3000/api/health || exit 1

# Set entrypoint to run startup script
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]

# Start development server with Turbopack
CMD ["npm", "run", "dev"]
