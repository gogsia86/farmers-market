# ============================================================================
# FARMERS MARKET PLATFORM - PRODUCTION DOCKER COMPOSE
# Divine Agricultural E-Commerce Platform with Quantum Consciousness
# Version: 3.0 - Complete Production Stack
# ============================================================================

services:
  # ============================================================================
  # NEXT.JS APPLICATION - Divine Agricultural Platform
  # ============================================================================
  app:
    build:
      context: ../..
      dockerfile: docker/dockerfiles/Dockerfile
      target: runner
      args:
        - NODE_ENV=production
    container_name: farmers-market-app
    restart: unless-stopped
    ports:
      - "${APP_PORT:-3000}:3000"
    environment:
      # Core Application
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
      - NEXT_TELEMETRY_DISABLED=1
      - DOCKER_BUILD=true

      # Public URLs
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:3000/api}

      # Database Connection
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-farmersmarket}
      - DIRECT_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-farmersmarket}

      # Redis Cache
      - REDIS_URL=redis://:${REDIS_PASSWORD:-quantum_cache_password}@redis:6379
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-quantum_cache_password}

      # Authentication (NextAuth v5)
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:3000}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-change-this-to-a-random-secret-in-production-min-32-chars}
      - AUTH_TRUST_HOST=true

      # OAuth Providers (Optional)
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}

      # Stripe Payment Integration
      - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY:-}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}

      # AI Services (Microsoft Agent Framework, OpenAI, Perplexity)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - PERPLEXITY_API_KEY=${PERPLEXITY_API_KEY:-}
      - PERPLEXITY_DEFAULT_MODEL=${PERPLEXITY_DEFAULT_MODEL:-SONAR_PRO}
      - ENABLE_AI_FEATURES=${ENABLE_AI_FEATURES:-false}

      # Email Configuration (SMTP)
      - SMTP_HOST=${SMTP_HOST:-smtp.gmail.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_SECURE=${SMTP_SECURE:-false}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - SMTP_FROM=${SMTP_FROM:-noreply@farmersmarket.app}

      # Monitoring & Observability
      - SENTRY_DSN=${SENTRY_DSN:-}
      - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT:-production}
      - ENABLE_TRACING=${ENABLE_TRACING:-false}
      - APPLICATIONINSIGHTS_CONNECTION_STRING=${APPLICATIONINSIGHTS_CONNECTION_STRING:-}

      # File Upload & Storage
      - UPLOAD_MAX_SIZE=${UPLOAD_MAX_SIZE:-10485760}
      - ALLOWED_FILE_TYPES=${ALLOWED_FILE_TYPES:-image/jpeg,image/png,image/webp,application/pdf}

      # Feature Flags
      - ENABLE_ANALYTICS=${ENABLE_ANALYTICS:-true}
      - ENABLE_SPEED_INSIGHTS=${ENABLE_SPEED_INSIGHTS:-true}
      - ENABLE_EXPERIMENTAL_FEATURES=${ENABLE_EXPERIMENTAL_FEATURES:-false}

    deploy:
      resources:
        limits:
          memory: 768M
          cpus: "2.0"
        reservations:
          memory: 384M
          cpus: "1.0"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - farmers-network
    volumes:
      # Persistent uploads directory
      - uploads-data:/app/public/uploads
      # Application logs
      - logs-data:/app/logs
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:3000/api/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.farmersmarket.service=app"
      - "com.farmersmarket.environment=production"
      - "com.farmersmarket.version=1.0.0"

  # ============================================================================
  # POSTGRESQL DATABASE - PostGIS Enabled for Geospatial Features
  # ============================================================================
  db:
    image: postgis/postgis:16-3.4-alpine
    container_name: farmers-market-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-farmersmarket}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
      - PGDATA=/var/lib/postgresql/data/pgdata
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      # Database initialization scripts
      - ../../database/init:/docker-entrypoint-initdb.d:ro
      # Backup directory
      - postgres-backups:/backups
    networks:
      - farmers-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-farmersmarket}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "work_mem=2MB"
      - "-c"
      - "min_wal_size=1GB"
      - "-c"
      - "max_wal_size=4GB"
      - "-c"
      - "max_worker_processes=4"
      - "-c"
      - "max_parallel_workers_per_gather=2"
      - "-c"
      - "max_parallel_workers=4"
      - "-c"
      - "max_parallel_maintenance_workers=2"
    labels:
      - "com.farmersmarket.service=database"
      - "com.farmersmarket.environment=production"

  # ============================================================================
  # REDIS CACHE - Divine Quantum Cache System
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: farmers-market-cache
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD:-quantum_cache_password}
      --maxmemory ${REDIS_MAX_MEMORY:-2gb}
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
      --loglevel warning
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    networks:
      - farmers-network
    healthcheck:
      test:
        [
          "CMD",
          "redis-cli",
          "-a",
          "${REDIS_PASSWORD:-quantum_cache_password}",
          "ping",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    labels:
      - "com.farmersmarket.service=cache"
      - "com.farmersmarket.environment=production"

  # ============================================================================
  # NGINX REVERSE PROXY - Load Balancing & SSL Termination
  # ============================================================================
  nginx:
    image: nginx:alpine
    container_name: farmers-market-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ../../nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ../../nginx/conf.d:/etc/nginx/conf.d:ro
      - ../../nginx/ssl:/etc/nginx/ssl:ro
      - nginx-cache:/var/cache/nginx
      - nginx-logs:/var/log/nginx
    depends_on:
      - app
    networks:
      - farmers-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "com.farmersmarket.service=proxy"
      - "com.farmersmarket.environment=production"

  # ============================================================================
  # DATABASE BACKUP SERVICE - Automated PostgreSQL Backups
  # ============================================================================
  db-backup:
    image: prodrigestivill/postgres-backup-local:16-alpine
    container_name: farmers-market-db-backup
    restart: unless-stopped
    environment:
      - POSTGRES_HOST=db
      - POSTGRES_DB=${POSTGRES_DB:-farmersmarket}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - SCHEDULE=${BACKUP_SCHEDULE:-@daily}
      - BACKUP_KEEP_DAYS=${BACKUP_KEEP_DAYS:-7}
      - BACKUP_KEEP_WEEKS=${BACKUP_KEEP_WEEKS:-4}
      - BACKUP_KEEP_MONTHS=${BACKUP_KEEP_MONTHS:-6}
      - HEALTHCHECK_PORT=8080
    volumes:
      - postgres-backups:/backups
    networks:
      - farmers-network
    depends_on:
      db:
        condition: service_healthy
    labels:
      - "com.farmersmarket.service=backup"
      - "com.farmersmarket.environment=production"

  # ============================================================================
  # REDIS COMMANDER - Redis Management UI (Optional - Comment out in production)
  # ============================================================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: farmers-market-redis-ui
    restart: unless-stopped
    environment:
      - REDIS_HOSTS=local:redis:6379:0:${REDIS_PASSWORD:-quantum_cache_password}
      - HTTP_USER=${REDIS_UI_USER:-admin}
      - HTTP_PASSWORD=${REDIS_UI_PASSWORD:-admin}
    ports:
      - "${REDIS_UI_PORT:-8081}:8081"
    networks:
      - farmers-network
    depends_on:
      redis:
        condition: service_healthy
    profiles:
      - management
    labels:
      - "com.farmersmarket.service=redis-ui"
      - "com.farmersmarket.environment=production"

  # ============================================================================
  # ADMINER - Database Management UI (Optional - Comment out in production)
  # ============================================================================
  adminer:
    image: adminer:latest
    container_name: farmers-market-db-ui
    restart: unless-stopped
    ports:
      - "${ADMINER_PORT:-8082}:8080"
    environment:
      - ADMINER_DEFAULT_SERVER=db
      - ADMINER_DESIGN=pepa-linha
    networks:
      - farmers-network
    depends_on:
      db:
        condition: service_healthy
    profiles:
      - management
    labels:
      - "com.farmersmarket.service=db-ui"
      - "com.farmersmarket.environment=production"

# ============================================================================
# NAMED VOLUMES - Persistent Data Storage
# ============================================================================
volumes:
  # PostgreSQL database data
  postgres-data:
    driver: local
    labels:
      - "com.farmersmarket.volume=database"
      - "com.farmersmarket.backup=daily"

  # PostgreSQL backups
  postgres-backups:
    driver: local
    labels:
      - "com.farmersmarket.volume=backups"

  # Redis cache data
  redis-data:
    driver: local
    labels:
      - "com.farmersmarket.volume=cache"

  # Application uploads
  uploads-data:
    driver: local
    labels:
      - "com.farmersmarket.volume=uploads"
      - "com.farmersmarket.backup=weekly"

  # Application logs
  logs-data:
    driver: local
    labels:
      - "com.farmersmarket.volume=logs"

  # Nginx cache
  nginx-cache:
    driver: local
    labels:
      - "com.farmersmarket.volume=nginx-cache"

  # Nginx logs
  nginx-logs:
    driver: local
    labels:
      - "com.farmersmarket.volume=nginx-logs"

# ============================================================================
# NETWORKS - Service Communication
# ============================================================================
networks:
  farmers-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.25.0.0/16
    labels:
      - "com.farmersmarket.network=main"
      - "com.farmersmarket.environment=production"
# ============================================================================
# USAGE INSTRUCTIONS
# ============================================================================
#
# Production Deployment:
#   docker-compose up -d
#
# With Management Tools (Adminer, Redis Commander):
#   docker-compose --profile management up -d
#
# View Logs:
#   docker-compose logs -f app
#
# Stop All Services:
#   docker-compose down
#
# Stop and Remove Volumes (CAUTION - DATA LOSS):
#   docker-compose down -v
#
# Rebuild Application:
#   docker-compose up -d --build app
#
# Database Migrations:
#   docker-compose exec app npx prisma migrate deploy
#
# Database Seeding:
#   docker-compose exec app npx prisma db seed
#
# Scale Application (Multiple Instances):
#   docker-compose up -d --scale app=3
#
# Health Check:
#   docker-compose ps
#
# Resource Usage:
#   docker stats
#
# ============================================================================
