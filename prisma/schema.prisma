generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  relationMode = "foreignKeys"
}

model User {
  id                      String                   @id @default(cuid())
  email                   String                   @unique @db.VarChar(255)
  password                String?                  @db.VarChar(255)
  firstName               String?                  @db.VarChar(100)
  lastName                String?                  @db.VarChar(100)
  name                    String?                  @db.VarChar(255)
  phone                   String?                  @db.VarChar(20)
  avatar                  String?                  @db.VarChar(500)
  role                    UserRole                 @default(CONSUMER)
  status                  UserStatus               @default(ACTIVE)
  approvedBy              String?
  approvedAt              DateTime?
  suspendedBy             String?
  suspendedAt             DateTime?
  suspensionReason        String?
  emailVerified           Boolean                  @default(false)
  emailVerifiedAt         DateTime?
  phoneVerified           Boolean                  @default(false)
  phoneVerifiedAt         DateTime?
  verificationToken       String?                  @unique @db.VarChar(255)
  verificationExpiry      DateTime?
  resetToken              String?                  @unique @db.VarChar(255)
  resetTokenExpiry        DateTime?
  dietaryPreferences      Json?
  notificationPreferences Json?
  privacySettings         Json?
  lastLoginAt             DateTime?
  lastLoginIP             String?                  @db.VarChar(45)
  loginCount              Int                      @default(0)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  accounts                Account[]
  Address                 Address[]
  adminActions            AdminAction[]            @relation("AdminActions")
  auditLogs               AuditLog[]
  cartItems               CartItem[]
  downloadLogs            DownloadLog[]
  teamMemberships         FarmTeamMember[]
  farms                   Farm[]
  messages                Message[]                @relation("MessageSender")
  notificationSettings    NotificationPreferences?
  notifications           Notification[]
  orders                  Order[]
  qualityIssues           QualityIssue[]
  reviews                 Review[]
  sessions                Session[]
  supportTickets          SupportTicket[]
  addresses               UserAddress[]

  @@index([email])
  @@index([role, status])
  @@index([createdAt])
  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  sessionToken String   @unique @db.VarChar(255)
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@map("sessions")
}

model Account {
  id                String    @id @default(cuid())
  userId            String
  provider          String    @db.VarChar(50)
  providerAccountId String    @db.VarChar(255)
  refreshToken      String?
  accessToken       String?
  expiresAt         DateTime?
  tokenType         String?   @db.VarChar(50)
  scope             String?   @db.VarChar(255)
  idToken           String?
  sessionState      String?   @db.VarChar(255)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model UserAddress {
  id        String      @id @default(cuid())
  userId    String
  type      AddressType @default(HOME)
  label     String?     @db.VarChar(100)
  street    String      @db.VarChar(255)
  street2   String?     @db.VarChar(255)
  city      String      @db.VarChar(100)
  state     String      @db.VarChar(50)
  zipCode   String      @db.VarChar(20)
  country   String      @default("US") @db.VarChar(2)
  latitude  Decimal?    @db.Decimal(10, 8)
  longitude Decimal?    @db.Decimal(11, 8)
  isDefault Boolean     @default(false)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  orders    Order[]     @relation("DeliveryAddress")
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([zipCode])
  @@map("user_addresses")
}

model AdminAction {
  id          String          @id @default(cuid())
  type        AdminActionType
  adminId     String
  targetId    String?
  targetType  String?         @db.VarChar(50)
  description String
  metadata    Json?
  ipAddress   String?         @db.VarChar(45)
  userAgent   String?         @db.VarChar(500)
  createdAt   DateTime        @default(now())
  admin       User            @relation("AdminActions", fields: [adminId], references: [id])

  @@index([adminId])
  @@index([type])
  @@index([createdAt])
  @@index([targetId, targetType])
  @@map("admin_actions")
}

model Farm {
  id                     String                 @id @default(cuid())
  name                   String                 @db.VarChar(255)
  slug                   String                 @unique @db.VarChar(255)
  description            String?
  story                  String?
  status                 FarmStatus             @default(PENDING)
  verificationStatus     FarmVerificationStatus @default(PENDING)
  verifiedBy             String?
  verifiedAt             DateTime?
  rejectionReason        String?
  ownerId                String
  email                  String                 @db.VarChar(255)
  phone                  String                 @db.VarChar(20)
  website                String?                @db.VarChar(500)
  address                String                 @db.VarChar(255)
  city                   String                 @db.VarChar(100)
  state                  String                 @db.VarChar(50)
  zipCode                String                 @db.VarChar(20)
  country                String                 @default("US") @db.VarChar(2)
  latitude               Decimal                @db.Decimal(10, 8)
  longitude              Decimal                @db.Decimal(11, 8)
  location               Json?
  images                 String[]
  logoUrl                String?                @db.VarChar(500)
  bannerUrl              String?                @db.VarChar(500)
  businessName           String?                @db.VarChar(255)
  taxId                  String?                @db.VarChar(50)
  businessType           String?                @db.VarChar(50)
  yearEstablished        Int?
  farmSize               Decimal?               @db.Decimal(10, 2)
  certificationsArray    String[]
  stripeAccountId        String?                @unique @db.VarChar(255)
  stripeOnboarded        Boolean                @default(false)
  stripeOnboardedAt      DateTime?
  payoutsEnabled         Boolean                @default(false)
  stripeDetailsSubmitted Boolean                @default(false)
  productCategories      Json?
  farmingPractices       Json?
  deliveryRadius         Int?                   @default(25)
  profileViewsCount      Int                    @default(0)
  totalOrdersCount       Int                    @default(0)
  totalRevenueUSD        Decimal                @default(0) @db.Decimal(12, 2)
  averageRating          Decimal?               @db.Decimal(3, 2)
  reviewCount            Int                    @default(0)
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  biodynamicCalendar     BiodynamicCalendar[]
  cropRotations          CropRotation[]
  DeliverySlot           DeliverySlot[]
  DeliveryZone           DeliveryZone[]
  certifications         FarmCertification[]
  photos                 FarmPhoto[]
  FarmRating             FarmRating?
  teamMembers            FarmTeamMember[]
  owner                  User                   @relation(fields: [ownerId], references: [id])
  harvestSchedules       HarvestSchedule[]
  Inventory              Inventory[]
  marketLocations        MarketLocation[]
  messages               Message[]
  notifications          Notification[]
  orders                 Order[]
  payouts                Payout[]
  PickupLocation         PickupLocation[]
  products               Product[]
  qualityIssues          QualityIssue[]
  reviews                Review[]
  soilAnalyses           SoilAnalysis[]
  weatherData            WeatherData[]

  @@index([ownerId])
  @@index([slug])
  @@index([status])
  @@index([latitude, longitude])
  @@index([createdAt])
  @@map("farms")
}

model FarmTeamMember {
  id        String           @id @default(cuid())
  farmId    String
  email     String           @db.VarChar(255)
  userId    String?
  role      TeamMemberRole   @default(STAFF)
  status    TeamMemberStatus @default(INVITED)
  invitedAt DateTime         @default(now())
  invitedBy String
  joinedAt  DateTime?
  removedAt DateTime?
  removedBy String?
  farm      Farm             @relation(fields: [farmId], references: [id], onDelete: Cascade)
  user      User?            @relation(fields: [userId], references: [id])

  @@unique([farmId, email])
  @@index([farmId])
  @@index([userId])
  @@map("farm_team_members")
}

model FarmPhoto {
  id           String   @id @default(cuid())
  farmId       String
  photoUrl     String   @db.VarChar(500)
  thumbnailUrl String   @db.VarChar(500)
  caption      String?  @db.VarChar(255)
  altText      String?  @db.VarChar(255)
  sortOrder    Int      @default(0)
  isPrimary    Boolean  @default(false)
  width        Int?
  height       Int?
  fileSize     Int?
  createdAt    DateTime @default(now())
  farm         Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([isPrimary])
  @@map("farm_photos")
}

model FarmCertification {
  id                  String              @id @default(cuid())
  farmId              String
  type                CertificationType
  certifierName       String              @db.VarChar(255)
  certificationNumber String?             @db.VarChar(100)
  documentUrl         String?             @db.VarChar(500)
  issueDate           DateTime
  expirationDate      DateTime?
  status              CertificationStatus @default(PENDING)
  notes               String?
  verifiedBy          String?
  verifiedAt          DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  farm                Farm                @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([type])
  @@index([status])
  @@index([expirationDate])
  @@map("farm_certifications")
}

model MarketLocation {
  id          String   @id @default(cuid())
  farmId      String
  marketName  String   @db.VarChar(255)
  boothNumber String?  @db.VarChar(50)
  address     String   @db.VarChar(255)
  city        String   @db.VarChar(100)
  state       String   @db.VarChar(50)
  zipCode     String   @db.VarChar(20)
  latitude    Decimal  @db.Decimal(10, 8)
  longitude   Decimal  @db.Decimal(11, 8)
  schedule    Json
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  farm        Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@map("market_locations")
}

model BiodynamicCalendar {
  id                        String     @id @default(cuid())
  farmId                    String
  lunarPhase                LunarPhase
  lunarDay                  Int
  moonRiseTime              DateTime?
  moonSetTime               DateTime?
  season                    Season
  astronomicalDate          DateTime
  plantingFavorability      Int        @default(0)
  harvestFavorability       Int        @default(0)
  soilWorkFavorability      Int        @default(0)
  planetaryAlignment        Json?
  recommendedActivities     String[]
  avoidActivities           String[]
  agriculturalConsciousness Decimal    @default(0.0) @db.Decimal(3, 2)
  createdAt                 DateTime   @default(now())
  updatedAt                 DateTime   @updatedAt
  farm                      Farm       @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@unique([farmId, astronomicalDate])
  @@index([farmId])
  @@index([season])
  @@index([lunarPhase])
  @@map("biodynamic_calendar")
}

model SoilAnalysis {
  id                String          @id @default(cuid())
  farmId            String
  fieldName         String          @db.VarChar(255)
  latitude          Decimal         @db.Decimal(10, 8)
  longitude         Decimal         @db.Decimal(11, 8)
  pH                Decimal         @db.Decimal(4, 2)
  nitrogen          Decimal         @db.Decimal(5, 2)
  phosphorus        Decimal         @db.Decimal(5, 2)
  potassium         Decimal         @db.Decimal(5, 2)
  organicMatter     Decimal         @db.Decimal(5, 2)
  soilType          SoilType
  drainage          DrainageLevel
  compaction        CompactionLevel
  microbialActivity Decimal         @default(0.0) @db.Decimal(3, 2)
  earthwormCount    Int?
  fungalPresence    Decimal?        @db.Decimal(3, 2)
  previousCrops     Json?
  soilHistory       Json?
  amendments        String[]
  recommendedCrops  String[]
  analyzedBy        String?         @db.VarChar(255)
  analysisDate      DateTime        @default(now())
  nextAnalysisDate  DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  farm              Farm            @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([fieldName])
  @@index([analysisDate])
  @@map("soil_analyses")
}

model WeatherData {
  id                 String           @id @default(cuid())
  farmId             String
  recordedAt         DateTime         @default(now())
  latitude           Decimal          @db.Decimal(10, 8)
  longitude          Decimal          @db.Decimal(11, 8)
  temperature        Decimal          @db.Decimal(5, 2)
  feelsLike          Decimal?         @db.Decimal(5, 2)
  tempMin            Decimal?         @db.Decimal(5, 2)
  tempMax            Decimal?         @db.Decimal(5, 2)
  humidity           Int
  precipitation      Decimal?         @db.Decimal(6, 2)
  precipitationProb  Int?
  windSpeed          Decimal?         @db.Decimal(5, 2)
  windDirection      Int?
  condition          WeatherCondition
  cloudCover         Int?
  uvIndex            Int?
  visibility         Decimal?         @db.Decimal(5, 2)
  growingDegreeDay   Decimal?         @db.Decimal(5, 2)
  evapotranspiration Decimal?         @db.Decimal(5, 2)
  soilMoisture       Decimal?         @db.Decimal(3, 2)
  frostRisk          Boolean          @default(false)
  heatStressRisk     Boolean          @default(false)
  source             String           @default("API") @db.VarChar(50)
  createdAt          DateTime         @default(now())
  farm               Farm             @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([recordedAt])
  @@map("weather_data")
}

model CropRotation {
  id                  String     @id @default(cuid())
  farmId              String
  fieldName           String     @db.VarChar(255)
  rotationCycle       Int
  currentYear         Int
  currentCrop         String     @db.VarChar(100)
  currentCropFamily   CropFamily
  plantedAt           DateTime
  expectedHarvest     DateTime?
  cropHistory         Json
  plannedRotations    Json
  coverCropPlanned    Boolean    @default(false)
  coverCropType       String?    @db.VarChar(100)
  restPeriod          Boolean    @default(false)
  followsBiodynamic   Boolean    @default(false)
  biodynamicScore     Decimal    @default(0.0) @db.Decimal(3, 2)
  nextRecommendedCrop String?    @db.VarChar(100)
  soilBenefits        String[]
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  farm                Farm       @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@unique([farmId, fieldName])
  @@index([farmId])
  @@index([currentCropFamily])
  @@map("crop_rotations")
}

model HarvestSchedule {
  id                   String          @id @default(cuid())
  farmId               String
  productId            String?
  cropName             String          @db.VarChar(255)
  cropVariety          String?         @db.VarChar(255)
  fieldName            String          @db.VarChar(255)
  plantedAt            DateTime
  plantedQuantity      Decimal?        @db.Decimal(10, 2)
  plantedUnit          String?         @db.VarChar(50)
  expectedHarvestStart DateTime
  expectedHarvestEnd   DateTime?
  actualHarvestStart   DateTime?
  actualHarvestEnd     DateTime?
  harvestConfidence    Decimal         @default(0.5) @db.Decimal(3, 2)
  predictedYield       Decimal?        @db.Decimal(10, 2)
  predictedYieldUnit   String?         @db.VarChar(50)
  actualYield          Decimal?        @db.Decimal(10, 2)
  actualYieldUnit      String?         @db.VarChar(50)
  harvestQuality       HarvestQuality?
  optimalLunarPhase    LunarPhase?
  seasonalAlignment    Season
  biodynamicTiming     Boolean         @default(false)
  estimatedLaborHours  Decimal?        @db.Decimal(6, 2)
  actualLaborHours     Decimal?        @db.Decimal(6, 2)
  laborersNeeded       Int?
  status               HarvestStatus   @default(PLANNED)
  notes                String?
  challenges           String[]
  successes            String[]
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  farm                 Farm            @relation(fields: [farmId], references: [id], onDelete: Cascade)
  product              Product?        @relation(fields: [productId], references: [id])

  @@index([farmId])
  @@index([productId])
  @@index([status])
  @@index([expectedHarvestStart])
  @@index([seasonalAlignment])
  @@map("harvest_schedules")
}

model Product {
  id                   String            @id @default(cuid())
  farmId               String
  name                 String            @db.VarChar(255)
  slug                 String            @db.VarChar(255)
  description          String?           @db.VarChar(500)
  category             ProductCategory
  status               ProductStatus     @default(DRAFT)
  price                Decimal           @db.Decimal(10, 2)
  compareAtPrice       Decimal?          @db.Decimal(10, 2)
  unit                 String            @db.VarChar(50)
  trackInventory       Boolean           @default(true)
  quantityAvailable    Decimal?          @db.Decimal(10, 2)
  lowStockThreshold    Decimal?          @db.Decimal(10, 2)
  allowBackorder       Boolean           @default(false)
  inStock              Boolean           @default(true)
  organic              Boolean           @default(false)
  seasonal             Boolean           @default(false)
  featured             Boolean           @default(false)
  seasonalStart        DateTime?
  seasonalEnd          DateTime?
  harvestDate          DateTime?
  storageInstructions  String?
  primaryPhotoUrl      String?           @db.VarChar(500)
  photoUrls            Json?
  images               String[]
  hasVariants          Boolean           @default(false)
  variants             Json?
  tags                 Json?
  pricing              Json?
  inventory            Json?
  attributes           Json?
  scheduledPublishAt   DateTime?
  scheduledUnpublishAt DateTime?
  publishedAt          DateTime?
  viewsCount           Int               @default(0)
  cartAddsCount        Int               @default(0)
  purchaseCount        Int               @default(0)
  wishlistCount        Int               @default(0)
  averageRating        Decimal?          @db.Decimal(3, 2)
  reviewCount          Int               @default(0)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  cartItems            CartItem[]
  harvestSchedules     HarvestSchedule[]
  Inventory            Inventory[]
  inventoryLogs        InventoryLog[]
  orderItems           OrderItem[]
  farm                 Farm              @relation(fields: [farmId], references: [id], onDelete: Cascade)
  reviews              Review[]
  SeasonalCycle        SeasonalCycle[]

  @@unique([farmId, slug])
  @@index([farmId])
  @@index([category])
  @@index([status])
  @@index([organic])
  @@index([createdAt])
  @@index([farmId, inStock])
  @@index([farmId, category, inStock])
  @@index([quantityAvailable])
  @@map("products")
}

model ProductTemplate {
  id           String          @id @default(cuid())
  farmId       String?
  name         String          @db.VarChar(255)
  category     ProductCategory
  templateData Json
  useCount     Int             @default(0)
  isPublic     Boolean         @default(false)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@index([farmId])
  @@index([category])
  @@map("product_templates")
}

model InventoryLog {
  id               String   @id @default(cuid())
  productId        String
  previousQuantity Decimal  @db.Decimal(10, 2)
  newQuantity      Decimal  @db.Decimal(10, 2)
  changeAmount     Decimal  @db.Decimal(10, 2)
  changeReason     String   @db.VarChar(100)
  notes            String?
  changedBy        String
  createdAt        DateTime @default(now())
  product          Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([createdAt])
  @@map("inventory_logs")
}

model CartItem {
  id                String            @id @default(cuid())
  userId            String
  productId         String
  farmId            String
  quantity          Decimal           @db.Decimal(10, 2)
  unit              String            @db.VarChar(50)
  priceAtAdd        Decimal           @db.Decimal(10, 2)
  fulfillmentMethod FulfillmentMethod @default(DELIVERY)
  reservedUntil     DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  product           Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
  @@index([farmId])
  @@index([reservedUntil])
  @@map("cart_items")
}

model Order {
  id                    String            @id @default(cuid())
  orderNumber           String            @unique @db.VarChar(50)
  customerId            String
  farmId                String
  status                OrderStatus       @default(PENDING)
  paymentStatus         PaymentStatus     @default(PENDING)
  subtotal              Decimal           @db.Decimal(10, 2)
  deliveryFee           Decimal           @default(0) @db.Decimal(10, 2)
  platformFee           Decimal           @db.Decimal(10, 2)
  tax                   Decimal           @default(0) @db.Decimal(10, 2)
  discount              Decimal           @default(0) @db.Decimal(10, 2)
  total                 Decimal           @db.Decimal(10, 2)
  farmerAmount          Decimal           @db.Decimal(10, 2)
  fulfillmentMethod     FulfillmentMethod
  deliveryAddressId     String?
  scheduledDate         DateTime?
  scheduledTimeSlot     String?           @db.VarChar(50)
  fulfillmentNotes      String?
  stripePaymentIntentId String?           @unique @db.VarChar(255)
  stripeChargeId        String?           @db.VarChar(255)
  stripeTransferId      String?           @db.VarChar(255)
  paymentIntentId       String?           @db.VarChar(255)
  paidAt                DateTime?
  trackingNumber        String?           @db.VarChar(255)
  shippingService       String?           @db.VarChar(100)
  shippingAddress       Json?
  deliverySlotId        String?
  specialInstructions   String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  confirmedAt           DateTime?
  fulfilledAt           DateTime?
  completedAt           DateTime?
  cancelledAt           DateTime?
  cancelledBy           String?
  cancelReason          String?
  fulfillment           Fulfillment?
  messages              Message[]
  items                 OrderItem[]
  customer              User              @relation(fields: [customerId], references: [id])
  deliveryAddress       UserAddress?      @relation("DeliveryAddress", fields: [deliveryAddressId], references: [id])
  farm                  Farm              @relation(fields: [farmId], references: [id])
  Payment               Payment?
  qualityIssues         QualityIssue[]
  refunds               Refund[]
  reviews               Review[]

  @@index([customerId])
  @@index([farmId])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@index([orderNumber])
  @@index([farmId, createdAt])
  @@index([customerId, createdAt])
  @@index([status, createdAt])
  @@map("orders")
}

model OrderItem {
  id              String  @id @default(cuid())
  orderId         String
  productId       String
  productName     String  @db.VarChar(255)
  quantity        Decimal @db.Decimal(10, 2)
  unit            String  @db.VarChar(50)
  unitPrice       Decimal @db.Decimal(10, 2)
  subtotal        Decimal @db.Decimal(10, 2)
  productSnapshot Json?
  order           Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product         Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model Fulfillment {
  id                String            @id @default(cuid())
  orderId           String            @unique
  status            FulfillmentStatus @default(PENDING)
  trackingNumber    String?           @db.VarChar(100)
  carrierName       String?           @db.VarChar(100)
  estimatedDate     DateTime?
  actualDate        DateTime?
  proofPhotoUrl     String?           @db.VarChar(500)
  signature         String?
  recipientName     String?           @db.VarChar(255)
  deliveryNotes     String?
  gpsLatitude       Decimal?          @db.Decimal(10, 8)
  gpsLongitude      Decimal?          @db.Decimal(11, 8)
  deliveryTimestamp DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  order             Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@map("fulfillments")
}

model Payment {
  id                    String        @id @default(cuid())
  orderId               String        @unique
  amount                Decimal       @db.Decimal(10, 2)
  currency              String        @default("usd") @db.VarChar(3)
  status                PaymentStatus @default(PENDING)
  paymentMethod         String        @db.VarChar(50)
  stripePaymentIntentId String?       @unique @db.VarChar(255)
  paypalOrderId         String?       @unique @db.VarChar(255)
  paidAt                DateTime?
  failureReason         String?
  receiptUrl            String?       @db.VarChar(500)
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  order                 Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@index([stripePaymentIntentId])
  @@index([paypalOrderId])
  @@map("payments")
}

model Payout {
  id             String    @id @default(cuid())
  farmId         String
  amount         Decimal   @db.Decimal(10, 2)
  currency       String    @default("USD") @db.VarChar(3)
  status         String    @db.VarChar(50)
  stripePayoutId String?   @unique @db.VarChar(255)
  periodStart    DateTime
  periodEnd      DateTime
  orderCount     Int
  scheduledDate  DateTime
  paidDate       DateTime?
  failureReason  String?
  createdAt      DateTime  @default(now())
  farm           Farm      @relation(fields: [farmId], references: [id])

  @@index([farmId])
  @@index([status])
  @@index([scheduledDate])
  @@map("payouts")
}

model Refund {
  id             String    @id @default(cuid())
  orderId        String
  amount         Decimal   @db.Decimal(10, 2)
  reason         String    @db.VarChar(255)
  notes          String?
  stripeRefundId String?   @unique @db.VarChar(255)
  status         String    @db.VarChar(50)
  processedAt    DateTime?
  createdAt      DateTime  @default(now())
  order          Order     @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@map("refunds")
}

model QualityIssue {
  id                   String             @id @default(cuid())
  orderId              String
  customerId           String
  farmId               String
  type                 QualityIssueType
  description          String             @db.VarChar(500)
  photoUrl             String?            @db.VarChar(500)
  status               QualityIssueStatus @default(OPEN)
  resolutionPreference ResolutionType
  resolution           ResolutionType?
  resolutionNotes      String?
  refundAmount         Decimal?           @db.Decimal(10, 2)
  createdAt            DateTime           @default(now())
  resolvedAt           DateTime?
  resolvedBy           String?
  customer             User               @relation(fields: [customerId], references: [id])
  farm                 Farm               @relation(fields: [farmId], references: [id])
  order                Order              @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([customerId])
  @@index([farmId])
  @@index([status])
  @@map("quality_issues")
}

model Review {
  id                 String       @id @default(cuid())
  farmId             String
  productId          String?
  customerId         String
  orderId            String?
  rating             Int
  reviewText         String?      @db.VarChar(500)
  photoUrl           String?      @db.VarChar(500)
  isVerifiedPurchase Boolean      @default(false)
  status             ReviewStatus @default(PENDING)
  helpfulCount       Int          @default(0)
  unhelpfulCount     Int          @default(0)
  farmerResponse     String?      @db.VarChar(500)
  farmerRespondedAt  DateTime?
  flaggedReason      String?      @db.VarChar(255)
  flaggedAt          DateTime?
  moderatedBy        String?
  moderatedAt        DateTime?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  customer           User         @relation(fields: [customerId], references: [id])
  farm               Farm         @relation(fields: [farmId], references: [id])
  order              Order?       @relation(fields: [orderId], references: [id])
  product            Product?     @relation(fields: [productId], references: [id])

  @@index([farmId])
  @@index([productId])
  @@index([customerId])
  @@index([orderId])
  @@index([status])
  @@index([createdAt])
  @@index([productId, createdAt])
  @@index([rating])
  @@index([farmId, rating])
  @@map("reviews")
}

model FarmRating {
  id             String   @id @default(cuid())
  farmId         String   @unique
  averageRating  Float    @default(0)
  totalReviews   Int      @default(0)
  productQuality Float    @default(0)
  communication  Float    @default(0)
  delivery       Float    @default(0)
  packaging      Float    @default(0)
  fiveStarCount  Int      @default(0)
  fourStarCount  Int      @default(0)
  threeStarCount Int      @default(0)
  twoStarCount   Int      @default(0)
  oneStarCount   Int      @default(0)
  updatedAt      DateTime @updatedAt
  farm           Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([averageRating])
  @@map("farm_ratings")
}

model Message {
  id          String    @id @default(cuid())
  senderId    String
  recipientId String?
  farmId      String?
  orderId     String?
  subject     String?   @db.VarChar(255)
  body        String
  isRead      Boolean   @default(false)
  readAt      DateTime?
  createdAt   DateTime  @default(now())
  farm        Farm?     @relation(fields: [farmId], references: [id])
  order       Order?    @relation(fields: [orderId], references: [id])
  sender      User      @relation("MessageSender", fields: [senderId], references: [id])

  @@index([senderId])
  @@index([recipientId])
  @@index([farmId])
  @@index([orderId])
  @@index([isRead])
  @@map("messages")
}

model Notification {
  id        String              @id @default(cuid())
  userId    String?
  farmId    String?
  type      NotificationType
  channel   NotificationChannel
  title     String              @db.VarChar(255)
  body      String
  data      Json?
  isRead    Boolean             @default(false)
  readAt    DateTime?
  sentAt    DateTime?
  createdAt DateTime            @default(now())
  farm      Farm?               @relation(fields: [farmId], references: [id])
  user      User?               @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([farmId])
  @@index([type])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model AnalyticsEvent {
  id         String   @id @default(cuid())
  eventType  String   @db.VarChar(100)
  userId     String?
  farmId     String?
  productId  String?
  orderId    String?
  sessionId  String?  @db.VarChar(255)
  properties Json?
  userAgent  String?
  ipAddress  String?  @db.VarChar(45)
  referrer   String?  @db.VarChar(500)
  createdAt  DateTime @default(now())

  @@index([eventType])
  @@index([userId])
  @@index([farmId])
  @@index([productId])
  @@index([createdAt])
  @@map("analytics_events")
}

model DeliveryZone {
  id              String   @id @default(cuid())
  farmId          String
  name            String   @db.VarChar(255)
  description     String?
  zipCodes        String[]
  cities          String[]
  baseFee         Decimal  @db.Decimal(10, 2)
  perMileFee      Decimal  @default(0) @db.Decimal(10, 2)
  minimumOrder    Decimal  @default(0) @db.Decimal(10, 2)
  freeDeliveryMin Decimal  @default(0) @db.Decimal(10, 2)
  availableDays   String[]
  cutoffHours     Int      @default(24)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  farm            Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([isActive])
  @@map("delivery_zones")
}

model DeliverySlot {
  id            String   @id @default(cuid())
  farmId        String
  date          DateTime @db.Date
  startTime     String   @db.VarChar(10)
  endTime       String   @db.VarChar(10)
  maxOrders     Int      @default(10)
  currentOrders Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  farm          Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([date])
  @@index([isActive])
  @@map("delivery_slots")
}

model PickupLocation {
  id             String   @id @default(cuid())
  farmId         String
  name           String   @db.VarChar(255)
  address        String   @db.VarChar(500)
  city           String   @db.VarChar(100)
  state          String   @db.VarChar(50)
  zipCode        String   @db.VarChar(20)
  instructions   String?
  latitude       Decimal? @db.Decimal(10, 8)
  longitude      Decimal? @db.Decimal(11, 8)
  availableDays  String[]
  availableHours String?  @db.VarChar(255)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  farm           Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([isActive])
  @@map("pickup_locations")
}

model Address {
  id        String      @id @default(cuid())
  userId    String?
  fullName  String      @db.VarChar(255)
  street    String      @db.VarChar(500)
  city      String      @db.VarChar(100)
  state     String      @db.VarChar(50)
  zipCode   String      @db.VarChar(20)
  country   String      @default("USA") @db.VarChar(50)
  phone     String?     @db.VarChar(20)
  latitude  Decimal?    @db.Decimal(10, 8)
  longitude Decimal?    @db.Decimal(11, 8)
  type      AddressType @default(HOME)
  isDefault Boolean     @default(false)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  user      User?       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("addresses")
}

model SeasonalCycle {
  id             String      @id @default(cuid())
  productId      String
  season         Season
  phase          GrowthPhase
  startDate      DateTime
  endDate        DateTime?
  lunarPhase     String?     @db.VarChar(50)
  soilConditions Json?
  energyLevel    Int?
  notes          String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  product        Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([season])
  @@index([phase])
  @@index([startDate, endDate])
  @@map("seasonal_cycles")
}

model Inventory {
  id           String           @id @default(cuid())
  farmId       String
  productId    String
  sku          String           @unique @db.VarChar(100)
  quantity     Int              @default(0)
  reservedQty  Int              @default(0)
  availableQty Int              @default(0)
  reorderPoint Int              @default(10)
  reorderQty   Int              @default(50)
  costPrice    Decimal          @db.Decimal(10, 2)
  sellingPrice Decimal          @db.Decimal(10, 2)
  pricePerUnit Decimal          @db.Decimal(10, 2)
  location     String?          @db.VarChar(100)
  zone         String?          @db.VarChar(50)
  status       InventoryStatus  @default(IN_STOCK)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  farm         Farm             @relation(fields: [farmId], references: [id], onDelete: Cascade)
  product      Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  alerts       InventoryAlert[]
  batches      ProductBatch[]
  movements    StockMovement[]

  @@index([farmId])
  @@index([productId])
  @@index([status])
  @@index([quantity])
  @@map("inventory")
}

model ProductBatch {
  id              String    @id @default(cuid())
  inventoryId     String
  batchNumber     String    @unique @db.VarChar(100)
  quantity        Int
  receivedQty     Int
  damagedQty      Int       @default(0)
  receivedDate    DateTime  @default(now())
  expiryDate      DateTime?
  manufactureDate DateTime?
  supplier        String?   @db.VarChar(255)
  cost            Decimal?  @db.Decimal(10, 2)
  qualityGrade    String?   @db.VarChar(20)
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  inventory       Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  @@index([inventoryId])
  @@index([expiryDate])
  @@map("product_batches")
}

model StockMovement {
  id          String            @id @default(cuid())
  inventoryId String
  type        StockMovementType
  quantity    Int
  reference   String?           @db.VarChar(255)
  previousQty Int
  newQty      Int
  reason      String?
  performedBy String            @db.VarChar(255)
  createdAt   DateTime          @default(now())
  inventory   Inventory         @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  @@index([inventoryId])
  @@index([type])
  @@index([createdAt])
  @@map("stock_movements")
}

model InventoryAlert {
  id          String        @id @default(cuid())
  inventoryId String
  type        AlertType
  severity    AlertSeverity
  message     String
  isRead      Boolean       @default(false)
  isResolved  Boolean       @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?       @db.VarChar(255)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  inventory   Inventory     @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  @@index([inventoryId])
  @@index([type])
  @@index([severity])
  @@index([isResolved])
  @@map("inventory_alerts")
}

model SupportTicket {
  id             String                 @id @default(cuid())
  userId         String
  subject        String                 @db.VarChar(255)
  description    String
  category       SupportTicketCategory  @default(GENERAL)
  priority       SupportTicketPriority  @default(MEDIUM)
  status         SupportTicketStatus    @default(OPEN)
  assignedTo     String?
  assignedAt     DateTime?
  tags           String[]               @default([])
  relatedOrderId String?
  relatedFarmId  String?
  resolvedAt     DateTime?
  resolvedBy     String?
  resolutionNote String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  files          SupportTicketFile[]
  messages       SupportTicketMessage[]
  user           User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([assignedTo])
  @@index([createdAt])
  @@map("support_tickets")
}

model SupportTicketMessage {
  id         String        @id @default(cuid())
  ticketId   String
  content    String
  isStaff    Boolean       @default(false)
  authorId   String
  isInternal Boolean       @default(false)
  isRead     Boolean       @default(false)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  ticket     SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([authorId])
  @@index([createdAt])
  @@map("support_ticket_messages")
}

model SupportTicketFile {
  id          String        @id @default(cuid())
  ticketId    String
  filename    String        @db.VarChar(255)
  url         String        @db.VarChar(500)
  mimeType    String        @db.VarChar(100)
  size        Int
  description String?
  uploadedBy  String
  createdAt   DateTime      @default(now())
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([uploadedBy])
  @@map("support_ticket_files")
}

model NotificationPreferences {
  id              String   @id @default(cuid())
  userId          String   @unique
  emailOrders     Boolean  @default(true)
  emailReviews    Boolean  @default(true)
  emailPromotions Boolean  @default(false)
  emailNewsletter Boolean  @default(false)
  inAppOrders     Boolean  @default(true)
  inAppReviews    Boolean  @default(true)
  inAppMessages   Boolean  @default(true)
  pushOrders      Boolean  @default(true)
  pushReviews     Boolean  @default(true)
  pushPromotions  Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notification_preferences")
}

model DownloadLog {
  id         String   @id @default(cuid())
  userId     String?
  resourceId String   @db.VarChar(255)
  ipAddress  String?  @db.VarChar(45)
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([resourceId])
  @@index([createdAt])
  @@map("download_logs")
}

model AuditLog {
  id         String      @id @default(cuid())
  userId     String?
  action     AuditAction
  entityType String      @db.VarChar(100)
  entityId   String      @db.VarChar(255)
  changes    Json?
  ipAddress  String?     @db.VarChar(45)
  userAgent  String?
  createdAt  DateTime    @default(now())
  user       User?       @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

enum UserRole {
  CONSUMER
  FARMER
  ADMIN
  SUPER_ADMIN
  MODERATOR
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum FarmStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum FarmVerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum TeamMemberRole {
  OWNER
  MANAGER
  STAFF
}

enum TeamMemberStatus {
  INVITED
  ACTIVE
  REMOVED
}

enum CertificationType {
  ORGANIC
  REGENERATIVE
  ANIMAL_WELFARE
  KOSHER
  HALAL
  FAIR_TRADE
  BIODYNAMIC
  OTHER
}

enum CertificationStatus {
  PENDING
  VERIFIED
  EXPIRED
  REJECTED
}

enum ProductCategory {
  VEGETABLES
  FRUITS
  DAIRY
  EGGS
  MEAT
  POULTRY
  SEAFOOD
  PANTRY
  BEVERAGES
  BAKED_GOODS
  PREPARED_FOODS
  FLOWERS
  OTHER
}

enum ProductStatus {
  DRAFT
  ACTIVE
  OUT_OF_STOCK
  ARCHIVED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  FULFILLED
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentMethod {
  STRIPE
  CARD
  PAYPAL
  CASH
  BANK_TRANSFER
}

enum FulfillmentMethod {
  DELIVERY
  FARM_PICKUP
  MARKET_PICKUP
}

enum FulfillmentStatus {
  PENDING
  SCHEDULED
  IN_TRANSIT
  READY_FOR_PICKUP
  DELIVERED
  FAILED
}

enum AddressType {
  HOME
  WORK
  OTHER
}

enum QualityIssueType {
  SPOILED
  MISSING_ITEMS
  WRONG_ITEMS
  POOR_QUALITY
  QUANTITY_MISMATCH
  DAMAGED
  OTHER
}

enum QualityIssueStatus {
  OPEN
  IN_REVIEW
  RESOLVED
  DISPUTED
}

enum ResolutionType {
  FULL_REFUND
  PARTIAL_REFUND
  REPLACEMENT
  CREDIT
  NO_ACTION
}

enum ReviewStatus {
  PENDING
  APPROVED
  FLAGGED
  REMOVED
}

enum NotificationType {
  ORDER_PLACED
  ORDER_CONFIRMED
  ORDER_READY
  ORDER_FULFILLED
  ORDER_CANCELLED
  PAYMENT_RECEIVED
  PAYOUT_PROCESSED
  NEW_MESSAGE
  REVIEW_RECEIVED
  QUALITY_ISSUE
  LOW_STOCK
  SYSTEM_ANNOUNCEMENT
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum AdminActionType {
  USER_APPROVED
  USER_SUSPENDED
  USER_DELETED
  USER_REACTIVATED
  USER_ACTIVATED
  USER_PROMOTED_ADMIN
  USER_DEMOTED_ADMIN
  USER_PASSWORD_RESET
  FARM_VERIFIED
  FARM_REJECTED
  FARM_SUSPENDED
  ORDER_REFUNDED
  PRODUCT_REMOVED
  SETTING_CHANGED
  ANNOUNCEMENT_CREATED
}

enum Season {
  SPRING
  SUMMER
  FALL
  WINTER
}

enum GrowthPhase {
  PREPARING
  SEEDING
  SPROUTING
  GROWING
  FLOWERING
  RIPENING
  HARVESTING
  RESTING
}

enum LunarPhase {
  NEW_MOON
  WAXING_CRESCENT
  FIRST_QUARTER
  WAXING_GIBBOUS
  FULL_MOON
  WANING_GIBBOUS
  LAST_QUARTER
  WANING_CRESCENT
}

enum SoilType {
  CLAY
  SANDY
  LOAM
  SILT
  PEATY
  CHALKY
  MIXED
}

enum DrainageLevel {
  EXCELLENT
  GOOD
  MODERATE
  POOR
  VERY_POOR
}

enum CompactionLevel {
  NONE
  LOW
  MODERATE
  HIGH
  SEVERE
}

enum WeatherCondition {
  CLEAR
  PARTLY_CLOUDY
  CLOUDY
  OVERCAST
  LIGHT_RAIN
  RAIN
  HEAVY_RAIN
  THUNDERSTORM
  SNOW
  SLEET
  FOG
  WINDY
}

enum CropFamily {
  BRASSICAS
  LEGUMES
  NIGHTSHADES
  CUCURBITS
  ALLIUMS
  GRASSES
  UMBELLIFERS
  LEAFY_GREENS
  ROOT_VEGETABLES
  OTHER
}

enum HarvestQuality {
  EXCELLENT
  GOOD
  FAIR
  POOR
  FAILED
}

enum HarvestStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  DELAYED
  CANCELLED
}

enum InventoryStatus {
  IN_STOCK
  LOW_STOCK
  OUT_OF_STOCK
  DISCONTINUED
}

enum StockMovementType {
  PURCHASE
  SALE
  ADJUSTMENT
  TRANSFER
  RETURN
  WASTE
}

enum AlertType {
  LOW_STOCK
  EXPIRING_SOON
  EXPIRED
  OVERSTOCK
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}

enum SupportTicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_FOR_RESPONSE
  RESOLVED
  CLOSED
}

enum SupportTicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SupportTicketCategory {
  ACCOUNT
  ORDERS
  PAYMENTS
  PRODUCTS
  TECHNICAL
  FARM_MANAGEMENT
  GENERAL
  BUG_REPORT
  FEATURE_REQUEST
  OTHER
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  PERMISSION_CHANGE
  STATUS_CHANGE
  APPROVE
  REJECT
  SUSPEND
  RESTORE
}
