generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider     = "postgresql"
  relationMode = "foreignKeys"
}

model User {
  id                      String                   @id @default(cuid())
  email                   String                   @unique @db.VarChar(255)
  password                String?                  @db.VarChar(255)
  firstName               String?                  @db.VarChar(100)
  lastName                String?                  @db.VarChar(100)
  name                    String?                  @db.VarChar(255)
  phone                   String?                  @db.VarChar(20)
  avatar                  String?                  @db.VarChar(500)
  role                    UserRole                 @default(CONSUMER)
  status                  UserStatus               @default(ACTIVE)
  approvedBy              String?
  approvedAt              DateTime?
  suspendedBy             String?
  suspendedAt             DateTime?
  suspensionReason        String?
  emailVerified           Boolean                  @default(false)
  emailVerifiedAt         DateTime?
  phoneVerified           Boolean                  @default(false)
  phoneVerifiedAt         DateTime?
  verificationToken       String?                  @unique @db.VarChar(255)
  verificationExpiry      DateTime?
  resetToken              String?                  @unique @db.VarChar(255)
  resetTokenExpiry        DateTime?
  dietaryPreferences      Json?
  notificationPreferences Json?
  privacySettings         Json?
  lastLoginAt             DateTime?
  lastLoginIP             String?                  @db.VarChar(45)
  loginCount              Int                      @default(0)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  accounts                Account[]
  Address                 Address[]
  adminActions            AdminAction[]            @relation("AdminActions")
  auditLogs               AuditLog[]
  cartItems               CartItem[]
  downloadLogs            DownloadLog[]
  teamMemberships         FarmTeamMember[]
  farms                   Farm[]
  favorites               Favorite[]
  messages                Message[]                @relation("MessageSender")
  notificationSettings    NotificationPreferences?
  notifications           Notification[]
  orders                  Order[]
  qualityIssues           QualityIssue[]
  reviews                 Review[]
  sessions                Session[]
  supportTickets          SupportTicket[]
  addresses               UserAddress[]

  // Run 4: Saved Searches, Analytics & Personalization
  savedSearches      SavedSearch[]
  savedSearchFolders SavedSearchFolder[]
  userPreference     UserPreference?

  @@index([email])
  @@index([role, status])
  @@index([createdAt])
  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  sessionToken String   @unique @db.VarChar(255)
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@map("sessions")
}

model Account {
  id                String    @id @default(cuid())
  userId            String
  provider          String    @db.VarChar(50)
  providerAccountId String    @db.VarChar(255)
  refreshToken      String?
  accessToken       String?
  expiresAt         DateTime?
  tokenType         String?   @db.VarChar(50)
  scope             String?   @db.VarChar(255)
  idToken           String?
  sessionState      String?   @db.VarChar(255)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model UserAddress {
  id        String      @id @default(cuid())
  userId    String
  type      AddressType @default(HOME)
  label     String?     @db.VarChar(100)
  street    String      @db.VarChar(255)
  street2   String?     @db.VarChar(255)
  city      String      @db.VarChar(100)
  state     String      @db.VarChar(50)
  zipCode   String      @db.VarChar(20)
  country   String      @default("US") @db.VarChar(2)
  latitude  Decimal?    @db.Decimal(10, 8)
  longitude Decimal?    @db.Decimal(11, 8)
  isDefault Boolean     @default(false)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  orders    Order[]     @relation("DeliveryAddress")
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([zipCode])
  @@map("user_addresses")
}

model AdminAction {
  id          String          @id @default(cuid())
  type        AdminActionType
  adminId     String
  targetId    String?
  targetType  String?         @db.VarChar(50)
  description String
  metadata    Json?
  ipAddress   String?         @db.VarChar(45)
  userAgent   String?         @db.VarChar(500)
  createdAt   DateTime        @default(now())
  admin       User            @relation("AdminActions", fields: [adminId], references: [id])

  @@index([adminId])
  @@index([type])
  @@index([createdAt])
  @@index([targetId, targetType])
  @@map("admin_actions")
}

model Farm {
  id                     String                 @id @default(cuid())
  name                   String                 @db.VarChar(255)
  slug                   String                 @unique @db.VarChar(255)
  description            String?
  story                  String?
  status                 FarmStatus             @default(PENDING)
  verificationStatus     FarmVerificationStatus @default(PENDING)
  verifiedBy             String?
  verifiedAt             DateTime?
  rejectionReason        String?
  ownerId                String
  email                  String                 @db.VarChar(255)
  phone                  String                 @db.VarChar(20)
  website                String?                @db.VarChar(500)
  address                String                 @db.VarChar(255)
  city                   String                 @db.VarChar(100)
  state                  String                 @db.VarChar(50)
  zipCode                String                 @db.VarChar(20)
  country                String                 @default("US") @db.VarChar(2)
  latitude               Decimal                @db.Decimal(10, 8)
  longitude              Decimal                @db.Decimal(11, 8)
  location               Json?
  images                 String[]
  logoUrl                String?                @db.VarChar(500)
  bannerUrl              String?                @db.VarChar(500)
  businessName           String?                @db.VarChar(255)
  taxId                  String?                @db.VarChar(50)
  businessType           String?                @db.VarChar(50)
  yearEstablished        Int?
  farmSize               Decimal?               @db.Decimal(10, 2)
  certificationsArray    String[]
  stripeAccountId        String?                @unique @db.VarChar(255)
  stripeOnboarded        Boolean                @default(false)
  stripeOnboardedAt      DateTime?
  payoutsEnabled         Boolean                @default(false)
  stripeDetailsSubmitted Boolean                @default(false)
  payoutSchedule         Json?
  productCategories      Json?
  farmingPractices       Json?
  deliveryRadius         Int?                   @default(25)
  profileViewsCount      Int                    @default(0)
  totalOrdersCount       Int                    @default(0)
  totalRevenueUSD        Decimal                @default(0) @db.Decimal(12, 2)
  averageRating          Decimal?               @db.Decimal(3, 2)
  reviewCount            Int                    @default(0)
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  biodynamicCalendar     BiodynamicCalendar[]
  cropRotations          CropRotation[]
  DeliverySlot           DeliverySlot[]
  DeliveryZone           DeliveryZone[]
  certifications         FarmCertification[]
  photos                 FarmPhoto[]
  FarmRating             FarmRating?
  teamMembers            FarmTeamMember[]
  owner                  User                   @relation(fields: [ownerId], references: [id])
  harvestSchedules       HarvestSchedule[]
  Inventory              Inventory[]
  marketLocations        MarketLocation[]
  messages               Message[]
  notifications          Notification[]
  orders                 Order[]
  payouts                Payout[]
  PickupLocation         PickupLocation[]
  products               Product[]
  qualityIssues          QualityIssue[]
  reviews                Review[]
  favorites              Favorite[]
  soilAnalyses           SoilAnalysis[]
  weatherData            WeatherData[]

  @@index([ownerId])
  @@index([slug])
  @@index([status])
  @@index([latitude, longitude])
  @@index([createdAt])
  @@index([status, verificationStatus])
  @@index([verificationStatus])
  @@index([stripeOnboarded])
  @@index([averageRating])
  @@index([totalRevenueUSD])
  @@map("farms")
}

model FarmTeamMember {
  id        String           @id @default(cuid())
  farmId    String
  email     String           @db.VarChar(255)
  userId    String?
  role      TeamMemberRole   @default(STAFF)
  status    TeamMemberStatus @default(INVITED)
  invitedAt DateTime         @default(now())
  invitedBy String
  joinedAt  DateTime?
  removedAt DateTime?
  removedBy String?
  farm      Farm             @relation(fields: [farmId], references: [id], onDelete: Cascade)
  user      User?            @relation(fields: [userId], references: [id])

  @@unique([farmId, email])
  @@index([farmId])
  @@index([userId])
  @@map("farm_team_members")
}

model FarmPhoto {
  id           String   @id @default(cuid())
  farmId       String
  photoUrl     String   @db.VarChar(500)
  thumbnailUrl String   @db.VarChar(500)
  caption      String?  @db.VarChar(255)
  altText      String?  @db.VarChar(255)
  sortOrder    Int      @default(0)
  isPrimary    Boolean  @default(false)
  width        Int?
  height       Int?
  fileSize     Int?
  createdAt    DateTime @default(now())
  farm         Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([isPrimary])
  @@map("farm_photos")
}

model FarmCertification {
  id                  String              @id @default(cuid())
  farmId              String
  type                CertificationType
  certifierName       String              @db.VarChar(255)
  certificationNumber String?             @db.VarChar(100)
  documentUrl         String?             @db.VarChar(500)
  issueDate           DateTime
  expirationDate      DateTime?
  status              CertificationStatus @default(PENDING)
  notes               String?
  verifiedBy          String?
  verifiedAt          DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  farm                Farm                @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([type])
  @@index([status])
  @@index([expirationDate])
  @@map("farm_certifications")
}

model MarketLocation {
  id          String   @id @default(cuid())
  farmId      String
  marketName  String   @db.VarChar(255)
  boothNumber String?  @db.VarChar(50)
  address     String   @db.VarChar(255)
  city        String   @db.VarChar(100)
  state       String   @db.VarChar(50)
  zipCode     String   @db.VarChar(20)
  latitude    Decimal  @db.Decimal(10, 8)
  longitude   Decimal  @db.Decimal(11, 8)
  schedule    Json
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  farm        Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@map("market_locations")
}

model BiodynamicCalendar {
  id                        String     @id @default(cuid())
  farmId                    String
  lunarPhase                LunarPhase
  lunarDay                  Int
  moonRiseTime              DateTime?
  moonSetTime               DateTime?
  season                    Season
  astronomicalDate          DateTime
  plantingFavorability      Int        @default(0)
  harvestFavorability       Int        @default(0)
  soilWorkFavorability      Int        @default(0)
  planetaryAlignment        Json?
  recommendedActivities     String[]
  avoidActivities           String[]
  agriculturalConsciousness Decimal    @default(0.0) @db.Decimal(3, 2)
  createdAt                 DateTime   @default(now())
  updatedAt                 DateTime   @updatedAt
  farm                      Farm       @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@unique([farmId, astronomicalDate])
  @@index([farmId])
  @@index([season])
  @@index([lunarPhase])
  @@map("biodynamic_calendar")
}

model SoilAnalysis {
  id                String          @id @default(cuid())
  farmId            String
  fieldName         String          @db.VarChar(255)
  latitude          Decimal         @db.Decimal(10, 8)
  longitude         Decimal         @db.Decimal(11, 8)
  pH                Decimal         @db.Decimal(4, 2)
  nitrogen          Decimal         @db.Decimal(5, 2)
  phosphorus        Decimal         @db.Decimal(5, 2)
  potassium         Decimal         @db.Decimal(5, 2)
  organicMatter     Decimal         @db.Decimal(5, 2)
  soilType          SoilType
  drainage          DrainageLevel
  compaction        CompactionLevel
  microbialActivity Decimal         @default(0.0) @db.Decimal(3, 2)
  earthwormCount    Int?
  fungalPresence    Decimal?        @db.Decimal(3, 2)
  previousCrops     Json?
  soilHistory       Json?
  amendments        String[]
  recommendedCrops  String[]
  analyzedBy        String?         @db.VarChar(255)
  analysisDate      DateTime        @default(now())
  nextAnalysisDate  DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  farm              Farm            @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([fieldName])
  @@index([analysisDate])
  @@map("soil_analyses")
}

model WeatherData {
  id                 String           @id @default(cuid())
  farmId             String
  recordedAt         DateTime         @default(now())
  latitude           Decimal          @db.Decimal(10, 8)
  longitude          Decimal          @db.Decimal(11, 8)
  temperature        Decimal          @db.Decimal(5, 2)
  feelsLike          Decimal?         @db.Decimal(5, 2)
  tempMin            Decimal?         @db.Decimal(5, 2)
  tempMax            Decimal?         @db.Decimal(5, 2)
  humidity           Int
  precipitation      Decimal?         @db.Decimal(6, 2)
  precipitationProb  Int?
  windSpeed          Decimal?         @db.Decimal(5, 2)
  windDirection      Int?
  condition          WeatherCondition
  cloudCover         Int?
  uvIndex            Int?
  visibility         Decimal?         @db.Decimal(5, 2)
  growingDegreeDay   Decimal?         @db.Decimal(5, 2)
  evapotranspiration Decimal?         @db.Decimal(5, 2)
  soilMoisture       Decimal?         @db.Decimal(3, 2)
  frostRisk          Boolean          @default(false)
  heatStressRisk     Boolean          @default(false)
  source             String           @default("API") @db.VarChar(50)
  createdAt          DateTime         @default(now())
  farm               Farm             @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([recordedAt])
  @@map("weather_data")
}

model CropRotation {
  id                  String     @id @default(cuid())
  farmId              String
  fieldName           String     @db.VarChar(255)
  rotationCycle       Int
  currentYear         Int
  currentCrop         String     @db.VarChar(100)
  currentCropFamily   CropFamily
  plantedAt           DateTime
  expectedHarvest     DateTime?
  cropHistory         Json
  plannedRotations    Json
  coverCropPlanned    Boolean    @default(false)
  coverCropType       String?    @db.VarChar(100)
  restPeriod          Boolean    @default(false)
  followsBiodynamic   Boolean    @default(false)
  biodynamicScore     Decimal    @default(0.0) @db.Decimal(3, 2)
  nextRecommendedCrop String?    @db.VarChar(100)
  soilBenefits        String[]
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  farm                Farm       @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@unique([farmId, fieldName])
  @@index([farmId])
  @@index([currentCropFamily])
  @@map("crop_rotations")
}

model HarvestSchedule {
  id                   String          @id @default(cuid())
  farmId               String
  productId            String?
  cropName             String          @db.VarChar(255)
  cropVariety          String?         @db.VarChar(255)
  fieldName            String          @db.VarChar(255)
  plantedAt            DateTime
  plantedQuantity      Decimal?        @db.Decimal(10, 2)
  plantedUnit          String?         @db.VarChar(50)
  expectedHarvestStart DateTime
  expectedHarvestEnd   DateTime?
  actualHarvestStart   DateTime?
  actualHarvestEnd     DateTime?
  harvestConfidence    Decimal         @default(0.5) @db.Decimal(3, 2)
  predictedYield       Decimal?        @db.Decimal(10, 2)
  predictedYieldUnit   String?         @db.VarChar(50)
  actualYield          Decimal?        @db.Decimal(10, 2)
  actualYieldUnit      String?         @db.VarChar(50)
  harvestQuality       HarvestQuality?
  optimalLunarPhase    LunarPhase?
  seasonalAlignment    Season
  biodynamicTiming     Boolean         @default(false)
  estimatedLaborHours  Decimal?        @db.Decimal(6, 2)
  actualLaborHours     Decimal?        @db.Decimal(6, 2)
  laborersNeeded       Int?
  status               HarvestStatus   @default(PLANNED)
  notes                String?
  challenges           String[]
  successes            String[]
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  farm                 Farm            @relation(fields: [farmId], references: [id], onDelete: Cascade)
  product              Product?        @relation(fields: [productId], references: [id])

  @@index([farmId])
  @@index([productId])
  @@index([status])
  @@index([expectedHarvestStart])
  @@index([seasonalAlignment])
  @@map("harvest_schedules")
}

model Product {
  id                   String            @id @default(cuid())
  farmId               String
  name                 String            @db.VarChar(255)
  slug                 String            @db.VarChar(255)
  description          String?           @db.VarChar(500)
  category             ProductCategory
  status               ProductStatus     @default(DRAFT)
  price                Decimal           @db.Decimal(10, 2)
  compareAtPrice       Decimal?          @db.Decimal(10, 2)
  unit                 String            @db.VarChar(50)
  trackInventory       Boolean           @default(true)
  quantityAvailable    Decimal?          @db.Decimal(10, 2)
  lowStockThreshold    Decimal?          @db.Decimal(10, 2)
  allowBackorder       Boolean           @default(false)
  inStock              Boolean           @default(true)
  organic              Boolean           @default(false)
  seasonal             Boolean           @default(false)
  seasonality          Season[]
  certifications       String[]
  featured             Boolean           @default(false)
  seasonalStart        DateTime?
  seasonalEnd          DateTime?
  harvestDate          DateTime?
  storageInstructions  String?
  primaryPhotoUrl      String?           @db.VarChar(500)
  photoUrls            Json?
  images               String[]
  hasVariants          Boolean           @default(false)
  variants             Json?
  tags                 Json?
  pricing              Json?
  inventory            Json?
  attributes           Json?
  scheduledPublishAt   DateTime?
  scheduledUnpublishAt DateTime?
  publishedAt          DateTime?
  viewsCount           Int               @default(0)
  cartAddsCount        Int               @default(0)
  purchaseCount        Int               @default(0)
  wishlistCount        Int               @default(0)
  averageRating        Decimal?          @db.Decimal(3, 2)
  reviewCount          Int               @default(0)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  cartItems            CartItem[]
  harvestSchedules     HarvestSchedule[]
  Inventory            Inventory[]
  inventoryLogs        InventoryLog[]
  orderItems           OrderItem[]
  farm                 Farm              @relation(fields: [farmId], references: [id], onDelete: Cascade)
  reviews              Review[]
  favorites            Favorite[]
  SeasonalCycle        SeasonalCycle[]

  @@unique([farmId, slug])
  @@index([farmId])
  @@index([category])
  @@index([status])
  @@index([organic])
  @@index([createdAt])
  @@index([farmId, inStock])
  @@index([status, category])
  @@index([farmId, status])
  @@index([featured, status])
  @@index([seasonal, status])
  @@index([price])
  @@index([averageRating])
  @@index([farmId, category, inStock])
  @@index([quantityAvailable])
  @@map("products")
}

model ProductTemplate {
  id           String          @id @default(cuid())
  farmId       String?
  name         String          @db.VarChar(255)
  category     ProductCategory
  templateData Json
  useCount     Int             @default(0)
  isPublic     Boolean         @default(false)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@index([farmId])
  @@index([category])
  @@map("product_templates")
}

model InventoryLog {
  id               String   @id @default(cuid())
  productId        String
  previousQuantity Decimal  @db.Decimal(10, 2)
  newQuantity      Decimal  @db.Decimal(10, 2)
  changeAmount     Decimal  @db.Decimal(10, 2)
  changeReason     String   @db.VarChar(100)
  notes            String?
  changedBy        String
  createdAt        DateTime @default(now())
  product          Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([createdAt])
  @@map("inventory_logs")
}

model CartItem {
  id                String            @id @default(cuid())
  userId            String
  productId         String
  farmId            String
  quantity          Decimal           @db.Decimal(10, 2)
  unit              String            @db.VarChar(50)
  priceAtAdd        Decimal           @db.Decimal(10, 2)
  fulfillmentMethod FulfillmentMethod @default(DELIVERY)
  reservedUntil     DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  product           Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
  @@index([farmId])
  @@index([reservedUntil])
  @@map("cart_items")
}

model Order {
  id                    String            @id @default(cuid())
  orderNumber           String            @unique @db.VarChar(50)
  customerId            String
  farmId                String
  status                OrderStatus       @default(PENDING)
  paymentStatus         PaymentStatus     @default(PENDING)
  subtotal              Decimal           @db.Decimal(10, 2)
  deliveryFee           Decimal           @default(0) @db.Decimal(10, 2)
  platformFee           Decimal           @db.Decimal(10, 2)
  tax                   Decimal           @default(0) @db.Decimal(10, 2)
  discount              Decimal           @default(0) @db.Decimal(10, 2)
  total                 Decimal           @db.Decimal(10, 2)
  farmerAmount          Decimal           @db.Decimal(10, 2)
  fulfillmentMethod     FulfillmentMethod
  deliveryAddressId     String?
  scheduledDate         DateTime?
  scheduledTimeSlot     String?           @db.VarChar(50)
  fulfillmentNotes      String?
  stripePaymentIntentId String?           @unique @db.VarChar(255)
  stripeChargeId        String?           @db.VarChar(255)
  stripeTransferId      String?           @db.VarChar(255)
  paymentIntentId       String?           @db.VarChar(255)
  paidAt                DateTime?
  trackingNumber        String?           @db.VarChar(255)
  shippingService       String?           @db.VarChar(100)
  shippingAddress       Json?
  deliverySlotId        String?
  specialInstructions   String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  confirmedAt           DateTime?
  fulfilledAt           DateTime?
  completedAt           DateTime?
  cancelledAt           DateTime?
  cancelledBy           String?
  cancelReason          String?
  fulfillment           Fulfillment?
  messages              Message[]
  items                 OrderItem[]
  customer              User              @relation(fields: [customerId], references: [id])
  deliveryAddress       UserAddress?      @relation("DeliveryAddress", fields: [deliveryAddressId], references: [id])
  farm                  Farm              @relation(fields: [farmId], references: [id])
  Payment               Payment?
  qualityIssues         QualityIssue[]
  refunds               Refund[]
  reviews               Review[]

  @@index([customerId])
  @@index([farmId])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@index([orderNumber])
  @@index([farmId, createdAt])
  @@index([customerId, createdAt])
  @@index([status, createdAt])
  @@index([status, farmId])
  @@index([status, customerId])
  @@index([paymentStatus, status])
  @@index([scheduledDate])
  @@map("orders")
}

model OrderItem {
  id              String  @id @default(cuid())
  orderId         String
  productId       String
  productName     String  @db.VarChar(255)
  quantity        Decimal @db.Decimal(10, 2)
  unit            String  @db.VarChar(50)
  unitPrice       Decimal @db.Decimal(10, 2)
  subtotal        Decimal @db.Decimal(10, 2)
  productSnapshot Json?
  order           Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product         Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model Fulfillment {
  id                String            @id @default(cuid())
  orderId           String            @unique
  status            FulfillmentStatus @default(PENDING)
  trackingNumber    String?           @db.VarChar(100)
  carrierName       String?           @db.VarChar(100)
  estimatedDate     DateTime?
  actualDate        DateTime?
  proofPhotoUrl     String?           @db.VarChar(500)
  signature         String?
  recipientName     String?           @db.VarChar(255)
  deliveryNotes     String?
  gpsLatitude       Decimal?          @db.Decimal(10, 8)
  gpsLongitude      Decimal?          @db.Decimal(11, 8)
  deliveryTimestamp DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  order             Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@map("fulfillments")
}

model Payment {
  id                    String        @id @default(cuid())
  orderId               String        @unique
  amount                Decimal       @db.Decimal(10, 2)
  currency              String        @default("usd") @db.VarChar(3)
  status                PaymentStatus @default(PENDING)
  paymentMethod         String        @db.VarChar(50)
  stripePaymentIntentId String?       @unique @db.VarChar(255)
  paypalOrderId         String?       @unique @db.VarChar(255)
  paidAt                DateTime?
  failureReason         String?
  receiptUrl            String?       @db.VarChar(500)
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  order                 Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@index([stripePaymentIntentId])
  @@index([paypalOrderId])
  @@map("payments")
}

model Payout {
  id             String    @id @default(cuid())
  farmId         String
  amount         Decimal   @db.Decimal(10, 2)
  currency       String    @default("USD") @db.VarChar(3)
  status         String    @db.VarChar(50)
  stripePayoutId String?   @unique @db.VarChar(255)
  periodStart    DateTime
  periodEnd      DateTime
  orderCount     Int
  scheduledDate  DateTime
  paidDate       DateTime?
  failureReason  String?
  createdAt      DateTime  @default(now())
  farm           Farm      @relation(fields: [farmId], references: [id])

  @@index([farmId])
  @@index([status])
  @@index([scheduledDate])
  @@map("payouts")
}

model Refund {
  id             String    @id @default(cuid())
  orderId        String
  amount         Decimal   @db.Decimal(10, 2)
  reason         String    @db.VarChar(255)
  notes          String?
  stripeRefundId String?   @unique @db.VarChar(255)
  status         String    @db.VarChar(50)
  processedAt    DateTime?
  createdAt      DateTime  @default(now())
  order          Order     @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@map("refunds")
}

model QualityIssue {
  id                   String             @id @default(cuid())
  orderId              String
  customerId           String
  farmId               String
  type                 QualityIssueType
  description          String             @db.VarChar(500)
  photoUrl             String?            @db.VarChar(500)
  status               QualityIssueStatus @default(OPEN)
  resolutionPreference ResolutionType
  resolution           ResolutionType?
  resolutionNotes      String?
  refundAmount         Decimal?           @db.Decimal(10, 2)
  createdAt            DateTime           @default(now())
  resolvedAt           DateTime?
  resolvedBy           String?
  customer             User               @relation(fields: [customerId], references: [id])
  farm                 Farm               @relation(fields: [farmId], references: [id])
  order                Order              @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([customerId])
  @@index([farmId])
  @@index([status])
  @@map("quality_issues")
}

model Review {
  id                 String       @id @default(cuid())
  farmId             String
  productId          String?
  customerId         String
  orderId            String?
  rating             Int
  reviewText         String?      @db.VarChar(500)
  photoUrl           String?      @db.VarChar(500)
  isVerifiedPurchase Boolean      @default(false)
  status             ReviewStatus @default(PENDING)
  helpfulCount       Int          @default(0)
  unhelpfulCount     Int          @default(0)
  farmerResponse     String?      @db.VarChar(500)
  farmerRespondedAt  DateTime?
  flaggedReason      String?      @db.VarChar(255)
  flaggedAt          DateTime?
  moderatedBy        String?
  moderatedAt        DateTime?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  customer           User         @relation(fields: [customerId], references: [id])
  farm               Farm         @relation(fields: [farmId], references: [id])
  order              Order?       @relation(fields: [orderId], references: [id])
  product            Product?     @relation(fields: [productId], references: [id])

  @@index([farmId])
  @@index([productId])
  @@index([customerId])
  @@index([orderId])
  @@index([status])
  @@index([createdAt])
  @@index([productId, createdAt])
  @@index([rating])
  @@index([farmId, rating])
  @@map("reviews")
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  farmId    String?
  productId String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  farm      Farm?    @relation(fields: [farmId], references: [id], onDelete: Cascade)
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, farmId])
  @@unique([userId, productId])
  @@index([userId])
  @@index([farmId])
  @@index([productId])
  @@map("favorites")
}

model FarmRating {
  id             String   @id @default(cuid())
  farmId         String   @unique
  averageRating  Float    @default(0)
  totalReviews   Int      @default(0)
  productQuality Float    @default(0)
  communication  Float    @default(0)
  delivery       Float    @default(0)
  packaging      Float    @default(0)
  fiveStarCount  Int      @default(0)
  fourStarCount  Int      @default(0)
  threeStarCount Int      @default(0)
  twoStarCount   Int      @default(0)
  oneStarCount   Int      @default(0)
  updatedAt      DateTime @updatedAt
  farm           Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([averageRating])
  @@map("farm_ratings")
}

model Message {
  id          String    @id @default(cuid())
  senderId    String
  recipientId String?
  farmId      String?
  orderId     String?
  subject     String?   @db.VarChar(255)
  body        String
  isRead      Boolean   @default(false)
  readAt      DateTime?
  createdAt   DateTime  @default(now())
  farm        Farm?     @relation(fields: [farmId], references: [id])
  order       Order?    @relation(fields: [orderId], references: [id])
  sender      User      @relation("MessageSender", fields: [senderId], references: [id])

  @@index([senderId])
  @@index([recipientId])
  @@index([farmId])
  @@index([orderId])
  @@index([isRead])
  @@map("messages")
}

model Notification {
  id        String              @id @default(cuid())
  userId    String?
  farmId    String?
  type      NotificationType
  channel   NotificationChannel
  title     String              @db.VarChar(255)
  body      String
  data      Json?
  isRead    Boolean             @default(false)
  readAt    DateTime?
  sentAt    DateTime?
  createdAt DateTime            @default(now())
  farm      Farm?               @relation(fields: [farmId], references: [id])
  user      User?               @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([farmId])
  @@index([type])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model AnalyticsEvent {
  id         String   @id @default(cuid())
  eventType  String   @db.VarChar(100)
  userId     String?
  farmId     String?
  productId  String?
  orderId    String?
  sessionId  String?  @db.VarChar(255)
  properties Json?
  userAgent  String?
  ipAddress  String?  @db.VarChar(45)
  referrer   String?  @db.VarChar(500)
  createdAt  DateTime @default(now())

  @@index([eventType])
  @@index([userId])
  @@index([farmId])
  @@index([productId])
  @@index([createdAt])
  @@map("analytics_events")
}

model DeliveryZone {
  id              String   @id @default(cuid())
  farmId          String
  name            String   @db.VarChar(255)
  description     String?
  zipCodes        String[]
  cities          String[]
  baseFee         Decimal  @db.Decimal(10, 2)
  perMileFee      Decimal  @default(0) @db.Decimal(10, 2)
  minimumOrder    Decimal  @default(0) @db.Decimal(10, 2)
  freeDeliveryMin Decimal  @default(0) @db.Decimal(10, 2)
  availableDays   String[]
  cutoffHours     Int      @default(24)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  farm            Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([isActive])
  @@map("delivery_zones")
}

model DeliverySlot {
  id            String   @id @default(cuid())
  farmId        String
  date          DateTime @db.Date
  startTime     String   @db.VarChar(10)
  endTime       String   @db.VarChar(10)
  maxOrders     Int      @default(10)
  currentOrders Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  farm          Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([date])
  @@index([isActive])
  @@map("delivery_slots")
}

model PickupLocation {
  id             String   @id @default(cuid())
  farmId         String
  name           String   @db.VarChar(255)
  address        String   @db.VarChar(500)
  city           String   @db.VarChar(100)
  state          String   @db.VarChar(50)
  zipCode        String   @db.VarChar(20)
  instructions   String?
  latitude       Decimal? @db.Decimal(10, 8)
  longitude      Decimal? @db.Decimal(11, 8)
  availableDays  String[]
  availableHours String?  @db.VarChar(255)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  farm           Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([isActive])
  @@map("pickup_locations")
}

model Address {
  id        String      @id @default(cuid())
  userId    String?
  fullName  String      @db.VarChar(255)
  street    String      @db.VarChar(500)
  city      String      @db.VarChar(100)
  state     String      @db.VarChar(50)
  zipCode   String      @db.VarChar(20)
  country   String      @default("USA") @db.VarChar(50)
  phone     String?     @db.VarChar(20)
  latitude  Decimal?    @db.Decimal(10, 8)
  longitude Decimal?    @db.Decimal(11, 8)
  type      AddressType @default(HOME)
  isDefault Boolean     @default(false)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  user      User?       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("addresses")
}

model SeasonalCycle {
  id             String      @id @default(cuid())
  productId      String
  season         Season
  phase          GrowthPhase
  startDate      DateTime
  endDate        DateTime?
  lunarPhase     String?     @db.VarChar(50)
  soilConditions Json?
  energyLevel    Int?
  notes          String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  product        Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([season])
  @@index([phase])
  @@index([startDate, endDate])
  @@map("seasonal_cycles")
}

model Inventory {
  id           String           @id @default(cuid())
  farmId       String
  productId    String
  sku          String           @unique @db.VarChar(100)
  quantity     Int              @default(0)
  reservedQty  Int              @default(0)
  availableQty Int              @default(0)
  reorderPoint Int              @default(10)
  reorderQty   Int              @default(50)
  costPrice    Decimal          @db.Decimal(10, 2)
  sellingPrice Decimal          @db.Decimal(10, 2)
  pricePerUnit Decimal          @db.Decimal(10, 2)
  location     String?          @db.VarChar(100)
  zone         String?          @db.VarChar(50)
  status       InventoryStatus  @default(IN_STOCK)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  farm         Farm             @relation(fields: [farmId], references: [id], onDelete: Cascade)
  product      Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  alerts       InventoryAlert[]
  batches      ProductBatch[]
  movements    StockMovement[]

  @@index([farmId])
  @@index([productId])
  @@index([status])
  @@index([quantity])
  @@map("inventory")
}

model ProductBatch {
  id              String    @id @default(cuid())
  inventoryId     String
  batchNumber     String    @unique @db.VarChar(100)
  quantity        Int
  receivedQty     Int
  damagedQty      Int       @default(0)
  receivedDate    DateTime  @default(now())
  expiryDate      DateTime?
  manufactureDate DateTime?
  supplier        String?   @db.VarChar(255)
  cost            Decimal?  @db.Decimal(10, 2)
  qualityGrade    String?   @db.VarChar(20)
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  inventory       Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  @@index([inventoryId])
  @@index([expiryDate])
  @@map("product_batches")
}

model StockMovement {
  id          String            @id @default(cuid())
  inventoryId String
  type        StockMovementType
  quantity    Int
  reference   String?           @db.VarChar(255)
  previousQty Int
  newQty      Int
  reason      String?
  performedBy String            @db.VarChar(255)
  createdAt   DateTime          @default(now())
  inventory   Inventory         @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  @@index([inventoryId])
  @@index([type])
  @@index([createdAt])
  @@map("stock_movements")
}

model InventoryAlert {
  id          String        @id @default(cuid())
  inventoryId String
  type        AlertType
  severity    AlertSeverity
  message     String
  isRead      Boolean       @default(false)
  isResolved  Boolean       @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?       @db.VarChar(255)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  inventory   Inventory     @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  @@index([inventoryId])
  @@index([type])
  @@index([severity])
  @@index([isResolved])
  @@map("inventory_alerts")
}

model SupportTicket {
  id             String                 @id @default(cuid())
  userId         String
  subject        String                 @db.VarChar(255)
  description    String
  category       SupportTicketCategory  @default(GENERAL)
  priority       SupportTicketPriority  @default(MEDIUM)
  status         SupportTicketStatus    @default(OPEN)
  assignedTo     String?
  assignedAt     DateTime?
  tags           String[]               @default([])
  relatedOrderId String?
  relatedFarmId  String?
  resolvedAt     DateTime?
  resolvedBy     String?
  resolutionNote String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  files          SupportTicketFile[]
  messages       SupportTicketMessage[]
  user           User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([assignedTo])
  @@index([createdAt])
  @@map("support_tickets")
}

model SupportTicketMessage {
  id         String        @id @default(cuid())
  ticketId   String
  content    String
  isStaff    Boolean       @default(false)
  authorId   String
  isInternal Boolean       @default(false)
  isRead     Boolean       @default(false)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  ticket     SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([authorId])
  @@index([createdAt])
  @@map("support_ticket_messages")
}

model SupportTicketFile {
  id          String        @id @default(cuid())
  ticketId    String
  filename    String        @db.VarChar(255)
  url         String        @db.VarChar(500)
  mimeType    String        @db.VarChar(100)
  size        Int
  description String?
  uploadedBy  String
  createdAt   DateTime      @default(now())
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([uploadedBy])
  @@map("support_ticket_files")
}

model NotificationPreferences {
  id              String   @id @default(cuid())
  userId          String   @unique
  emailOrders     Boolean  @default(true)
  emailReviews    Boolean  @default(true)
  emailPromotions Boolean  @default(false)
  emailNewsletter Boolean  @default(false)
  inAppOrders     Boolean  @default(true)
  inAppReviews    Boolean  @default(true)
  inAppMessages   Boolean  @default(true)
  pushOrders      Boolean  @default(true)
  pushReviews     Boolean  @default(true)
  pushPromotions  Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notification_preferences")
}

model DownloadLog {
  id         String   @id @default(cuid())
  userId     String?
  resourceId String   @db.VarChar(255)
  ipAddress  String?  @db.VarChar(45)
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([resourceId])
  @@index([createdAt])
  @@map("download_logs")
}

model AuditLog {
  id         String      @id @default(cuid())
  userId     String?
  action     AuditAction
  entityType String      @db.VarChar(100)
  entityId   String      @db.VarChar(255)
  changes    Json?
  ipAddress  String?     @db.VarChar(45)
  userAgent  String?
  createdAt  DateTime    @default(now())
  user       User?       @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

enum UserRole {
  CONSUMER
  FARMER
  ADMIN
  SUPER_ADMIN
  MODERATOR
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum FarmStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum FarmVerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum TeamMemberRole {
  OWNER
  MANAGER
  STAFF
}

enum TeamMemberStatus {
  INVITED
  ACTIVE
  REMOVED
}

enum CertificationType {
  ORGANIC
  REGENERATIVE
  ANIMAL_WELFARE
  KOSHER
  HALAL
  FAIR_TRADE
  BIODYNAMIC
  OTHER
}

enum CertificationStatus {
  PENDING
  VERIFIED
  EXPIRED
  REJECTED
}

enum ProductCategory {
  VEGETABLES
  FRUITS
  DAIRY
  EGGS
  MEAT
  POULTRY
  SEAFOOD
  PANTRY
  BEVERAGES
  BAKED_GOODS
  PREPARED_FOODS
  FLOWERS
  OTHER
}

enum ProductStatus {
  DRAFT
  ACTIVE
  OUT_OF_STOCK
  ARCHIVED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  FULFILLED
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentMethod {
  STRIPE
  CARD
  PAYPAL
  CASH
  BANK_TRANSFER
}

enum FulfillmentMethod {
  DELIVERY
  FARM_PICKUP
  MARKET_PICKUP
}

enum FulfillmentStatus {
  PENDING
  SCHEDULED
  IN_TRANSIT
  READY_FOR_PICKUP
  DELIVERED
  FAILED
}

enum AddressType {
  HOME
  WORK
  OTHER
}

enum QualityIssueType {
  SPOILED
  MISSING_ITEMS
  WRONG_ITEMS
  POOR_QUALITY
  QUANTITY_MISMATCH
  DAMAGED
  OTHER
}

enum QualityIssueStatus {
  OPEN
  IN_REVIEW
  RESOLVED
  DISPUTED
}

enum ResolutionType {
  FULL_REFUND
  PARTIAL_REFUND
  REPLACEMENT
  CREDIT
  NO_ACTION
}

enum ReviewStatus {
  PENDING
  APPROVED
  FLAGGED
  REMOVED
}

enum NotificationType {
  ORDER_PLACED
  ORDER_CONFIRMED
  ORDER_READY
  ORDER_FULFILLED
  ORDER_CANCELLED
  PAYMENT_RECEIVED
  PAYOUT_PROCESSED
  NEW_MESSAGE
  REVIEW_RECEIVED
  QUALITY_ISSUE
  LOW_STOCK
  SYSTEM_ANNOUNCEMENT
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum AdminActionType {
  USER_APPROVED
  USER_SUSPENDED
  USER_DELETED
  USER_REACTIVATED
  USER_ACTIVATED
  USER_PROMOTED_ADMIN
  USER_DEMOTED_ADMIN
  USER_PASSWORD_RESET
  FARM_VERIFIED
  FARM_REJECTED
  FARM_SUSPENDED
  ORDER_REFUNDED
  PRODUCT_REMOVED
  SETTING_CHANGED
  ANNOUNCEMENT_CREATED
}

enum Season {
  SPRING
  SUMMER
  FALL
  WINTER
}

enum GrowthPhase {
  PREPARING
  SEEDING
  SPROUTING
  GROWING
  FLOWERING
  RIPENING
  HARVESTING
  RESTING
}

enum LunarPhase {
  NEW_MOON
  WAXING_CRESCENT
  FIRST_QUARTER
  WAXING_GIBBOUS
  FULL_MOON
  WANING_GIBBOUS
  LAST_QUARTER
  WANING_CRESCENT
}

enum SoilType {
  CLAY
  SANDY
  LOAM
  SILT
  PEATY
  CHALKY
  MIXED
}

enum DrainageLevel {
  EXCELLENT
  GOOD
  MODERATE
  POOR
  VERY_POOR
}

enum CompactionLevel {
  NONE
  LOW
  MODERATE
  HIGH
  SEVERE
}

enum WeatherCondition {
  CLEAR
  PARTLY_CLOUDY
  CLOUDY
  OVERCAST
  LIGHT_RAIN
  RAIN
  HEAVY_RAIN
  THUNDERSTORM
  SNOW
  SLEET
  FOG
  WINDY
}

enum CropFamily {
  BRASSICAS
  LEGUMES
  NIGHTSHADES
  CUCURBITS
  ALLIUMS
  GRASSES
  UMBELLIFERS
  LEAFY_GREENS
  ROOT_VEGETABLES
  OTHER
}

enum HarvestQuality {
  EXCELLENT
  GOOD
  FAIR
  POOR
  FAILED
}

enum HarvestStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  DELAYED
  CANCELLED
}

enum InventoryStatus {
  IN_STOCK
  LOW_STOCK
  OUT_OF_STOCK
  DISCONTINUED
}

enum StockMovementType {
  PURCHASE
  SALE
  ADJUSTMENT
  TRANSFER
  RETURN
  WASTE
}

enum AlertType {
  LOW_STOCK
  EXPIRING_SOON
  EXPIRED
  OVERSTOCK
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}

enum SupportTicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_FOR_RESPONSE
  RESOLVED
  CLOSED
}

enum SupportTicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SupportTicketCategory {
  ACCOUNT
  ORDERS
  PAYMENTS
  PRODUCTS
  TECHNICAL
  FARM_MANAGEMENT
  GENERAL
  BUG_REPORT
  FEATURE_REQUEST
  OTHER
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  PERMISSION_CHANGE
  STATUS_CHANGE
  APPROVE
  REJECT
  SUSPEND
  RESTORE
}

// ============================================================================
// WORKFLOW MONITORING & METRICS
// ============================================================================

/// Monitoring report for workflow executions
model MonitoringReport {
  id              String    @id @default(cuid())
  reportId        String    @unique @map("report_id") @db.VarChar(255)
  startTime       DateTime  @map("start_time")
  endTime         DateTime  @map("end_time")
  totalRuns       Int       @default(0) @map("total_runs")
  successfulRuns  Int       @default(0) @map("successful_runs")
  failedRuns      Int       @default(0) @map("failed_runs")
  totalDurationMs Int       @default(0) @map("total_duration_ms")
  avgDurationMs   Float     @default(0) @map("avg_duration_ms")
  successRate     Float     @default(0) @map("success_rate")
  status          String    @default("COMPLETED")
  reportType      String    @default("PERIODIC") @map("report_type")
  generatedAt     DateTime  @default(now()) @map("generated_at")
  notified        Boolean   @default(false)
  notifiedAt      DateTime? @map("notified_at")
  metadata        Json?

  // Relations
  workflowExecutions WorkflowExecution[]
  notificationLogs   NotificationLog[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([reportId])
  @@index([status])
  @@index([generatedAt])
  @@index([startTime])
  @@map("monitoring_reports")
}

/// Individual workflow execution record
model WorkflowExecution {
  id           String    @id @default(cuid())
  runId        String    @unique @map("run_id") @db.VarChar(255)
  workflowName String    @map("workflow_name")
  status       String
  startedAt    DateTime  @map("started_at")
  completedAt  DateTime? @map("completed_at")
  durationMs   Int?      @map("duration_ms")
  testsPassed  Int       @default(0) @map("tests_passed")
  testsFailed  Int       @default(0) @map("tests_failed")
  testsTotal   Int       @default(0) @map("tests_total")
  errorMessage String?   @map("error_message") @db.Text
  errorStack   String?   @map("error_stack") @db.Text
  triggeredBy  String    @default("SCHEDULED") @map("triggered_by")
  environment  String    @default("production")
  metadata     Json?

  // Relations
  reportId           String?             @map("report_id")
  report             MonitoringReport?   @relation(fields: [reportId], references: [reportId], onDelete: SetNull)
  workflowMetrics    WorkflowMetrics[]
  systemHealthChecks SystemHealthCheck[]
  notificationLogs   NotificationLog[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([runId])
  @@index([workflowName])
  @@index([status])
  @@index([startedAt])
  @@index([reportId])
  @@map("workflow_executions")
}

/// Workflow metrics and performance data
model WorkflowMetrics {
  id                String   @id @default(cuid())
  workflowId        String   @map("workflow_id") @db.VarChar(255)
  metricName        String   @map("metric_name")
  metricValue       Float    @map("metric_value")
  metricUnit        String?  @map("metric_unit")
  thresholdValue    Float?   @map("threshold_value")
  isWithinThreshold Boolean  @default(true) @map("is_within_threshold")
  recordedAt        DateTime @default(now()) @map("recorded_at")
  tags              Json?
  metadata          Json?

  // Relations
  executionId String?            @map("execution_id")
  execution   WorkflowExecution? @relation(fields: [executionId], references: [runId], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([workflowId])
  @@index([metricName])
  @@index([recordedAt])
  @@index([executionId])
  @@index([isWithinThreshold])
  @@map("workflow_metrics")
}

/// System health checks
model SystemHealthCheck {
  id             String   @id @default(cuid())
  checkId        String   @unique @map("check_id")
  checkName      String   @map("check_name")
  status         String
  responseTimeMs Int      @map("response_time_ms")
  details        Json?
  checkedAt      DateTime @default(now()) @map("checked_at")
  endpoint       String?
  expectedStatus Int?     @map("expected_status")
  actualStatus   Int?     @map("actual_status")
  errorMessage   String?  @map("error_message") @db.Text
  metadata       Json?

  // Relations
  executionId String?            @map("execution_id")
  execution   WorkflowExecution? @relation(fields: [executionId], references: [runId], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([checkId])
  @@index([checkName])
  @@index([status])
  @@index([checkedAt])
  @@index([executionId])
  @@map("system_health_checks")
}

/// Notification log
model NotificationLog {
  id               String   @id @default(cuid())
  logId            String   @unique @map("log_id") @db.VarChar(255)
  channel          String
  notificationType String   @map("notification_type")
  status           String
  recipient        String?
  subject          String?
  message          String   @db.Text
  sentAt           DateTime @default(now()) @map("sent_at")
  deliveryStatus   String?  @map("delivery_status")
  errorMessage     String?  @map("error_message") @db.Text
  retryCount       Int      @default(0) @map("retry_count")
  metadata         Json?

  // Relations
  executionId String?            @map("execution_id")
  execution   WorkflowExecution? @relation(fields: [executionId], references: [runId], onDelete: SetNull)

  reportId String?           @map("report_id")
  report   MonitoringReport? @relation(fields: [reportId], references: [reportId], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([logId])
  @@index([channel])
  @@index([status])
  @@index([sentAt])
  @@index([executionId])
  @@index([reportId])
  @@map("notification_logs")
}

/// Workflow scheduler configuration
model WorkflowSchedule {
  id             String    @id @default(cuid())
  scheduleId     String    @unique @map("schedule_id") @db.VarChar(255)
  workflowName   String    @map("workflow_name")
  cronExpression String    @map("cron_expression")
  enabled        Boolean   @default(true)
  lastRunAt      DateTime? @map("last_run_at")
  nextRunAt      DateTime? @map("next_run_at")
  runCount       Int       @default(0) @map("run_count")
  failureCount   Int       @default(0) @map("failure_count")
  successCount   Int       @default(0) @map("success_count")
  description    String?
  tags           Json?
  metadata       Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([scheduleId])
  @@index([workflowName])
  @@index([enabled])
  @@index([nextRunAt])
  @@map("workflow_schedules")
}

// ============================================
// RUN 4: SAVED SEARCHES, ANALYTICS & PERSONALIZATION
// ============================================

model SavedSearch {
  id          String  @id @default(cuid())
  userId      String
  name        String  @db.VarChar(255)
  description String?

  // Search Parameters (JSONB)
  query    String? @db.VarChar(500)
  filters  Json    @default("{}")
  sortBy   String? @db.VarChar(50)
  location Json?

  // Metadata
  isPublic   Boolean  @default(false)
  shareToken String?  @unique @db.VarChar(100)
  folderId   String?
  tags       String[]

  // Notifications
  notificationsEnabled  Boolean               @default(true)
  notificationFrequency NotificationFrequency @default(DAILY)
  lastNotificationSent  DateTime?

  // Stats
  executionCount Int       @default(0)
  lastExecutedAt DateTime?
  resultsCount   Int?

  // Agricultural Consciousness
  seasonalPreference Season?
  preferredFarms     String[]
  biodynamicOnly     Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  folder     SavedSearchFolder? @relation(fields: [folderId], references: [id])
  alerts     SearchAlert[]
  sharedWith SavedSearchShare[]

  @@index([userId])
  @@index([shareToken])
  @@index([createdAt])
  @@index([lastExecutedAt])
  @@map("saved_searches")
}

model SavedSearchFolder {
  id          String  @id @default(cuid())
  userId      String
  name        String  @db.VarChar(100)
  description String?
  icon        String? @db.VarChar(50)
  sortOrder   Int     @default(0)
  color       String? @db.VarChar(20)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  searches SavedSearch[]

  @@index([userId])
  @@map("saved_search_folders")
}

model SavedSearchShare {
  id              String          @id @default(cuid())
  savedSearchId   String
  sharedWithEmail String          @db.VarChar(255)
  sharedWithId    String?
  permission      SharePermission @default(VIEW)
  expiresAt       DateTime?

  createdAt DateTime @default(now())

  savedSearch SavedSearch @relation(fields: [savedSearchId], references: [id], onDelete: Cascade)

  @@unique([savedSearchId, sharedWithEmail])
  @@index([savedSearchId])
  @@map("saved_search_shares")
}

model SearchAlert {
  id            String @id @default(cuid())
  savedSearchId String
  userId        String

  // Alert Type
  type SearchAlertType @default(NEW_PRODUCTS)

  // Conditions (JSONB)
  conditions Json

  // Status
  isActive      Boolean   @default(true)
  lastTriggered DateTime?
  triggerCount  Int       @default(0)

  // Delivery
  channels Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  savedSearch SavedSearch @relation(fields: [savedSearchId], references: [id], onDelete: Cascade)

  @@index([savedSearchId])
  @@index([userId])
  @@index([isActive])
  @@map("search_alerts")
}

model SearchEvent {
  id        String  @id @default(cuid())
  userId    String?
  sessionId String  @db.VarChar(100)

  // Search Details
  query   String? @db.VarChar(500)
  filters Json
  sortBy  String? @db.VarChar(50)

  // Results
  resultsCount   Int
  resultsShown   Int
  clickedResults String[]

  // Context
  source    String? @db.VarChar(50)
  location  Json?
  userAgent String? @db.VarChar(500)

  // Timing
  responseTime Int
  timestamp    DateTime @default(now())

  // Agricultural Context
  currentSeason Season?
  lunarPhase    String? @db.VarChar(50)

  // A/B Testing
  abTestVariant String? @db.VarChar(50)

  @@index([userId])
  @@index([sessionId])
  @@index([timestamp])
  @@index([query])
  @@map("search_events")
}

model UserInteraction {
  id        String  @id @default(cuid())
  userId    String?
  sessionId String  @db.VarChar(100)

  // Interaction Type
  type       InteractionType
  entityType String          @db.VarChar(50)
  entityId   String

  // Context
  source   String? @db.VarChar(50)
  metadata Json?

  // Value
  value Decimal? @db.Decimal(10, 2)

  timestamp DateTime @default(now())

  @@index([userId])
  @@index([sessionId])
  @@index([entityType, entityId])
  @@index([type])
  @@index([timestamp])
  @@map("user_interactions")
}

model SearchAnalytics {
  id String @id @default(cuid())

  // Time Window
  periodType  PeriodType
  periodStart DateTime
  periodEnd   DateTime

  // Aggregated Metrics
  totalSearches Int @default(0)
  uniqueUsers   Int @default(0)
  uniqueQueries Int @default(0)

  // Performance
  avgResponseTime Int
  p95ResponseTime Int

  // Engagement
  avgResultsCount Decimal @db.Decimal(10, 2)
  avgClickThrough Decimal @db.Decimal(5, 4)
  conversionRate  Decimal @db.Decimal(5, 4)

  // Top Queries (JSONB)
  topQueries    Json
  topFilters    Json
  topCategories Json

  // Agricultural Insights
  seasonalTrends Json
  farmPopularity Json

  createdAt DateTime @default(now())

  @@unique([periodType, periodStart])
  @@index([periodType, periodStart])
  @@map("search_analytics")
}

model UserPreference {
  id     String @id @default(cuid())
  userId String @unique

  // Dietary Preferences
  dietaryRestrictions String[]
  allergens           String[]
  certifications      String[]

  // Preference Flags
  preferOrganic Boolean @default(false)
  preferLocal   Boolean @default(false)

  // Price Preferences
  priceRangeMin Decimal? @db.Decimal(10, 2)
  priceRangeMax Decimal? @db.Decimal(10, 2)

  // Shopping Preferences
  favoriteFarms      String[]
  favoriteCategories String[]
  budgetRange        Json?

  // Default Location
  defaultLocation Json?

  // Location Preferences
  preferredLocations Json[]
  maxDistance        Int?

  // Delivery Preferences
  preferredPickupDays   String[]
  preferredDeliveryTime String?

  // Seasonal Preferences (JSONB by Season)
  springPreferences Json?
  summerPreferences Json?
  fallPreferences   Json?
  winterPreferences Json?

  // Biodynamic Preferences
  lunarPhaseAware Boolean @default(false)
  biodynamicOnly  Boolean @default(false)

  // Privacy Settings
  allowPersonalization  Boolean @default(true)
  shareDataForAnalytics Boolean @default(true)

  // Auto-Apply Settings
  autoApplyFilters Boolean @default(true)
  autoApplySort    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_preferences")
}

model PersonalizationScore {
  id         String @id @default(cuid())
  userId     String
  entityType String @db.VarChar(50)
  entityId   String

  // Scores (0-100)
  relevanceScore  Int
  affinityScore   Int
  seasonalScore   Int
  proximityScore  Int
  popularityScore Int

  // Combined Score
  totalScore Int

  // Context
  season       Season
  calculatedAt DateTime @default(now())
  expiresAt    DateTime

  @@unique([userId, entityType, entityId, season])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([totalScore])
  @@index([expiresAt])
  @@map("personalization_scores")
}

model Recommendation {
  id     String @id @default(cuid())
  userId String

  // Recommendation Type
  type RecommendationType

  // Recommended Entity
  entityType String @db.VarChar(50)
  entityId   String

  // Scoring
  score      Decimal @db.Decimal(5, 2)
  confidence Decimal @db.Decimal(5, 4)

  // Reason (JSONB)
  reasons Json

  // Context
  season Season?
  source String? @db.VarChar(50)

  // Interaction Tracking
  shown       Boolean   @default(false)
  shownAt     DateTime?
  clicked     Boolean   @default(false)
  clickedAt   DateTime?
  converted   Boolean   @default(false)
  convertedAt DateTime?

  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([userId])
  @@index([type])
  @@index([entityType, entityId])
  @@index([shown, clicked, converted])
  @@index([expiresAt])
  @@map("recommendations")
}

model ABTest {
  id          String  @id @default(cuid())
  name        String  @db.VarChar(255)
  description String?

  // Test Configuration
  variants     Json
  trafficSplit Json

  // Targeting
  targetAudience Json?

  // Status
  status    ABTestStatus @default(DRAFT)
  startedAt DateTime?
  endedAt   DateTime?

  // Results (updated periodically)
  results       Json?
  winnerVariant String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assignments ABTestAssignment[]

  @@index([status])
  @@index([startedAt, endedAt])
  @@map("ab_tests")
}

model ABTestAssignment {
  id        String  @id @default(cuid())
  testId    String
  userId    String?
  sessionId String  @db.VarChar(100)

  variantId  String   @db.VarChar(50)
  assignedAt DateTime @default(now())

  test ABTest @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@unique([testId, userId])
  @@unique([testId, sessionId])
  @@index([testId])
  @@index([userId])
  @@map("ab_test_assignments")
}

model ABTestEvent {
  id        String @id @default(cuid())
  testId    String
  userId    String
  variantId String @db.VarChar(50)

  // Event Details
  event     String   @db.VarChar(100)
  value     Decimal  @default(0) @db.Decimal(10, 2)
  metadata  Json?
  timestamp DateTime @default(now())

  @@index([testId])
  @@index([userId])
  @@index([variantId])
  @@index([event])
  @@index([timestamp])
  @@map("ab_test_events")
}

// ============================================
// RUN 4: NEW ENUMS
// ============================================

enum NotificationFrequency {
  REALTIME
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
}

enum SearchAlertType {
  NEW_PRODUCTS
  PRICE_CHANGE
  BACK_IN_STOCK
  SEASONAL_AVAILABLE
  FARM_UPDATE
  CUSTOM
}

enum SharePermission {
  VIEW
  EDIT
  ADMIN
}

enum InteractionType {
  SEARCH
  VIEW
  CLICK
  ADD_TO_CART
  PURCHASE
  FAVORITE
  REVIEW
  SHARE
}

enum PeriodType {
  HOUR
  DAY
  WEEK
  MONTH
  QUARTER
  YEAR
}

enum RecommendationType {
  SIMILAR_PRODUCT
  SIMILAR_PRODUCTS
  COMPLEMENTARY
  FREQUENTLY_BOUGHT_TOGETHER
  TRENDING
  SEASONAL
  POPULAR_IN_AREA
  FARM_DISCOVERY
  PERSONALIZED
  PERSONALIZED_PRODUCTS
  COLLABORATIVE
  BASED_ON_BROWSING
  NEW_ARRIVALS
}

enum ABTestStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

// ============================================
// PHASE 3: ANALYTICS & TRACKING MODELS
// ============================================
// Note: SearchEvent, UserInteraction, SearchAnalytics already exist above
// Additional Phase 3 models below:

// User Search Profile - Personalization intelligence
model UserSearchProfile {
  id     String @id @default(cuid())
  userId String @unique

  // Search Behavior
  totalSearches          Int
  uniqueQueriesCount     Int
  averageSessionDepth    Decimal @db.Decimal(5, 2)
  averageSearchesPerDay  Decimal @db.Decimal(10, 2)
  preferredSortBy        String? @db.VarChar(50)

  // Agricultural Preferences (JSONB)
  topCategories         Json // [{categoryId, count, percentage}]
  favoriteFarms         Json // [{farmId, interactionCount, lastVisit}]
  seasonalPreferences   Json // {SPRING: score, SUMMER: score, ...}
  dietaryPatterns       Json?
  priceRangeTendency    Json // {min, max, average}

  // Interaction Patterns
  clickThroughRate      Decimal @db.Decimal(5, 4)
  conversionRate        Decimal @db.Decimal(5, 4)
  averageOrderValue     Decimal? @db.Decimal(10, 2)
  repeatPurchaseRate    Decimal? @db.Decimal(5, 4)

  // Time Patterns
  peakSearchHours       Json // [hour1, hour2, ...]
  peakSearchDays        Json // [day1, day2, ...]
  lastSearchAt          DateTime?
  firstSearchAt         DateTime?

  // Engagement Metrics
  savedSearchesCount    Int @default(0)
  activeAlertsCount     Int @default(0)
  sharedSearchesCount   Int @default(0)
  reviewsCount          Int @default(0)

  // Agricultural Consciousness
  biodynamicEngagement  Decimal @db.Decimal(5, 4)
  seasonalAwareness     Decimal @db.Decimal(5, 4)
  localFarmSupport      Decimal @db.Decimal(5, 4)

  calculatedAt DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([calculatedAt])
  @@map("user_search_profiles")
}

// Performance Metrics - System-wide quantum performance tracking
model PerformanceMetric {
  id String @id @default(cuid())

  // Metric Identity
  metricName String     @db.VarChar(100)
  metricType String     @db.VarChar(50) // "response_time", "database_query", "cache_hit", etc.
  period     PeriodType
  periodKey  String     @db.VarChar(50)

  // Statistical Measures
  count      Int
  sum        Decimal @db.Decimal(15, 2)
  average    Decimal @db.Decimal(10, 2)
  min        Decimal @db.Decimal(10, 2)
  max        Decimal @db.Decimal(10, 2)
  median     Decimal @db.Decimal(10, 2)
  p50        Decimal @db.Decimal(10, 2)
  p75        Decimal @db.Decimal(10, 2)
  p90        Decimal @db.Decimal(10, 2)
  p95        Decimal @db.Decimal(10, 2)
  p99        Decimal @db.Decimal(10, 2)
  stdDev     Decimal @db.Decimal(10, 4)

  // Context
  context Json?

  // Hardware Awareness (HP OMEN optimization tracking)
  cpuUsage    Decimal? @db.Decimal(5, 2)
  memoryUsage Decimal? @db.Decimal(5, 2)
  gpuUsage    Decimal? @db.Decimal(5, 2)
  threadCount Int?

  calculatedAt DateTime @default(now())

  @@unique([metricName, metricType, period, periodKey])
  @@index([metricName, metricType])
  @@index([period, periodKey])
  @@index([calculatedAt])
  @@map("performance_metrics")
}

// Search Trend - Temporal pattern analysis
model SearchTrend {
  id String @id @default(cuid())

  // Trend Identity
  query      String?     @db.VarChar(500)
  categoryId String?
  farmId     String?
  season     Season?
  trendType  String      @db.VarChar(50) // "rising", "falling", "stable", "seasonal"

  // Trend Metrics
  currentVolume   Int
  previousVolume  Int
  growthRate      Decimal @db.Decimal(10, 4)
  volatility      Decimal @db.Decimal(5, 4)
  trendScore      Decimal @db.Decimal(5, 2)

  // Temporal Analysis
  period          PeriodType
  periodKey       String      @db.VarChar(50)
  comparisonPeriodKey String  @db.VarChar(50)

  // Forecasting (JSONB)
  forecast        Json? // {nextPeriod: volume, confidence: 0.85}
  seasonality     Json? // Pattern detection

  // Agricultural Context
  agriculturalFactors Json?
  biodynamicInfluence Decimal? @db.Decimal(5, 2)

  // Ranking
  rank            Int?
  previousRank    Int?

  calculatedAt DateTime @default(now())
  expiresAt    DateTime

  @@unique([query, categoryId, farmId, season, period, periodKey])
  @@index([trendType])
  @@index([period, periodKey])
  @@index([rank])
  @@index([expiresAt])
  @@map("search_trends")
}

// Analytics Dashboard Snapshot - Pre-computed dashboard data
model AnalyticsDashboard {
  id String @id @default(cuid())

  // Dashboard Identity
  dashboardType String     @db.VarChar(50) // "overview", "search", "user", "farm", "product"
  entityId      String?
  period        PeriodType
  periodKey     String     @db.VarChar(50)

  // Computed Metrics (JSONB)
  metrics Json // Complete dashboard data structure

  // Key Performance Indicators
  kpis Json // {totalSearches, totalUsers, conversionRate, ...}

  // Charts Data (JSONB arrays)
  timeSeriesData Json? // For trend charts
  distributionData Json? // For pie/bar charts
  comparisonData Json? // For period-over-period

  // Agricultural Insights
  seasonalInsights Json?
  farmPerformance Json?
  productTrends Json?

  calculatedAt DateTime @default(now())
  expiresAt    DateTime

  @@unique([dashboardType, entityId, period, periodKey])
  @@index([dashboardType])
  @@index([period, periodKey])
  @@index([expiresAt])
  @@map("analytics_dashboards")
}

// ============================================
// PHASE 3: ADDITIONAL ENUMS
// ============================================

enum AnalyticsGranularity {
  MINUTE
  HOUR
  DAY
  WEEK
  MONTH
  QUARTER
  YEAR
}

enum TrendDirection {
  RISING
  FALLING
  STABLE
  VOLATILE
  SEASONAL
}

// ============================================
// PHASE 5: MACHINE LEARNING MODELS
// ============================================

model MLModel {
  id String @id @default(cuid())

  // Model Metadata
  name        String @unique @db.VarChar(100)
  version     String @db.VarChar(20)
  type        MLModelType
  description String? @db.Text
  status      MLModelStatus @default(TRAINING)

  // Training Info
  trainedAt     DateTime?
  trainingJobId String?
  accuracy      Decimal? @db.Decimal(5, 4)
  precision     Decimal? @db.Decimal(5, 4)
  recall        Decimal? @db.Decimal(5, 4)
  f1Score       Decimal? @db.Decimal(5, 4)

  // Model Configuration
  hyperparameters Json?
  features        Json
  modelPath       String? @db.VarChar(500)
  modelSize       Int? // in bytes

  // Performance Metrics
  inferenceTime   Int? // in milliseconds
  predictionsCount Int @default(0)
  successRate     Decimal? @db.Decimal(5, 4)

  // Metadata
  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  predictions    MLPrediction[]
  trainingJobs   MLTrainingJob[]

  @@index([type])
  @@index([status])
  @@index([trainedAt])
  @@map("ml_models")
}

model MLPrediction {
  id String @id @default(cuid())

  // Model Reference
  modelId String
  model   MLModel @relation(fields: [modelId], references: [id], onDelete: Cascade)

  // Input/Output
  input      Json
  output     Json
  confidence Decimal @db.Decimal(5, 4)

  // Context
  userId    String?
  sessionId String?
  context   Json?

  // Performance
  inferenceTime Int // in milliseconds
  wasCorrect    Boolean?
  feedback      String? @db.Text

  // Metadata
  createdAt DateTime @default(now())

  @@index([modelId])
  @@index([userId])
  @@index([createdAt])
  @@map("ml_predictions")
}

model MLTrainingJob {
  id String @id @default(cuid())

  // Model Reference
  modelId String
  model   MLModel @relation(fields: [modelId], references: [id], onDelete: Cascade)

  // Job Info
  status      MLTrainingStatus @default(PENDING)
  startedAt   DateTime?
  completedAt DateTime?
  duration    Int? // in seconds

  // Training Data
  datasetSize    Int
  trainingSize   Int
  validationSize Int
  testSize       Int

  // Results
  finalAccuracy  Decimal? @db.Decimal(5, 4)
  finalLoss      Decimal? @db.Decimal(10, 6)
  bestEpoch      Int?
  totalEpochs    Int?

  // Configuration
  config Json?
  logs   Json?

  // Error Handling
  error String? @db.Text

  // Metadata
  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([modelId])
  @@index([status])
  @@index([createdAt])
  @@map("ml_training_jobs")
}

// ============================================
// PHASE 5: ML ENUMS
// ============================================

enum MLModelType {
  RECOMMENDATION
  DEMAND_FORECASTING
  PRICE_OPTIMIZATION
  CHURN_PREDICTION
  SEASONALITY_DETECTION
  QUALITY_PREDICTION
  SENTIMENT_ANALYSIS
}

enum MLModelStatus {
  TRAINING
  READY
  DEPLOYED
  DEPRECATED
  FAILED
}

enum MLTrainingStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}
