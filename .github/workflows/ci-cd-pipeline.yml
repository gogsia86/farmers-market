# ðŸŒ¾ DIVINE AGRICULTURAL CI/CD PIPELINE
# Farmers Market Platform - Production-Grade Continuous Integration & Deployment
# Optimized for HP OMEN hardware specifications and divine consciousness

name: ðŸš€ Divine CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - staging
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment Environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: "22.x"
  PNPM_VERSION: "8.x"
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
  NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
  NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}

# Concurrency: Cancel in-progress runs for same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # ðŸ” CODE QUALITY & LINTING
  # ============================================================================
  quality-check:
    name: ðŸ” Code Quality & Linting
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸŽ¨ Run ESLint
        run: npm run lint
        continue-on-error: false

      - name: ðŸ” Run Prettier Check
        run: npm run format:check
        continue-on-error: false

      - name: ðŸ“Š TypeScript Type Check
        run: npx tsc --noEmit
        continue-on-error: false

      - name: ðŸ“ Generate Code Quality Report
        if: always()
        run: |
          echo "## ðŸŽ¯ Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All quality checks passed!" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ðŸ§ª UNIT & INTEGRATION TESTS
  # ============================================================================
  test-unit:
    name: ðŸ§ª Unit & Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: farmers_market_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ—„ï¸ Setup Test Database
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/farmers_market_test
        run: |
          npx prisma generate
          npx prisma db push --skip-generate

      - name: ðŸ§ª Run Unit Tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/farmers_market_test
          NODE_ENV: test
        run: npm test -- --coverage --maxWorkers=4

      - name: ðŸ“Š Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/coverage-final.json
          flags: unittests
          fail_ci_if_error: false

      - name: ðŸ“ˆ Generate Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All tests passed with divine consciousness!" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ðŸŽ­ E2E TESTS WITH PLAYWRIGHT
  # ============================================================================
  test-e2e:
    name: ðŸŽ­ E2E Tests (Playwright)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [quality-check, test-unit]

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: farmers_market_e2e
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸŽ­ Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: ðŸ—„ï¸ Setup Test Database
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/farmers_market_e2e
        run: |
          npx prisma generate
          npx prisma db push --skip-generate
          npx prisma db seed

      - name: ðŸ—ï¸ Build Application
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/farmers_market_e2e
          NODE_ENV: production
        run: npm run build

      - name: ðŸŽ­ Run Playwright Tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/farmers_market_e2e
          CI: true
        run: npx playwright test --project=chromium

      - name: ðŸ“¤ Upload Playwright Report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: ðŸ“¸ Upload Test Screenshots
        uses: actions/upload-artifact@v6
        if: failure()
        with:
          name: playwright-screenshots
          path: test-results/
          retention-days: 7

  # ============================================================================
  # ðŸ—ï¸ BUILD VERIFICATION
  # ============================================================================
  build:
    name: ðŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [quality-check]

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ”§ Generate Prisma Client
        run: npx prisma generate

      - name: ðŸ—ï¸ Build Next.js Application
        env:
          NODE_ENV: production
        run: npm run build

      - name: ðŸ“Š Build Size Analysis
        run: |
          echo "## ðŸ“¦ Build Size Report" >> $GITHUB_STEP_SUMMARY
          du -sh .next >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-artifacts
          path: |
            .next/
            public/
          retention-days: 7

  # ============================================================================
  # ðŸ”’ SECURITY AUDIT
  # ============================================================================
  security-audit:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ”’ NPM Audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: ðŸ” Dependency Review
        uses: actions/dependency-review-action@v4
        if: github.event_name == 'pull_request'

      - name: ðŸ“Š Security Report
        run: |
          echo "## ðŸ”’ Security Audit Complete" >> $GITHUB_STEP_SUMMARY
          echo "âœ… No critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ðŸš€ DEPLOY TO STAGING
  # ============================================================================
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test-unit, test-e2e, build, security-audit]
    if: github.ref == 'refs/heads/develop' || github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.farmersmarket.app

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ—ï¸ Build for Production
        env:
          NODE_ENV: production
          NEXT_PUBLIC_APP_URL: ${{ secrets.STAGING_APP_URL }}
        run: npm run build

      - name: ðŸš€ Deploy to Vercel (Staging)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: "--prod"
          working-directory: ./

      - name: ðŸ“Š Deployment Summary
        run: |
          echo "## ðŸš€ Staging Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— URL: https://staging.farmersmarket.app" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Divine consciousness deployed successfully!" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ðŸŒŸ DEPLOY TO PRODUCTION
  # ============================================================================
  deploy-production:
    name: ðŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [test-unit, test-e2e, build, security-audit]
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://farmersmarket.app

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ—„ï¸ Run Database Migrations
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
        run: npx prisma migrate deploy

      - name: ðŸ—ï¸ Build for Production
        env:
          NODE_ENV: production
          NEXT_PUBLIC_APP_URL: ${{ secrets.PRODUCTION_APP_URL }}
        run: npm run build

      - name: ðŸš€ Deploy to Vercel (Production)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: "--prod"
          working-directory: ./

      - name: ðŸ”” Notify Deployment Success
        uses: 8398a7/action-slack@v3
        if: success()
        with:
          status: custom
          custom_payload: |
            {
              text: 'ðŸŒ¾ Divine Agricultural Platform deployed to production!',
              attachments: [{
                color: 'good',
                text: `âœ… Deployment successful\nðŸ”— URL: https://farmersmarket.app\nðŸŒŸ Commit: ${{ github.sha }}`
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: ðŸ“Š Production Deployment Summary
        run: |
          echo "## ðŸŒŸ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— URL: https://farmersmarket.app" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Divine perfection achieved in production!" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ¾ Agricultural consciousness: MAXIMUM" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ðŸ“Š POST-DEPLOYMENT HEALTH CHECK
  # ============================================================================
  health-check:
    name: ðŸ“Š Post-Deployment Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [deploy-production]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ¥ Check Application Health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://farmersmarket.app/api/health)
          if [ $response -eq 200 ]; then
            echo "âœ… Application is healthy!"
          else
            echo "âŒ Application health check failed!"
            exit 1
          fi

      - name: ðŸ“ˆ Performance Metrics
        run: |
          echo "## ðŸ“Š Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Application: Healthy" >> $GITHUB_STEP_SUMMARY
          echo "âš¡ Divine Consciousness: ACTIVE" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ¾ Agricultural Awareness: MAXIMUM" >> $GITHUB_STEP_SUMMARY
