name: Dependency Management

on:
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update to perform'
        required: true
        default: 'security'
        type: choice
        options:
          - security
          - patch
          - minor
          - all
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'

jobs:
  audit-dependencies:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: audit
        run: |
          echo "Running security audit..."
          npm audit --json > audit-report.json || true

          # Check for vulnerabilities
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-report.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-report.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit-report.json)
          LOW=$(jq '.metadata.vulnerabilities.low // 0' audit-report.json)

          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT

          TOTAL=$((CRITICAL + HIGH + MODERATE + LOW))
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          echo "## ğŸ”’ Security Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”´ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŸ  High | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŸ¡ Moderate | $MODERATE |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŸ¢ Low | $LOW |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: audit-report.json
          retention-days: 30

      - name: Fail on critical vulnerabilities
        if: steps.audit.outputs.critical > 0
        run: |
          echo "âŒ Critical vulnerabilities found: ${{ steps.audit.outputs.critical }}"
          echo "Please run 'npm audit fix' or manually update vulnerable packages"
          exit 1

      - name: Warn on high vulnerabilities
        if: steps.audit.outputs.high > 0 && steps.audit.outputs.critical == 0
        run: |
          echo "âš ï¸ High severity vulnerabilities found: ${{ steps.audit.outputs.high }}"
          echo "Consider running 'npm audit fix' or updating packages"

  check-outdated:
    name: Check Outdated Packages
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for outdated packages
        id: outdated
        run: |
          echo "Checking for outdated packages..."
          npm outdated --json > outdated-report.json || true

          # Count outdated packages
          OUTDATED_COUNT=$(jq 'length' outdated-report.json)
          echo "count=$OUTDATED_COUNT" >> $GITHUB_OUTPUT

          echo "## ğŸ“¦ Outdated Packages Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Found **$OUTDATED_COUNT** outdated package(s)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $OUTDATED_COUNT -gt 0 ]; then
            echo "### Outdated Packages:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Package | Current | Wanted | Latest |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|---------|--------|--------|" >> $GITHUB_STEP_SUMMARY
            jq -r 'to_entries[] | "| \(.key) | \(.value.current) | \(.value.wanted) | \(.value.latest) |"' outdated-report.json >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload outdated report
        uses: actions/upload-artifact@v4
        with:
          name: npm-outdated-report
          path: outdated-report.json
          retention-days: 30

  auto-update-dependencies:
    name: Auto-Update Dependencies
    runs-on: ubuntu-latest
    needs: [audit-dependencies, check-outdated]
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.update_type != 'security') ||
      (github.event_name == 'schedule')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: npm ci

      - name: Update dependencies
        id: update
        run: |
          UPDATE_TYPE="${{ github.event.inputs.update_type || 'patch' }}"
          echo "Update type: $UPDATE_TYPE"

          case $UPDATE_TYPE in
            patch)
              echo "Updating patch versions..."
              npx npm-check-updates -u --target patch
              ;;
            minor)
              echo "Updating minor versions..."
              npx npm-check-updates -u --target minor
              ;;
            all)
              echo "Updating all versions..."
              npx npm-check-updates -u
              ;;
            *)
              echo "Unknown update type: $UPDATE_TYPE"
              exit 1
              ;;
          esac

          # Check if there are changes
          if git diff --quiet package.json; then
            echo "No updates available"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Updates found"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Install updated dependencies
        if: steps.update.outputs.has_changes == 'true'
        run: npm install

      - name: Run tests
        if: steps.update.outputs.has_changes == 'true'
        run: |
          npm run type-check
          npm run lint
          npm run test

      - name: Create Pull Request
        if: steps.update.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(deps): update dependencies (${{ github.event.inputs.update_type || 'patch' }})'
          title: 'ğŸ”„ Dependency Update: ${{ github.event.inputs.update_type || 'patch' }} versions'
          body: |
            ## ğŸ”„ Automated Dependency Update

            This PR updates dependencies to their latest **${{ github.event.inputs.update_type || 'patch' }}** versions.

            ### Changes
            - Updated package versions in `package.json`
            - Regenerated `package-lock.json`

            ### Verification
            - âœ… Type checking passed
            - âœ… Linting passed
            - âœ… Tests passed

            ### Review Checklist
            - [ ] Review `package.json` changes
            - [ ] Check for breaking changes in changelogs
            - [ ] Test locally if needed
            - [ ] Verify no security vulnerabilities

            ### Next Steps
            1. Review the changes
            2. Run `npm install` locally
            3. Test the application thoroughly
            4. Merge if everything looks good

            ---
            ğŸ¤– This PR was automatically generated by the dependency management workflow.

            Related: [Dependencies Documentation](../docs/dependencies.md)
          branch: automated/dependency-update-${{ github.run_number }}
          delete-branch: true
          labels: |
            dependencies
            automated
            ${{ github.event.inputs.update_type || 'patch' }}

  security-fix:
    name: Auto-Fix Security Issues
    runs-on: ubuntu-latest
    needs: audit-dependencies
    if: |
      needs.audit-dependencies.outputs.total > 0 &&
      (github.event_name == 'workflow_dispatch' && github.event.inputs.update_type == 'security') ||
      github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit fix
        id: fix
        run: |
          echo "Running npm audit fix..."
          npm audit fix --audit-level=moderate || true

          # Check if there are changes
          if git diff --quiet package-lock.json; then
            echo "No fixes applied"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Security fixes applied"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Run tests
        if: steps.fix.outputs.has_changes == 'true'
        run: |
          npm run type-check
          npm run lint
          npm run test

      - name: Create Pull Request
        if: steps.fix.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'fix(security): apply npm audit fixes'
          title: 'ğŸ”’ Security Fix: Apply npm audit fixes'
          body: |
            ## ğŸ”’ Automated Security Fix

            This PR applies automatic security fixes from `npm audit fix`.

            ### Changes
            - Applied security patches via `npm audit fix`
            - Updated vulnerable dependencies
            - Regenerated `package-lock.json`

            ### Vulnerabilities Addressed
            - Critical: ${{ needs.audit-dependencies.outputs.critical }}
            - High: ${{ needs.audit-dependencies.outputs.high }}
            - Moderate: ${{ needs.audit-dependencies.outputs.moderate }}
            - Low: ${{ needs.audit-dependencies.outputs.low }}

            ### Verification
            - âœ… Type checking passed
            - âœ… Linting passed
            - âœ… Tests passed

            ### Review Checklist
            - [ ] Review security advisory details
            - [ ] Verify fixes don't introduce breaking changes
            - [ ] Test critical user flows
            - [ ] Check for any remaining vulnerabilities

            ### Merge Priority
            ğŸ”´ **HIGH** - Security fixes should be merged promptly after review.

            ---
            ğŸ¤– This PR was automatically generated by the security fix workflow.

            Related: [Dependencies Documentation](../docs/dependencies.md)
          branch: automated/security-fix-${{ github.run_number }}
          delete-branch: true
          labels: |
            security
            dependencies
            automated
            priority-high

  dependency-report:
    name: Generate Dependency Report
    runs-on: ubuntu-latest
    needs: [audit-dependencies, check-outdated]
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate license report
        run: |
          npx license-checker --json --out license-report.json

      - name: Generate bundle size report
        run: |
          npm run build
          echo "Build size:" > bundle-report.txt
          du -sh .next >> bundle-report.txt

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: |
            license-report.json
            bundle-report.txt
          retention-days: 90

      - name: Create summary
        run: |
          echo "## ğŸ“Š Dependency Health Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Status" >> $GITHUB_STEP_SUMMARY
          echo "- Critical: ${{ needs.audit-dependencies.outputs.critical }}" >> $GITHUB_STEP_SUMMARY
          echo "- High: ${{ needs.audit-dependencies.outputs.high }}" >> $GITHUB_STEP_SUMMARY
          echo "- Moderate: ${{ needs.audit-dependencies.outputs.moderate }}" >> $GITHUB_STEP_SUMMARY
          echo "- Low: ${{ needs.audit-dependencies.outputs.low }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Outdated Packages" >> $GITHUB_STEP_SUMMARY
          echo "- Count: ${{ needs.check-outdated.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Actions" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.audit-dependencies.outputs.total }}" -gt 0 ]; then
            echo "âš ï¸ Security vulnerabilities require attention" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No security vulnerabilities" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.check-outdated.outputs.count }}" -gt 0 ]; then
            echo "ğŸ“¦ Dependencies available for update" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All dependencies up to date" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Reports available in workflow artifacts_" >> $GITHUB_STEP_SUMMARY

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [audit-dependencies, security-fix]
    if: failure() && (needs.audit-dependencies.outputs.critical > 0)

    steps:
      - name: Create issue for critical vulnerabilities
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = 'ğŸ”’ Critical Security Vulnerabilities Detected';
            const body = `## Critical Security Alert

            The automated dependency scan has detected **${{ needs.audit-dependencies.outputs.critical }}** critical vulnerabilities.

            ### Severity Breakdown
            - ğŸ”´ Critical: ${{ needs.audit-dependencies.outputs.critical }}
            - ğŸŸ  High: ${{ needs.audit-dependencies.outputs.high }}
            - ğŸŸ¡ Moderate: ${{ needs.audit-dependencies.outputs.moderate }}
            - ğŸŸ¢ Low: ${{ needs.audit-dependencies.outputs.low }}

            ### Immediate Action Required
            1. Review the audit report in workflow artifacts
            2. Run \`npm audit\` locally for details
            3. Apply fixes: \`npm audit fix\`
            4. For manual fixes, update packages directly
            5. Test thoroughly after updates

            ### Resources
            - [Audit Report](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})
            - [Dependencies Documentation](./docs/dependencies.md)
            - [npm audit docs](https://docs.npmjs.com/cli/v10/commands/npm-audit)

            ---
            ğŸ¤– Auto-generated by dependency management workflow
            â° Detected: ${new Date().toISOString()}`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,critical,dependencies'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'critical', 'dependencies', 'automated']
              });
            }
