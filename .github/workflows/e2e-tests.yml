name: ðŸŒ¾ E2E Tests & Monitoring

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      test_type:
        description: "Test type to run"
        required: true
        default: "e2e"
        type: choice
        options:
          - e2e
          - load
          - monitoring
          - all

env:
  NODE_VERSION: "22"
  DATABASE_URL: postgresql://postgres:test_password_123@localhost:5433/farmersmarket_test
  NEXTAUTH_URL: http://localhost:3001
  NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'divine-test-secret-for-ci-cd-testing-only-1234567890' }}

jobs:
  # ============================================================================
  # JOB 1: E2E TESTS
  # ============================================================================
  e2e-tests:
    name: ðŸ§ª E2E Tests (Playwright)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: test_password_123
          POSTGRES_DB: farmersmarket_test
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright browsers
        run: npx playwright install --with-deps chromium firefox webkit

      - name: ðŸ”§ Generate Prisma Client
        run: npx prisma generate

      - name: ðŸ—„ï¸ Push database schema
        run: npx prisma db push --accept-data-loss
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

      - name: ðŸš€ Start dev server
        run: |
          npm run dev &
          echo "DEV_SERVER_PID=$!" >> $GITHUB_ENV
        env:
          DATABASE_URL: postgresql://postgres:test_password_123@localhost:5432/farmersmarket
          PORT: 3001

      - name: â³ Wait for server to be ready
        run: |
          echo "Waiting for dev server to be ready..."
          npx wait-on http://localhost:3001 --timeout 120000
          echo "âœ… Dev server is ready!"

      - name: ðŸ§ª Run E2E tests
        run: npx playwright test --config=playwright.config.temp.ts --workers=4
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          CI: true

      - name: ðŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: ðŸ“¸ Upload failure screenshots
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: test-failures
          path: test-results/
          retention-days: 7

      - name: ðŸ“ˆ Publish test results
        if: always()
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: "test-results/junit.xml"
          fail_on_failure: true
          require_tests: true

      - name: ðŸ’¬ Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: daun/playwright-report-comment@v3
        with:
          report-path: playwright-report/

      - name: ðŸ“¢ Notify Slack - E2E Tests Success
        if: success() && env.SLACK_WEBHOOK_URL != ''
        run: |
          node -e "
          const https = require('https');
          const url = new URL(process.env.SLACK_WEBHOOK_URL);
          const data = JSON.stringify({
            text: 'âœ… E2E Tests Passed',
            attachments: [{
              color: '#36a64f',
              title: 'âœ… E2E Tests Completed Successfully',
              fields: [
                { title: 'Branch', value: '${{ github.ref_name }}', short: true },
                { title: 'Commit', value: '${{ github.sha }}'.substring(0, 7), short: true },
                { title: 'Actor', value: '${{ github.actor }}', short: true },
                { title: 'Workflow', value: '${{ github.workflow }}', short: true }
              ],
              footer: 'Farmers Market Platform CI/CD',
              ts: Math.floor(Date.now() / 1000)
            }]
          });
          const req = https.request({ hostname: url.hostname, port: 443, path: url.pathname + url.search, method: 'POST', headers: { 'Content-Type': 'application/json', 'Content-Length': Buffer.byteLength(data) }}, (res) => { console.log('Slack notified:', res.statusCode); });
          req.on('error', (e) => { console.error('Error:', e.message); });
          req.write(data);
          req.end();
          "
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ðŸ“¢ Notify Slack - E2E Tests Failure
        if: failure() && env.SLACK_WEBHOOK_URL != ''
        run: |
          node -e "
          const https = require('https');
          const url = new URL(process.env.SLACK_WEBHOOK_URL);
          const data = JSON.stringify({
            text: 'âŒ E2E Tests Failed',
            attachments: [{
              color: '#ff0000',
              title: 'âŒ E2E Tests Failed',
              title_link: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}',
              fields: [
                { title: 'Branch', value: '${{ github.ref_name }}', short: true },
                { title: 'Commit', value: '${{ github.sha }}'.substring(0, 7), short: true },
                { title: 'Actor', value: '${{ github.actor }}', short: true },
                { title: 'Workflow', value: '${{ github.workflow }}', short: true }
              ],
              text: 'Click the title to view workflow logs',
              footer: 'Farmers Market Platform CI/CD',
              ts: Math.floor(Date.now() / 1000)
            }]
          });
          const req = https.request({ hostname: url.hostname, port: 443, path: url.pathname + url.search, method: 'POST', headers: { 'Content-Type': 'application/json', 'Content-Length': Buffer.byteLength(data) }}, (res) => { console.log('Slack notified:', res.statusCode); });
          req.on('error', (e) => { console.error('Error:', e.message); });
          req.write(data);
          req.end();
          "
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          if [ ! -z "$DEV_SERVER_PID" ]; then
            kill $DEV_SERVER_PID || true
          fi

  # ============================================================================
  # JOB 2: LOAD TESTING (K6)
  # ============================================================================
  load-tests:
    name: ðŸš€ Load Tests (K6)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'schedule' || github.event.inputs.test_type == 'load' || github.event.inputs.test_type == 'all'

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: test_password_123
          POSTGRES_DB: farmersmarket_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”§ Generate Prisma Client
        run: npx prisma generate

      - name: ðŸ—„ï¸ Setup database
        run: npx prisma db push --accept-data-loss

      - name: ðŸš€ Start dev server
        run: |
          npm run dev &
          echo "DEV_SERVER_PID=$!" >> $GITHUB_ENV

      - name: â³ Wait for server
        run: npx wait-on http://localhost:3001 --timeout 120000

      - name: ðŸ“¥ Install K6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: ðŸ”¥ Run marketplace load test
        run: k6 run --duration 3m --vus 50 tests/load/marketplace-load.js
        env:
          BASE_URL: http://localhost:3001

      - name: ðŸ”¥ Run API stress test
        run: k6 run --duration 3m --vus 100 tests/load/api-stress-test.js
        env:
          BASE_URL: http://localhost:3001

      - name: ðŸ“Š Upload K6 results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: k6-results
          path: tests/load/results/
          retention-days: 30

      - name: ðŸ“¢ Notify Slack - Load Tests Complete
        if: always() && env.SLACK_WEBHOOK_URL != ''
        run: |
          node -e "
          const https = require('https');
          const url = new URL(process.env.SLACK_WEBHOOK_URL);
          const status = '${{ job.status }}';
          const color = status === 'success' ? '#36a64f' : '#ff0000';
          const emoji = status === 'success' ? 'âœ…' : 'âŒ';
          const data = JSON.stringify({
            text: emoji + ' Load Tests ' + (status === 'success' ? 'Completed' : 'Failed'),
            attachments: [{
              color: color,
              title: emoji + ' Load Tests ' + (status === 'success' ? 'Completed' : 'Failed'),
              fields: [
                { title: 'Branch', value: '${{ github.ref_name }}', short: true },
                { title: 'Duration', value: '3 minutes', short: true },
                { title: 'VUs', value: '50-100', short: true },
                { title: 'Tests', value: 'Marketplace + API Stress', short: true }
              ],
              footer: 'Farmers Market Platform - Load Testing',
              ts: Math.floor(Date.now() / 1000)
            }]
          });
          const req = https.request({ hostname: url.hostname, port: 443, path: url.pathname + url.search, method: 'POST', headers: { 'Content-Type': 'application/json', 'Content-Length': Buffer.byteLength(data) }}, (res) => { console.log('Slack notified:', res.statusCode); });
          req.on('error', (e) => { console.error('Error:', e.message); });
          req.write(data);
          req.end();
          "
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          if [ ! -z "$DEV_SERVER_PID" ]; then
            kill $DEV_SERVER_PID || true
          fi

  # ============================================================================
  # JOB 3: CONTINUOUS MONITORING
  # ============================================================================
  monitoring:
    name: ðŸ“Š Continuous Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'schedule' || github.event.inputs.test_type == 'monitoring' || github.event.inputs.test_type == 'all'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run monitoring checks
        run: |
          # Check if monitoring script exists
          if [ -f "scripts/workflow-monitor.ts" ]; then
            npx tsx scripts/workflow-monitor.ts --mode critical
          else
            echo "âš ï¸ Monitoring script not found, skipping..."
          fi
        env:
          BASE_URL: ${{ secrets.STAGING_URL || 'http://localhost:3001' }}

      - name: ðŸ“¢ Notify Slack - Monitoring Alert
        if: failure() && env.SLACK_WEBHOOK_URL != ''
        run: |
          node -e "
          const https = require('https');
          const url = new URL(process.env.SLACK_WEBHOOK_URL);
          const data = JSON.stringify({
            text: 'ðŸš¨ Monitoring Alert Detected',
            attachments: [{
              color: '#ff0000',
              title: 'ðŸš¨ Monitoring Check Failed',
              title_link: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}',
              text: 'Critical monitoring checks have failed. Immediate attention required.',
              fields: [
                { title: 'Branch', value: '${{ github.ref_name }}', short: true },
                { title: 'Check Type', value: 'Continuous Monitoring', short: true }
              ],
              footer: 'Farmers Market Platform - Monitoring',
              ts: Math.floor(Date.now() / 1000)
            }]
          });
          const req = https.request({ hostname: url.hostname, port: 443, path: url.pathname + url.search, method: 'POST', headers: { 'Content-Type': 'application/json', 'Content-Length': Buffer.byteLength(data) }}, (res) => { console.log('Slack notified:', res.statusCode); });
          req.on('error', (e) => { console.error('Error:', e.message); });
          req.write(data);
          req.end();
          "
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ðŸ“Š Upload monitoring results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: monitoring-results
          path: monitoring-*.json
          retention-days: 7

  # ============================================================================
  # JOB 4: UNIT TESTS
  # ============================================================================
  unit-tests:
    name: ðŸ§ª Unit Tests (Jest)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ§ª Run unit tests
        run: npm run test -- --coverage --maxWorkers=4

      - name: ðŸ“Š Upload coverage reports
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # ============================================================================
  # JOB 5: CODE QUALITY
  # ============================================================================
  code-quality:
    name: ðŸ” Code Quality & Linting
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run ESLint
        run: npm run lint

      - name: ðŸŽ¨ Check TypeScript
        run: npx tsc --noEmit

      - name: ðŸŽ¨ Check Prettier formatting
        run: npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css,md}"

  # ============================================================================
  # JOB 6: SECURITY SCAN
  # ============================================================================
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: ðŸ”’ Run Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  # ============================================================================
  # JOB 7: DEPLOYMENT GATE
  # ============================================================================
  deployment-gate:
    name: ðŸš¦ Deployment Gate
    runs-on: ubuntu-latest
    needs: [e2e-tests, unit-tests, code-quality]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    steps:
      - name: âœ… All checks passed
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ… ALL TESTS PASSED - READY FOR DEPLOYMENT               â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  â€¢ E2E Tests: PASSED                                       â•‘"
          echo "â•‘  â€¢ Unit Tests: PASSED                                      â•‘"
          echo "â•‘  â€¢ Code Quality: PASSED                                    â•‘"
          echo "â•‘  â€¢ Ready to deploy to ${{ github.ref }}                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ðŸ’¬ Notify success
        if: success()
        run: |
          echo "ðŸŽ‰ Deployment gate passed! Ready for production."

      - name: âš ï¸ Notify failure
        if: failure()
        run: |
          echo "âŒ Deployment gate failed. Fix issues before deploying."
          exit 1

  # ============================================================================
  # JOB 8: NOTIFICATION
  # ============================================================================
  notify:
    name: ðŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [e2e-tests, unit-tests, code-quality, security-scan]
    if: always()

    steps:
      - name: ðŸ“Š Determine overall status
        id: status
        run: |
          if [ "${{ needs.e2e-tests.result }}" == "success" ] && \
             [ "${{ needs.unit-tests.result }}" == "success" ] && \
             [ "${{ needs.code-quality.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ’¬ Send Slack notification
        if: github.event_name != 'pull_request'
        uses: slackapi/slack-github-action@v1.26.0
        continue-on-error: true
        with:
          payload: |
            {
              "text": "${{ steps.status.outputs.emoji }} CI/CD Pipeline ${{ steps.status.outputs.status }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ steps.status.outputs.emoji }} Farmers Market Platform - CI/CD Results"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n${{ github.sha }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n${{ steps.status.outputs.status }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Test Results:*\nâ€¢ E2E: ${{ needs.e2e-tests.result }}\nâ€¢ Unit: ${{ needs.unit-tests.result }}\nâ€¢ Quality: ${{ needs.code-quality.result }}\nâ€¢ Security: ${{ needs.security-scan.result }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Run"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

# ============================================================================
# WORKFLOW CONFIGURATION
# ============================================================================

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write
