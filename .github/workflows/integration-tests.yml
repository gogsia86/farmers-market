# ============================================================================
# ğŸ§ª INTEGRATION TESTS & CONTRACT TESTS CI WORKFLOW
# ============================================================================
#
# This workflow runs:
# 1. Database integration tests using Testcontainers (real PostgreSQL)
# 2. Stripe contract tests (against stripe-mock)
#
# Separated from main CI for:
# - Longer execution time (Docker containers)
# - Optional execution on PRs (can be skipped with label)
# - Clear visibility into integration test health
#
# Reference: .github/instructions/13_TESTING_PERFORMANCE_MASTERY.instructions.md
# ============================================================================

name: Integration & Contract Tests

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
    types: [opened, synchronize, reopened, labeled]
  workflow_dispatch:
    inputs:
      skip_stripe_tests:
        description: "Skip Stripe contract tests"
        required: false
        default: false
        type: boolean
      use_stripe_live:
        description: "Use Stripe test mode instead of stripe-mock"
        required: false
        default: false
        type: boolean

# Cancel in-progress runs for the same branch
concurrency:
  group: integration-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  POSTGRES_IMAGE: "postgis/postgis:16-3.4-alpine"

jobs:
  # ==========================================================================
  # JOB 1: Database Integration Tests with Testcontainers
  # ==========================================================================
  integration-db:
    name: ğŸ—„ï¸ Database Integration Tests
    runs-on: ubuntu-latest
    # Skip if PR has 'skip-integration' label
    if: |
      github.event_name != 'pull_request' ||
      !contains(github.event.pull_request.labels.*.name, 'skip-integration')

    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ³ Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: ğŸ³ Pre-pull PostgreSQL image
        run: |
          echo "Pre-pulling PostgreSQL image for faster testcontainer startup..."
          docker pull ${{ env.POSTGRES_IMAGE }}

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ”§ Generate Prisma Client
        run: npx prisma generate

      - name: ğŸ§ª Run Database Integration Tests
        id: integration-tests
        env:
          # Testcontainers configuration
          TESTCONTAINERS_RYUK_DISABLED: "false"
          TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE: /var/run/docker.sock
          DOCKER_HOST: unix:///var/run/docker.sock
          # Next.js environment (minimal for tests)
          NEXTAUTH_SECRET: test-secret-key-for-integration-tests
          NEXTAUTH_URL: http://localhost:3000
          NODE_ENV: test
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ§ª Running Database Integration Tests with Testcontainers  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          npm run test:integration:db -- --ci --verbose
        continue-on-error: false

      - name: ğŸ“Š Upload Integration Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            coverage/integration/
          retention-days: 14
        continue-on-error: true

      - name: ğŸ“‹ Test Summary
        if: always()
        run: |
          echo "### ğŸ—„ï¸ Database Integration Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.integration-tests.outcome }}" == "success" ]; then
            echo "âœ… All database integration tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some integration tests failed. Check the logs above." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- PostgreSQL Image: \`${{ env.POSTGRES_IMAGE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js Version: \`${{ env.NODE_VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Test Framework: Jest with Testcontainers" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # JOB 2: Stripe Contract Tests (using stripe-mock)
  # ==========================================================================
  contract-stripe:
    name: ğŸ’³ Stripe Contract Tests
    runs-on: ubuntu-latest
    # Skip if PR has 'skip-contracts' label or manual skip
    if: |
      (github.event_name != 'pull_request' ||
       !contains(github.event.pull_request.labels.*.name, 'skip-contracts')) &&
      github.event.inputs.skip_stripe_tests != 'true'

    timeout-minutes: 10

    services:
      stripe-mock:
        image: stripe/stripe-mock:latest
        ports:
          - 12111:12111
          - 12112:12112
        options: >-
          --health-cmd "wget --spider -q http://localhost:12111/v1/customers || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ”§ Generate Prisma Client
        run: npx prisma generate

      - name: â³ Wait for stripe-mock
        run: |
          echo "Waiting for stripe-mock to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:12111/v1/customers > /dev/null; then
              echo "stripe-mock is ready!"
              exit 0
            fi
            echo "Attempt $i/30: stripe-mock not ready yet..."
            sleep 2
          done
          echo "stripe-mock failed to start"
          exit 1

      - name: ğŸ’³ Run Stripe Contract Tests (stripe-mock)
        id: stripe-mock-tests
        env:
          USE_STRIPE_MOCK: "true"
          STRIPE_SECRET_KEY: "sk_test_mock_key"
          NODE_ENV: test
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ’³ Running Stripe Contract Tests (stripe-mock)            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          npm run test:contracts:stripe:mock -- --ci
        continue-on-error: false

      - name: ğŸ“‹ Stripe Test Summary
        if: always()
        run: |
          echo "### ğŸ’³ Stripe Contract Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.stripe-mock-tests.outcome }}" == "success" ]; then
            echo "âœ… All Stripe contract tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some Stripe tests failed. Check the logs above." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Mode: stripe-mock (hermetic)" >> $GITHUB_STEP_SUMMARY
          echo "- stripe-mock URL: \`http://localhost:12111\`" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # JOB 3: Stripe Contract Tests (Live Test Mode) - Optional
  # ==========================================================================
  contract-stripe-live:
    name: ğŸ’³ Stripe Contract Tests (Live)
    runs-on: ubuntu-latest
    # Only run on manual dispatch with live mode enabled and secrets available
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.use_stripe_live == 'true'

    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ”§ Generate Prisma Client
        run: npx prisma generate

      - name: ğŸ’³ Run Stripe Contract Tests (Live Test Mode)
        env:
          USE_STRIPE_MOCK: "false"
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_TEST_SECRET_KEY }}
          NODE_ENV: test
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ’³ Running Stripe Contract Tests (Live Test Mode)         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          if [ -z "$STRIPE_SECRET_KEY" ]; then
            echo "âš ï¸ STRIPE_TEST_SECRET_KEY secret not configured. Skipping live tests."
            exit 0
          fi

          npm run test:contracts:stripe -- --ci

      - name: ğŸ“‹ Live Stripe Test Summary
        if: always()
        run: |
          echo "### ğŸ’³ Stripe Contract Tests (Live)" >> $GITHUB_STEP_SUMMARY
          echo "Tests ran against Stripe's live test mode API." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**âš ï¸ Note:** Live tests consume Stripe API rate limits." >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # JOB 4: Integration Tests Summary
  # ==========================================================================
  integration-summary:
    name: ğŸ“Š Integration Summary
    runs-on: ubuntu-latest
    needs: [integration-db, contract-stripe]
    if: always()

    steps:
      - name: ğŸ“Š Generate Summary
        run: |
          echo "# ğŸ§ª Integration & Contract Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Database Integration Tests
          echo "## ğŸ—„ï¸ Database Integration Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.integration-db.result }}" == "success" ]; then
            echo "âœ… **PASSED**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.integration-db.result }}" == "skipped" ]; then
            echo "â­ï¸ **SKIPPED** (skip-integration label)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Stripe Contract Tests
          echo "## ğŸ’³ Stripe Contract Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.contract-stripe.result }}" == "success" ]; then
            echo "âœ… **PASSED**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.contract-stripe.result }}" == "skipped" ]; then
            echo "â­ï¸ **SKIPPED** (skip-contracts label or manual skip)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.integration-db.result }}" == "success" ] && [ "${{ needs.contract-stripe.result }}" == "success" ]; then
            echo "ğŸ‰ **All integration and contract tests passed!**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.integration-db.result }}" == "skipped" ] && [ "${{ needs.contract-stripe.result }}" == "skipped" ]; then
            echo "â­ï¸ **All tests were skipped.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Some tests failed or were skipped. Review above.**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Workflow: Integration & Contract Tests*" >> $GITHUB_STEP_SUMMARY
          echo "*Triggered by: ${{ github.event_name }}*" >> $GITHUB_STEP_SUMMARY
          echo "*Commit: ${{ github.sha }}*" >> $GITHUB_STEP_SUMMARY

      - name: âœ… Check Overall Status
        if: |
          needs.integration-db.result == 'failure' ||
          needs.contract-stripe.result == 'failure'
        run: |
          echo "âŒ Integration or contract tests failed!"
          exit 1
