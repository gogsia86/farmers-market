name: ðŸŒŸ Divine CI/CD - Ultimate Pipeline

# Complete automated pipeline combining all quality gates
# Replaces: ci.yml, chromatic.yml, performance-tests.yml

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip test execution"
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: "20"
  CACHE_KEY_PREFIX: v1

jobs:
  # ============================================
  # JOB 1: CODE QUALITY VALIDATION
  # ============================================
  validate:
    name: ðŸ” Code Quality & Linting
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: âš¡ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ§¬ Setup Node.js with Caching
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: ðŸŽ¨ Run ESLint
        run: npm run lint

      - name: âš¡ TypeScript Type Check
        run: npx tsc --noEmit

      - name: ðŸ› ï¸  Check Prettier Formatting
        run: npm run format:check

      - name: ðŸ” Validate Divine Pattern Compliance
        run: npm run validate-patterns
        continue-on-error: true

  # ============================================
  # JOB 2: UNIT & INTEGRATION TESTS
  # ============================================
  test:
    name: ðŸ§ª Test Suite Execution
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: validate

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: ðŸ“¦ Install Dependencies

        run: npm ci --legacy-peer-deps

      - name: ðŸ§ª Run Test Suite
        if: ${{ !inputs.skip_tests }}

        run: npm run test -- --coverage

      - name: ðŸ“Š Upload Coverage to Codecov
        if: ${{ !inputs.skip_tests }}
        uses: codecov/codecov-action@v3
        with:
          files: ./farmers-market/coverage/coverage-final.json
          flags: unit-tests
          fail_ci_if_error: false

  # ============================================
  # JOB 3: BUILD VALIDATION
  # ============================================
  build:
    name: ðŸ—ï¸  Production Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [validate, test]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: ðŸ“¦ Install Dependencies

        run: npm ci --legacy-peer-deps

      - name: ðŸ—ï¸  Build Next.js Application

        env:
          NEXT_TELEMETRY_DISABLED: 1
          SKIP_ENV_VALIDATION: true
        run: npm run build

      - name: ðŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: next-build-${{ github.sha }}
          path: farmers-market/.next
          retention-days: 7

  # ============================================
  # JOB 4: VISUAL REGRESSION TESTING
  # ============================================
  visual-testing:
    name: ðŸŽ¨ Chromatic Visual Testing
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'pull_request'
    needs: validate

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for Chromatic

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: ðŸ“¦ Install Dependencies

        run: npm ci --legacy-peer-deps

      - name: ðŸŽ¨ Run Chromatic

        env:
          CHROMATIC_PROJECT_TOKEN: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
        run: |
          npx chromatic \
            --project-token=$CHROMATIC_PROJECT_TOKEN \
            --auto-accept-changes="main" \
            --exit-zero-on-changes \
            --only-changed

      - name: ðŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ðŸŽ¨ Chromatic Visual Testing

            âœ… Visual regression testing complete!

            ðŸ”— [View Visual Diffs](https://www.chromatic.com/builds?appId=68f10cd1bcfc5fb270e8f489)
            ðŸ“š [Live Storybook](https://68f10cd1bcfc5fb270e8f489-dhablktkwp.chromatic.com/)`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ============================================
  # JOB 5: PERFORMANCE TESTING
  # ============================================
  performance:
    name: âš¡ k6 Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    needs: build

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg \
            --keyserver hkp://keyserver.ubuntu.com:80 \
            --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | \
            sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: âš¡ Run Performance Tests
        run: |
          if [ -d "dist/performance-tests" ]; then
            k6 run dist/performance-tests/*.js
          else
            echo "âš ï¸  No performance tests found - skipping"
          fi

      - name: ðŸ“Š Upload Performance Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: performance-results-${{ github.sha }}
          path: |
            k6-summary.json
            k6-metrics.json
          retention-days: 30

  # ============================================
  # JOB 6: SECURITY SCANNING
  # ============================================
  security:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: validate

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ”’ npm Audit

        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: ðŸ” Dependency Review
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@v3

  # ============================================
  # JOB 7: PRODUCTION DEPLOYMENT
  # ============================================
  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [build, test, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://farmers-market.divine-platform.app

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: ðŸ“¦ Install Dependencies

        run: npm ci --legacy-peer-deps

      - name: ðŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v3
        with:
          name: next-build-${{ github.sha }}
          path: farmers-market/.next

      - name: ðŸ” Configure SSL Certificates
        env:
          SSL_PRIVATE_KEY: ${{ secrets.PROD_SSL_PRIVATE_KEY }}
          SSL_CERTIFICATE: ${{ secrets.PROD_SSL_CERTIFICATE }}
          SSL_CA: ${{ secrets.PROD_SSL_CA }}
        run: |
          mkdir -p ./ssl
          echo "$SSL_PRIVATE_KEY" > ./ssl/private.key
          echo "$SSL_CERTIFICATE" > ./ssl/certificate.crt
          echo "$SSL_CA" > ./ssl/ca.crt

      - name: ðŸš€ Deploy to Production

        env:
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
          NEXTAUTH_URL: ${{ secrets.PROD_NEXTAUTH_URL }}
          NEXTAUTH_SECRET: ${{ secrets.PROD_NEXTAUTH_SECRET }}
          REDIS_URL: ${{ secrets.PROD_REDIS_URL }}
          WEATHER_API_KEY: ${{ secrets.PROD_WEATHER_API_KEY }}
          ML_SERVICE_API_KEY: ${{ secrets.PROD_ML_SERVICE_API_KEY }}
          SENTRY_DSN: ${{ secrets.PROD_SENTRY_DSN }}
        run: |
          echo "ðŸš€ Deploying to production..."
          # Add your deployment command here
          # Example: npm run deploy

      - name: ðŸ“Š Notify Sentry of Deployment
        env:
          SENTRY_DSN: ${{ secrets.PROD_SENTRY_DSN }}
        run: |
          curl -X POST https://sentry.io/api/0/organizations/YOUR_ORG/releases/ \
            -H "Authorization: Bearer ${{ secrets.SENTRY_AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"version\": \"${{ github.sha }}\", \"projects\": [\"farmers-market\"]}" \
            || echo "âš ï¸  Sentry notification failed (non-critical)"

  # ============================================
  # JOB 8: SUMMARY & NOTIFICATIONS
  # ============================================
  summary:
    name: ðŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs:
      [validate, test, build, visual-testing, performance, security, deploy]
    if: always()

    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸŒŸ Divine CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- Validation: ${{ needs.validate.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Visual Testing: ${{ needs.visual-testing.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Performance: ${{ needs.performance.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deploy: ${{ needs.deploy.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
