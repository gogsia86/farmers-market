name: CD - Continuous Deployment

on:
  push:
    branches:
      - main
      - master
    tags:
      - "v*"

  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: "20"
  DOCKER_IMAGE: farmersmarket/app

jobs:
  # Job 1: Deploy to Staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.farmersmarket.app

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”‘ Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ—ï¸ Build and push staging image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/farmers-market:staging
            ${{ secrets.DOCKER_USERNAME }}/farmers-market:staging-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸš€ Deploy to staging server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/farmers-market
            docker-compose pull app
            docker-compose up -d app
            docker-compose exec -T app npx prisma migrate deploy
            docker system prune -f

      - name: ðŸ¥ Health check
        run: |
          sleep 10
          curl -f https://staging.farmersmarket.app/api/health || exit 1

      - name: ðŸ“¢ Notify deployment
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          text: "Staging deployment ${{ job.status }}"
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # Job 2: Deploy to Production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: |
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v')) &&
      (github.event.inputs.environment == 'production' || github.event.inputs.environment == '')
    environment:
      name: production
      url: https://farmersmarket.app
    needs: []

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”‘ Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ·ï¸ Get version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=latest" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ—ï¸ Build and push production image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/farmers-market:latest
            ${{ secrets.DOCKER_USERNAME }}/farmers-market:${{ steps.version.outputs.version }}
            ${{ secrets.DOCKER_USERNAME }}/farmers-market:prod-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ“¦ Create backup
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/farmers-market
            docker-compose exec -T postgres pg_dump -U farmersmarket farmersmarket > backup_$(date +%Y%m%d_%H%M%S).sql

      - name: ðŸš€ Deploy to production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/farmers-market
            docker-compose pull app
            docker-compose up -d app
            docker-compose exec -T app npx prisma migrate deploy
            docker system prune -f

      - name: ðŸ¥ Health check
        run: |
          sleep 15
          for i in {1..5}; do
            if curl -f https://farmersmarket.app/api/health; then
              echo "Health check passed"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 10
          done
          exit 1

      - name: ðŸ”„ Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/farmers-market
            docker-compose down app
            docker-compose up -d app

      - name: ðŸ“¢ Notify deployment
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          text: "Production deployment ${{ job.status }} - Version: ${{ steps.version.outputs.version }}"
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

      - name: ðŸ·ï¸ Create GitHub release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

  # Job 3: Database Migration (Production)
  migrate-production:
    name: Database Migration
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment:
      name: production

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ—„ï¸ Run migrations
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/farmers-market
            docker-compose exec -T app npx prisma migrate deploy

      - name: âœ… Verify migration
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/farmers-market
            docker-compose exec -T app npx prisma migrate status

  # Job 4: Smoke Tests (Production)
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-production

    steps:
      - name: ðŸ¥ API Health Check
        run: |
          curl -f https://farmersmarket.app/api/health

      - name: ðŸ” Auth Endpoint Check
        run: |
          curl -f https://farmersmarket.app/api/auth/signin

      - name: ðŸŒ¾ Farms Endpoint Check
        run: |
          curl -f https://farmersmarket.app/farms

      - name: ðŸ“ Verify SSL
        run: |
          curl -vI https://farmersmarket.app 2>&1 | grep "SSL certificate verify ok"
