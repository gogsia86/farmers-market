# üöÄ Vercel Database Setup Guide
**Farmers Market Platform - Vercel Deployment with Test Database**

Last Updated: 2026-01-09

---

## üìã Overview

This guide explains how to configure your Vercel deployment to use the same test database as your local environment, enabling you to run tests against your deployed application.

---

## üéØ Database Strategy

### **Option 1: Use Local Test Database (Recommended for Testing)**
- Connect Vercel preview deployments to your local test database
- Allows testing against known data
- Requires exposing local database to internet

### **Option 2: Use Cloud Database (Recommended for Production)**
- Set up PostgreSQL on Vercel Postgres, Supabase, or Neon
- Separate databases for preview and production
- Better security and performance

---

## üîß Option 1: Connect Vercel to Local Test Database

### **Step 1: Expose Your Local Database**

#### **Using ngrok (Easiest)**

```bash
# Install ngrok
npm install -g ngrok

# Expose PostgreSQL port
ngrok tcp 5433

# You'll get a URL like: tcp://0.tcp.ngrok.io:12345
```

#### **Using Cloudflare Tunnel**

```bash
# Install cloudflared
brew install cloudflare/cloudflare/cloudflared  # macOS
# or download from https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/

# Create tunnel
cloudflared tunnel create farmers-market-db

# Configure tunnel
cloudflared tunnel route dns farmers-market-db db.yourdomain.com

# Run tunnel
cloudflared tunnel --url tcp://localhost:5433 run farmers-market-db
```

### **Step 2: Configure Vercel Environment Variables**

#### **Via Vercel Dashboard**

1. Go to: https://vercel.com/your-team/farmers-market-platform
2. Click **Settings** ‚Üí **Environment Variables**
3. Add these variables:

**For Preview Deployments:**

```env
# Database Connection
DATABASE_URL=postgresql://postgres:test_password_123@0.tcp.ngrok.io:12345/farmersmarket_test
DIRECT_URL=postgresql://postgres:test_password_123@0.tcp.ngrok.io:12345/farmersmarket_test

# Application URLs (auto-generated by Vercel)
NEXT_PUBLIC_APP_URL=${VERCEL_URL}
NEXT_PUBLIC_API_URL=${VERCEL_URL}/api

# Authentication
NEXTAUTH_URL=${VERCEL_URL}
NEXTAUTH_SECRET=your-production-secret-minimum-32-characters-long-12345678

# Node Environment
NODE_ENV=production
PORT=3000

# Trust Host (required for Vercel)
AUTH_TRUST_HOST=true
VERCEL=1

# Skip validation during build
SKIP_ENV_VALIDATION=true
```

**Environment Selection:**
- ‚úÖ Preview
- ‚úÖ Development
- ‚ùå Production (use separate database)

#### **Via Vercel CLI**

```bash
# Install Vercel CLI
npm install -g vercel

# Login
vercel login

# Link project
vercel link

# Add environment variables
vercel env add DATABASE_URL preview
# Paste: postgresql://postgres:test_password_123@0.tcp.ngrok.io:12345/farmersmarket_test

vercel env add NEXTAUTH_SECRET preview
# Paste: your-production-secret-minimum-32-characters-long

vercel env add NEXTAUTH_URL preview
# Leave empty - Vercel will use VERCEL_URL

vercel env add AUTH_TRUST_HOST preview
# Enter: true

vercel env add SKIP_ENV_VALIDATION preview
# Enter: true
```

### **Step 3: Redeploy**

```bash
# Trigger new deployment
git push origin master

# Or manual deploy
vercel --prod
```

---

## üåê Option 2: Use Cloud PostgreSQL (Recommended)

### **A. Vercel Postgres (Easiest Integration)**

#### **Setup**

1. Go to Vercel Dashboard ‚Üí **Storage** ‚Üí **Create Database**
2. Select **Postgres**
3. Choose region (same as your Vercel app)
4. Database will auto-configure environment variables

#### **Environment Variables (Auto-Added)**

```env
POSTGRES_URL="************"
POSTGRES_PRISMA_URL="************"
POSTGRES_URL_NON_POOLING="************"
POSTGRES_USER="************"
POSTGRES_HOST="************"
POSTGRES_PASSWORD="************"
POSTGRES_DATABASE="************"
```

#### **Use in Prisma**

Update `schema.prisma`:

```prisma
datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL") // Uses connection pooling
  directUrl = env("POSTGRES_URL_NON_POOLING") // Uses direct connection
}
```

#### **Seed Database**

```bash
# Connect to Vercel Postgres
vercel env pull .env.vercel.local
source .env.vercel.local

# Run migrations
npx prisma migrate deploy

# Seed data
npm run db:seed
```

### **B. Supabase (Free Tier Available)**

#### **Setup**

1. Go to: https://supabase.com
2. Create new project
3. Note your database credentials

#### **Environment Variables**

```env
DATABASE_URL=postgresql://postgres.[PROJECT_REF]:[PASSWORD]@aws-0-us-east-1.pooler.supabase.com:5432/postgres
DIRECT_URL=postgresql://postgres.[PROJECT_REF]:[PASSWORD]@aws-0-us-east-1.pooler.supabase.com:5432/postgres
```

Add to Vercel:

```bash
vercel env add DATABASE_URL production
vercel env add DIRECT_URL production
```

#### **Enable PostGIS (Required for Location Features)**

```sql
-- In Supabase SQL Editor
CREATE EXTENSION IF NOT EXISTS postgis;
```

### **C. Neon (Serverless Postgres)**

#### **Setup**

1. Go to: https://neon.tech
2. Create new project
3. Copy connection string

#### **Environment Variables**

```env
DATABASE_URL=postgresql://[user]:[password]@[host]/[database]?sslmode=require
DIRECT_URL=postgresql://[user]:[password]@[host]/[database]?sslmode=require
```

#### **Features**

- ‚úÖ Serverless (scales to zero)
- ‚úÖ Branching (separate DB for each preview deployment)
- ‚úÖ Free tier: 512 MB storage

---

## üîê Security Considerations

### **For Local Database Exposure**

‚ö†Ô∏è **WARNING: Only use for testing, not production!**

- Use strong passwords
- Whitelist Vercel IP ranges (if possible)
- Use SSL/TLS connections
- Monitor access logs
- Rotate credentials regularly

### **Vercel IP Ranges**

Add these to your firewall whitelist:
```
76.76.21.0/24
76.76.22.0/24
```

### **SSL Configuration**

For cloud databases, always use SSL:

```env
DATABASE_URL=postgresql://user:pass@host:5432/db?sslmode=require
```

---

## üß™ Testing Configuration

### **Test Credentials on Vercel**

After deployment, verify authentication works:

```bash
# Test login API
curl -X POST https://your-app.vercel.app/api/auth/callback/credentials \
  -H "Content-Type: application/json" \
  -d '{
    "email": "farmer1@example.com",
    "password": "Farmer123!"
  }'

# Check session
curl https://your-app.vercel.app/api/auth/session
```

### **Run E2E Tests Against Vercel**

Update `playwright.config.ts`:

```typescript
export default defineConfig({
  use: {
    baseURL: process.env.VERCEL_URL
      ? `https://${process.env.VERCEL_URL}`
      : 'http://localhost:3001',
  },
});
```

Run tests:

```bash
# Set target URL
export BASE_URL=https://your-app.vercel.app

# Run tests
npm run test:e2e
```

---

## üìä Environment Variables Checklist

### **Required for All Environments**

- [ ] `DATABASE_URL` - PostgreSQL connection string
- [ ] `DIRECT_URL` - Direct PostgreSQL connection (for migrations)
- [ ] `NEXTAUTH_SECRET` - Random 32+ character string
- [ ] `NEXTAUTH_URL` - Full application URL
- [ ] `AUTH_TRUST_HOST` - Set to `true` for Vercel

### **Optional but Recommended**

- [ ] `NEXT_PUBLIC_APP_URL` - Public application URL
- [ ] `NEXT_PUBLIC_API_URL` - Public API URL
- [ ] `SENTRY_DSN` - Error tracking
- [ ] `SENTRY_AUTH_TOKEN` - Sentry authentication
- [ ] `STRIPE_SECRET_KEY` - Payment processing
- [ ] `STRIPE_WEBHOOK_SECRET` - Stripe webhooks
- [ ] `REDIS_URL` - Cache connection

### **Build-Time Only**

- [ ] `SKIP_ENV_VALIDATION` - Skip env validation during build
- [ ] `NODE_OPTIONS` - Node.js memory settings
- [ ] `TURBOPACK` - Enable/disable Turbopack

---

## üöÄ Deployment Workflow

### **1. Development ‚Üí Preview**

```bash
# Create feature branch
git checkout -b feature/new-feature

# Make changes
# ...

# Push to GitHub
git push origin feature/new-feature

# Vercel auto-deploys preview
# Uses preview environment variables
```

### **2. Preview ‚Üí Production**

```bash
# Merge to master
git checkout master
git merge feature/new-feature
git push origin master

# Vercel auto-deploys to production
# Uses production environment variables
```

---

## üîç Troubleshooting

### **Issue: "Can't reach database server"**

**Solution:**
- Check ngrok/tunnel is running
- Verify DATABASE_URL is correct
- Check firewall allows connections
- Test connection locally: `psql $DATABASE_URL`

### **Issue: "SSL connection required"**

**Solution:**
Add `?sslmode=require` to DATABASE_URL:
```env
DATABASE_URL=postgresql://user:pass@host:5432/db?sslmode=require
```

### **Issue: "Authentication failed"**

**Solution:**
- Verify password is correct
- Check user has access to database
- Ensure database exists
- Test credentials: `psql -U username -h host -d database`

### **Issue: "Prisma Client not generated"**

**Solution:**
```bash
# Force regenerate
npx prisma generate

# Redeploy
vercel --force
```

### **Issue: "Migration failed"**

**Solution:**
```bash
# Reset migrations (CAUTION: destroys data)
npx prisma migrate reset

# Or apply migrations manually
npx prisma migrate deploy
```

---

## üìù Quick Setup Script

Create `.vercel-setup.sh`:

```bash
#!/bin/bash

# Vercel Database Setup Script
echo "üöÄ Setting up Vercel environment variables..."

# Set project
vercel link

# Add environment variables
echo "üìù Adding DATABASE_URL..."
vercel env add DATABASE_URL preview

echo "üîê Adding NEXTAUTH_SECRET..."
vercel env add NEXTAUTH_SECRET preview

echo "üåê Adding AUTH_TRUST_HOST..."
echo "true" | vercel env add AUTH_TRUST_HOST preview

echo "‚úÖ Adding SKIP_ENV_VALIDATION..."
echo "true" | vercel env add SKIP_ENV_VALIDATION preview

echo "‚úÖ Environment variables configured!"
echo "üöÄ Deploy with: vercel --prod"
```

Run:
```bash
chmod +x .vercel-setup.sh
./.vercel-setup.sh
```

---

## üéØ Recommended Configuration

For best results, use this setup:

**Local Development:**
- Database: `localhost:5433`
- Credentials: From `.env.test`
- Seeded data: Test accounts

**Vercel Preview:**
- Database: Supabase/Neon (separate from production)
- Credentials: Same as local test database
- Seeded data: Copy of test data

**Vercel Production:**
- Database: Vercel Postgres or Supabase Pro
- Credentials: Unique production credentials
- Seeded data: Minimal admin account only

---

## üìû Support

**Database Issues:**
- Vercel Postgres: https://vercel.com/docs/storage/vercel-postgres
- Supabase: https://supabase.com/docs
- Neon: https://neon.tech/docs

**Deployment Issues:**
- Vercel Support: https://vercel.com/support
- GitHub Issues: https://github.com/your-repo/issues

---

## ‚úÖ Final Checklist

Before deploying:

- [ ] Database is accessible from Vercel
- [ ] All environment variables are set
- [ ] Database is seeded with test data
- [ ] Migrations are applied
- [ ] Test credentials work locally
- [ ] SSL is configured (if required)
- [ ] Firewall allows Vercel IPs
- [ ] NEXTAUTH_SECRET is unique and secure
- [ ] Backup strategy is in place

**Ready to deploy!** üéâ

---

*Last Updated: January 9, 2026*
*Version: 1.0*
