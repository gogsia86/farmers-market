8d0ce746d3d485f525b40dfa4ddb8293
"use strict";
/**
 * GPU IMAGE PROCESSOR
 * RTX 2070 Max-Q Optimized Image Processing with fallbacks
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.GPUImageProcessor = void 0;
exports.getGPUProcessor = getGPUProcessor;
exports.processImageGPU = processImageGPU;
let tf;
let GPU;
try {
    tf = require("@tensorflow/tfjs-node-gpu");
}
catch {
    try {
        tf = require("@tensorflow/tfjs");
        require("@tensorflow/tfjs-backend-webgl");
    }
    catch {
        tf = require("@tensorflow/tfjs");
    }
}
try {
    GPU = require("gpu.js").GPU;
}
catch {
    // Fallback mock GPU class for when gpu.js is not available
    GPU = class MockGPU {
        createKernel() {
            // Return a serializable mock kernel object instead of a function
            return {
                setOutput: () => ({ setPipeline: () => ({}) }),
                setConstants: () => ({}),
                setPipeline: () => ({}),
                destroy: () => { },
                __isMock: true,
            };
        }
    };
}
class GPUImageProcessor {
    gpu = null;
    initialized = false;
    constructor() {
        // GPU initialization moved to initialize() for serialization compatibility
    }
    getGPU() {
        if (!this.gpu) {
            this.gpu = new GPU({
                mode: "gpu", // Force GPU mode for RTX 2070 Max-Q
            });
        }
        return this.gpu;
    }
    async initialize() {
        if (this.initialized)
            return;
        try {
            // Initialize TensorFlow.js GPU backend
            await tf.setBackend("tensorflow");
            await tf.ready();
            console.log("ðŸš€ GPU Image Processor initialized");
            console.log("   Backend:", tf.getBackend());
            console.log("   CUDA enabled:", await tf.env().getBool("WEBGL_VERSION"));
            this.initialized = true;
        }
        catch (error) {
            console.error("âŒ GPU initialization failed:", error);
            throw new Error("Failed to initialize GPU image processor");
        }
    }
    /**
     * DIVINE IMAGE RESIZE WITH GPU ACCELERATION
     * Uses RTX 2070 Max-Q for parallel pixel processing
     */
    async resizeImage(imageBuffer, width, height) {
        const startTime = performance.now();
        try {
            // Convert buffer to tensor
            const imageTensor = tf.node.decodeImage(imageBuffer, 3);
            // GPU-accelerated resize using bilinear interpolation
            const resized = tf.image.resizeBilinear(imageTensor, [height, width], true // alignCorners for better quality
            );
            // Convert back to buffer
            const buffer = await tf.node.encodeJpeg(resized, "rgb", 90);
            // Cleanup tensors
            imageTensor.dispose();
            resized.dispose();
            const processingTime = performance.now() - startTime;
            return {
                buffer: Buffer.from(buffer),
                width,
                height,
                format: "jpeg",
                processingTime,
            };
        }
        catch (error) {
            console.error("GPU resize failed:", error);
            throw error;
        }
    }
    /**
     * QUANTUM BATCH IMAGE PROCESSING
     * Process multiple images in parallel using GPU
     */
    async processBatch(images, options = {}) {
        const startTime = performance.now();
        const { width = 800, height = 600, quality = 85, format = "webp", } = options;
        try {
            // Process all images in parallel on GPU
            const results = await Promise.all(images.map(async (imageBuffer) => {
                return await this.resizeImage(imageBuffer, width, height);
            }));
            const totalTime = performance.now() - startTime;
            console.log(`âœ… Processed ${images.length} images in ${totalTime.toFixed(2)}ms`);
            console.log(`   Average: ${(totalTime / images.length).toFixed(2)}ms per image`);
            return results;
        }
        catch (error) {
            console.error("Batch processing failed:", error);
            throw error;
        }
    }
    /**
     * DIVINE IMAGE ENHANCEMENT
     * GPU-accelerated brightness, contrast, saturation adjustment
     */
    async enhanceImage(imageBuffer, brightness = 1.0, contrast = 1.0, saturation = 1.0) {
        const startTime = performance.now();
        try {
            const imageTensor = tf.node.decodeImage(imageBuffer, 3);
            // GPU-accelerated enhancement
            let enhanced = imageTensor;
            // Brightness adjustment
            if (brightness !== 1.0) {
                enhanced = tf.mul(enhanced, brightness);
            }
            // Contrast adjustment
            if (contrast !== 1.0) {
                const mean = enhanced.mean();
                enhanced = tf.add(tf.mul(tf.sub(enhanced, mean), contrast), mean);
            }
            // Saturation adjustment (convert to HSV, adjust S, convert back)
            if (saturation !== 1.0) {
                // Simplified saturation (for performance)
                const gray = enhanced.mean(-1, true);
                enhanced = tf.add(tf.mul(enhanced, saturation), tf.mul(gray, 1 - saturation));
            }
            // Clamp values to [0, 255]
            enhanced = tf.clipByValue(enhanced, 0, 255);
            const buffer = await tf.node.encodeJpeg(enhanced, "rgb", 90);
            // Cleanup
            imageTensor.dispose();
            enhanced.dispose();
            const processingTime = performance.now() - startTime;
            return {
                buffer: Buffer.from(buffer),
                width: imageTensor.shape[1],
                height: imageTensor.shape[0],
                format: "jpeg",
                processingTime,
            };
        }
        catch (error) {
            console.error("GPU enhancement failed:", error);
            throw error;
        }
    }
    /**
     * GPU MEMORY CLEANUP
     */
    dispose() {
        tf.disposeVariables();
        this.initialized = false;
        console.log("ðŸ§¹ GPU resources cleaned up");
    }
}
exports.GPUImageProcessor = GPUImageProcessor;
// Singleton instance
let gpuProcessor = null;
async function getGPUProcessor() {
    if (!gpuProcessor) {
        gpuProcessor = new GPUImageProcessor();
        await gpuProcessor.initialize();
    }
    return gpuProcessor;
}
/**
 * DIVINE CONVENIENCE FUNCTION
 * One-line GPU image processing
 */
async function processImageGPU(imageBuffer, options = {}) {
    const processor = await getGPUProcessor();
    const { width = 800, height = 600 } = options;
    return await processor.resizeImage(imageBuffer, width, height);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiTTpcXFJlcG9cXEZhcm1lcnMgTWFya2V0IFBsYXRmb3JtIHdlYiBhbmQgYXBwXFxzcmNcXGxpYlxcZ3B1XFxpbWFnZS1wcm9jZXNzb3IudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7O0FBeVBILDBDQU1DO0FBTUQsMENBT0M7QUExUUQsSUFBSSxFQUFPLENBQUM7QUFDWixJQUFJLEdBQVEsQ0FBQztBQUViLElBQUksQ0FBQztJQUNILEVBQUUsR0FBRyxPQUFPLENBQUMsMkJBQTJCLENBQUMsQ0FBQztBQUM1QyxDQUFDO0FBQUMsTUFBTSxDQUFDO0lBQ1AsSUFBSSxDQUFDO1FBQ0gsRUFBRSxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQ2pDLE9BQU8sQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFBQyxNQUFNLENBQUM7UUFDUCxFQUFFLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFDbkMsQ0FBQztBQUNILENBQUM7QUFFRCxJQUFJLENBQUM7SUFDSCxHQUFHLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsQ0FBQztBQUM5QixDQUFDO0FBQUMsTUFBTSxDQUFDO0lBQ1AsMkRBQTJEO0lBQzNELEdBQUcsR0FBRyxNQUFNLE9BQU87UUFDakIsWUFBWTtZQUNWLGlFQUFpRTtZQUNqRSxPQUFPO2dCQUNMLFNBQVMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsV0FBVyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQztnQkFDOUMsWUFBWSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDO2dCQUN4QixXQUFXLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUM7Z0JBQ3ZCLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRSxDQUFDO2dCQUNqQixRQUFRLEVBQUUsSUFBSTthQUNmLENBQUM7UUFDSixDQUFDO0tBQ0YsQ0FBQztBQUNKLENBQUM7QUFrQkQsTUFB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QyxNQUFNLFNBQVMsR0FBRyxNQUFNLGVBQWUsRUFBRSxDQUFDO0lBQzFDLE1BQU0sRUFBRSxLQUFLLEdBQUcsR0FBRyxFQUFFLE1BQU0sR0FBRyxHQUFHLEVBQUUsR0FBRyxPQUFPLENBQUM7SUFDOUMsT0FBTyxNQUFNLFNBQVMsQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztBQUNqRSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIk06XFxSZXBvXFxGYXJtZXJzIE1hcmtldCBQbGF0Zm9ybSB3ZWIgYW5kIGFwcFxcc3JjXFxsaWJcXGdwdVxcaW1hZ2UtcHJvY2Vzc29yLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogR1BVIElNQUdFIFBST0NFU1NPUlxuICogUlRYIDIwNzAgTWF4LVEgT3B0aW1pemVkIEltYWdlIFByb2Nlc3Npbmcgd2l0aCBmYWxsYmFja3NcbiAqL1xuXG5sZXQgdGY6IGFueTtcbmxldCBHUFU6IGFueTtcblxudHJ5IHtcbiAgdGYgPSByZXF1aXJlKFwiQHRlbnNvcmZsb3cvdGZqcy1ub2RlLWdwdVwiKTtcbn0gY2F0Y2gge1xuICB0cnkge1xuICAgIHRmID0gcmVxdWlyZShcIkB0ZW5zb3JmbG93L3RmanNcIik7XG4gICAgcmVxdWlyZShcIkB0ZW5zb3JmbG93L3RmanMtYmFja2VuZC13ZWJnbFwiKTtcbiAgfSBjYXRjaCB7XG4gICAgdGYgPSByZXF1aXJlKFwiQHRlbnNvcmZsb3cvdGZqc1wiKTtcbiAgfVxufVxuXG50cnkge1xuICBHUFUgPSByZXF1aXJlKFwiZ3B1LmpzXCIpLkdQVTtcbn0gY2F0Y2gge1xuICAvLyBGYWxsYmFjayBtb2NrIEdQVSBjbGFzcyBmb3Igd2hlbiBncHUuanMgaXMgbm90IGF2YWlsYWJsZVxuICBHUFUgPSBjbGFzcyBNb2NrR1BVIHtcbiAgICBjcmVhdGVLZXJuZWwoKSB7XG4gICAgICAvLyBSZXR1cm4gYSBzZXJpYWxpemFibGUgbW9jayBrZXJuZWwgb2JqZWN0IGluc3RlYWQgb2YgYSBmdW5jdGlvblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc2V0T3V0cHV0OiAoKSA9PiAoeyBzZXRQaXBlbGluZTogKCkgPT4gKHt9KSB9KSxcbiAgICAgICAgc2V0Q29uc3RhbnRzOiAoKSA9PiAoe30pLFxuICAgICAgICBzZXRQaXBlbGluZTogKCkgPT4gKHt9KSxcbiAgICAgICAgZGVzdHJveTogKCkgPT4ge30sXG4gICAgICAgIF9faXNNb2NrOiB0cnVlLFxuICAgICAgfTtcbiAgICB9XG4gIH07XG59XG5cbmludGVyZmFjZSBJbWFnZVByb2Nlc3NpbmdPcHRpb25zIHtcbiAgd2lkdGg/OiBudW1iZXI7XG4gIGhlaWdodD86IG51bWJlcjtcbiAgcXVhbGl0eT86IG51bWJlcjtcbiAgZm9ybWF0PzogXCJ3ZWJwXCIgfCBcImpwZWdcIiB8IFwicG5nXCI7XG4gIG9wdGltaXplPzogYm9vbGVhbjtcbn1cblxuaW50ZXJmYWNlIFByb2Nlc3NlZEltYWdlIHtcbiAgYnVmZmVyOiBCdWZmZXI7XG4gIHdpZHRoOiBudW1iZXI7XG4gIGhlaWdodDogbnVtYmVyO1xuICBmb3JtYXQ6IHN0cmluZztcbiAgcHJvY2Vzc2luZ1RpbWU6IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIEdQVUltYWdlUHJvY2Vzc29yIHtcbiAgcHJpdmF0ZSBncHU6IGFueSA9IG51bGw7XG4gIHByaXZhdGUgaW5pdGlhbGl6ZWQ6IGJvb2xlYW4gPSBmYWxzZTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICAvLyBHUFUgaW5pdGlhbGl6YXRpb24gbW92ZWQgdG8gaW5pdGlhbGl6ZSgpIGZvciBzZXJpYWxpemF0aW9uIGNvbXBhdGliaWxpdHlcbiAgfVxuXG4gIHByaXZhdGUgZ2V0R1BVKCk6IGFueSB7XG4gICAgaWYgKCF0aGlzLmdwdSkge1xuICAgICAgdGhpcy5ncHUgPSBuZXcgR1BVKHtcbiAgICAgICAgbW9kZTogXCJncHVcIiwgLy8gRm9yY2UgR1BVIG1vZGUgZm9yIFJUWCAyMDcwIE1heC1RXG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZ3B1O1xuICB9XG5cbiAgYXN5bmMgaW5pdGlhbGl6ZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAodGhpcy5pbml0aWFsaXplZCkgcmV0dXJuO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIEluaXRpYWxpemUgVGVuc29yRmxvdy5qcyBHUFUgYmFja2VuZFxuICAgICAgYXdhaXQgdGYuc2V0QmFja2VuZChcInRlbnNvcmZsb3dcIik7XG4gICAgICBhd2FpdCB0Zi5yZWFkeSgpO1xuXG4gICAgICBjb25zb2xlLmxvZyhcIvCfmoAgR1BVIEltYWdlIFByb2Nlc3NvciBpbml0aWFsaXplZFwiKTtcbiAgICAgIGNvbnNvbGUubG9nKFwiICAgQmFja2VuZDpcIiwgdGYuZ2V0QmFja2VuZCgpKTtcbiAgICAgIGNvbnNvbGUubG9nKFwiICAgQ1VEQSBlbmFibGVkOlwiLCBhd2FpdCB0Zi5lbnYoKS5nZXRCb29sKFwiV0VCR0xfVkVSU0lPTlwiKSk7XG5cbiAgICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwi4p2MIEdQVSBpbml0aWFsaXphdGlvbiBmYWlsZWQ6XCIsIGVycm9yKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkZhaWxlZCB0byBpbml0aWFsaXplIEdQVSBpbWFnZSBwcm9jZXNzb3JcIik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIERJVklORSBJTUFHRSBSRVNJWkUgV0lUSCBHUFUgQUNDRUxFUkFUSU9OXG4gICAqIFVzZXMgUlRYIDIwNzAgTWF4LVEgZm9yIHBhcmFsbGVsIHBpeGVsIHByb2Nlc3NpbmdcbiAgICovXG4gIGFzeW5jIHJlc2l6ZUltYWdlKFxuICAgIGltYWdlQnVmZmVyOiBCdWZmZXIsXG4gICAgd2lkdGg6IG51bWJlcixcbiAgICBoZWlnaHQ6IG51bWJlclxuICApOiBQcm9taXNlPFByb2Nlc3NlZEltYWdlPiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7XG5cbiAgICB0cnkge1xuICAgICAgLy8gQ29udmVydCBidWZmZXIgdG8gdGVuc29yXG4gICAgICBjb25zdCBpbWFnZVRlbnNvciA9IHRmLm5vZGUuZGVjb2RlSW1hZ2UoaW1hZ2VCdWZmZXIsIDMpO1xuXG4gICAgICAvLyBHUFUtYWNjZWxlcmF0ZWQgcmVzaXplIHVzaW5nIGJpbGluZWFyIGludGVycG9sYXRpb25cbiAgICAgIGNvbnN0IHJlc2l6ZWQgPSB0Zi5pbWFnZS5yZXNpemVCaWxpbmVhcihcbiAgICAgICAgaW1hZ2VUZW5zb3IsXG4gICAgICAgIFtoZWlnaHQsIHdpZHRoXSxcbiAgICAgICAgdHJ1ZSAvLyBhbGlnbkNvcm5lcnMgZm9yIGJldHRlciBxdWFsaXR5XG4gICAgICApO1xuXG4gICAgICAvLyBDb252ZXJ0IGJhY2sgdG8gYnVmZmVyXG4gICAgICBjb25zdCBidWZmZXIgPSBhd2FpdCB0Zi5ub2RlLmVuY29kZUpwZWcoXG4gICAgICAgIHJlc2l6ZWQsXG4gICAgICAgIFwicmdiXCIsXG4gICAgICAgIDkwXG4gICAgICApO1xuXG4gICAgICAvLyBDbGVhbnVwIHRlbnNvcnNcbiAgICAgIGltYWdlVGVuc29yLmRpc3Bvc2UoKTtcbiAgICAgIHJlc2l6ZWQuZGlzcG9zZSgpO1xuXG4gICAgICBjb25zdCBwcm9jZXNzaW5nVGltZSA9IHBlcmZvcm1hbmNlLm5vdygpIC0gc3RhcnRUaW1lO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBidWZmZXI6IEJ1ZmZlci5mcm9tKGJ1ZmZlciksXG4gICAgICAgIHdpZHRoLFxuICAgICAgICBoZWlnaHQsXG4gICAgICAgIGZvcm1hdDogXCJqcGVnXCIsXG4gICAgICAgIHByb2Nlc3NpbmdUaW1lLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcIkdQVSByZXNpemUgZmFpbGVkOlwiLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUVVBTlRVTSBCQVRDSCBJTUFHRSBQUk9DRVNTSU5HXG4gICAqIFByb2Nlc3MgbXVsdGlwbGUgaW1hZ2VzIGluIHBhcmFsbGVsIHVzaW5nIEdQVVxuICAgKi9cbiAgYXN5bmMgcHJvY2Vzc0JhdGNoKFxuICAgIGltYWdlczogQnVmZmVyW10sXG4gICAgb3B0aW9uczogSW1hZ2VQcm9jZXNzaW5nT3B0aW9ucyA9IHt9XG4gICk6IFByb21pc2U8UHJvY2Vzc2VkSW1hZ2VbXT4ge1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpO1xuICAgIGNvbnN0IHtcbiAgICAgIHdpZHRoID0gODAwLFxuICAgICAgaGVpZ2h0ID0gNjAwLFxuICAgICAgcXVhbGl0eSA9IDg1LFxuICAgICAgZm9ybWF0ID0gXCJ3ZWJwXCIsXG4gICAgfSA9IG9wdGlvbnM7XG5cbiAgICB0cnkge1xuICAgICAgLy8gUHJvY2VzcyBhbGwgaW1hZ2VzIGluIHBhcmFsbGVsIG9uIEdQVVxuICAgICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICBpbWFnZXMubWFwKGFzeW5jIChpbWFnZUJ1ZmZlcikgPT4ge1xuICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnJlc2l6ZUltYWdlKGltYWdlQnVmZmVyLCB3aWR0aCwgaGVpZ2h0KTtcbiAgICAgICAgfSlcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IHRvdGFsVGltZSA9IHBlcmZvcm1hbmNlLm5vdygpIC0gc3RhcnRUaW1lO1xuICAgICAgY29uc29sZS5sb2coXG4gICAgICAgIGDinIUgUHJvY2Vzc2VkICR7aW1hZ2VzLmxlbmd0aH0gaW1hZ2VzIGluICR7dG90YWxUaW1lLnRvRml4ZWQoMil9bXNgXG4gICAgICApO1xuICAgICAgY29uc29sZS5sb2coXG4gICAgICAgIGAgICBBdmVyYWdlOiAkeyh0b3RhbFRpbWUgLyBpbWFnZXMubGVuZ3RoKS50b0ZpeGVkKDIpfW1zIHBlciBpbWFnZWBcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiByZXN1bHRzO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiQmF0Y2ggcHJvY2Vzc2luZyBmYWlsZWQ6XCIsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBESVZJTkUgSU1BR0UgRU5IQU5DRU1FTlRcbiAgICogR1BVLWFjY2VsZXJhdGVkIGJyaWdodG5lc3MsIGNvbnRyYXN0LCBzYXR1cmF0aW9uIGFkanVzdG1lbnRcbiAgICovXG4gIGFzeW5jIGVuaGFuY2VJbWFnZShcbiAgICBpbWFnZUJ1ZmZlcjogQnVmZmVyLFxuICAgIGJyaWdodG5lc3M6IG51bWJlciA9IDEuMCxcbiAgICBjb250cmFzdDogbnVtYmVyID0gMS4wLFxuICAgIHNhdHVyYXRpb246IG51bWJlciA9IDEuMFxuICApOiBQcm9taXNlPFByb2Nlc3NlZEltYWdlPiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgaW1hZ2VUZW5zb3IgPSB0Zi5ub2RlLmRlY29kZUltYWdlKGltYWdlQnVmZmVyLCAzKTtcblxuICAgICAgLy8gR1BVLWFjY2VsZXJhdGVkIGVuaGFuY2VtZW50XG4gICAgICBsZXQgZW5oYW5jZWQgPSBpbWFnZVRlbnNvcjtcblxuICAgICAgLy8gQnJpZ2h0bmVzcyBhZGp1c3RtZW50XG4gICAgICBpZiAoYnJpZ2h0bmVzcyAhPT0gMS4wKSB7XG4gICAgICAgIGVuaGFuY2VkID0gdGYubXVsKGVuaGFuY2VkLCBicmlnaHRuZXNzKTtcbiAgICAgIH1cblxuICAgICAgLy8gQ29udHJhc3QgYWRqdXN0bWVudFxuICAgICAgaWYgKGNvbnRyYXN0ICE9PSAxLjApIHtcbiAgICAgICAgY29uc3QgbWVhbiA9IGVuaGFuY2VkLm1lYW4oKTtcbiAgICAgICAgZW5oYW5jZWQgPSB0Zi5hZGQodGYubXVsKHRmLnN1YihlbmhhbmNlZCwgbWVhbiksIGNvbnRyYXN0KSwgbWVhbik7XG4gICAgICB9XG5cbiAgICAgIC8vIFNhdHVyYXRpb24gYWRqdXN0bWVudCAoY29udmVydCB0byBIU1YsIGFkanVzdCBTLCBjb252ZXJ0IGJhY2spXG4gICAgICBpZiAoc2F0dXJhdGlvbiAhPT0gMS4wKSB7XG4gICAgICAgIC8vIFNpbXBsaWZpZWQgc2F0dXJhdGlvbiAoZm9yIHBlcmZvcm1hbmNlKVxuICAgICAgICBjb25zdCBncmF5ID0gZW5oYW5jZWQubWVhbigtMSwgdHJ1ZSk7XG4gICAgICAgIGVuaGFuY2VkID0gdGYuYWRkKFxuICAgICAgICAgIHRmLm11bChlbmhhbmNlZCwgc2F0dXJhdGlvbiksXG4gICAgICAgICAgdGYubXVsKGdyYXksIDEgLSBzYXR1cmF0aW9uKVxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBDbGFtcCB2YWx1ZXMgdG8gWzAsIDI1NV1cbiAgICAgIGVuaGFuY2VkID0gdGYuY2xpcEJ5VmFsdWUoZW5oYW5jZWQsIDAsIDI1NSk7XG5cbiAgICAgIGNvbnN0IGJ1ZmZlciA9IGF3YWl0IHRmLm5vZGUuZW5jb2RlSnBlZyhlbmhhbmNlZCwgXCJyZ2JcIiwgOTApO1xuXG4gICAgICAvLyBDbGVhbnVwXG4gICAgICBpbWFnZVRlbnNvci5kaXNwb3NlKCk7XG4gICAgICBlbmhhbmNlZC5kaXNwb3NlKCk7XG5cbiAgICAgIGNvbnN0IHByb2Nlc3NpbmdUaW1lID0gcGVyZm9ybWFuY2Uubm93KCkgLSBzdGFydFRpbWU7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIGJ1ZmZlcjogQnVmZmVyLmZyb20oYnVmZmVyKSxcbiAgICAgICAgd2lkdGg6IGltYWdlVGVuc29yLnNoYXBlWzFdLFxuICAgICAgICBoZWlnaHQ6IGltYWdlVGVuc29yLnNoYXBlWzBdLFxuICAgICAgICBmb3JtYXQ6IFwianBlZ1wiLFxuICAgICAgICBwcm9jZXNzaW5nVGltZSxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJHUFUgZW5oYW5jZW1lbnQgZmFpbGVkOlwiLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR1BVIE1FTU9SWSBDTEVBTlVQXG4gICAqL1xuICBkaXNwb3NlKCk6IHZvaWQge1xuICAgIHRmLmRpc3Bvc2VWYXJpYWJsZXMoKTtcbiAgICB0aGlzLmluaXRpYWxpemVkID0gZmFsc2U7XG4gICAgY29uc29sZS5sb2coXCLwn6e5IEdQVSByZXNvdXJjZXMgY2xlYW5lZCB1cFwiKTtcbiAgfVxufVxuXG4vLyBTaW5nbGV0b24gaW5zdGFuY2VcbmxldCBncHVQcm9jZXNzb3I6IEdQVUltYWdlUHJvY2Vzc29yIHwgbnVsbCA9IG51bGw7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRHUFVQcm9jZXNzb3IoKTogUHJvbWlzZTxHUFVJbWFnZVByb2Nlc3Nvcj4ge1xuICBpZiAoIWdwdVByb2Nlc3Nvcikge1xuICAgIGdwdVByb2Nlc3NvciA9IG5ldyBHUFVJbWFnZVByb2Nlc3NvcigpO1xuICAgIGF3YWl0IGdwdVByb2Nlc3Nvci5pbml0aWFsaXplKCk7XG4gIH1cbiAgcmV0dXJuIGdwdVByb2Nlc3Nvcjtcbn1cblxuLyoqXG4gKiBESVZJTkUgQ09OVkVOSUVOQ0UgRlVOQ1RJT05cbiAqIE9uZS1saW5lIEdQVSBpbWFnZSBwcm9jZXNzaW5nXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwcm9jZXNzSW1hZ2VHUFUoXG4gIGltYWdlQnVmZmVyOiBCdWZmZXIsXG4gIG9wdGlvbnM6IEltYWdlUHJvY2Vzc2luZ09wdGlvbnMgPSB7fVxuKTogUHJvbWlzZTxQcm9jZXNzZWRJbWFnZT4ge1xuICBjb25zdCBwcm9jZXNzb3IgPSBhd2FpdCBnZXRHUFVQcm9jZXNzb3IoKTtcbiAgY29uc3QgeyB3aWR0aCA9IDgwMCwgaGVpZ2h0ID0gNjAwIH0gPSBvcHRpb25zO1xuICByZXR1cm4gYXdhaXQgcHJvY2Vzc29yLnJlc2l6ZUltYWdlKGltYWdlQnVmZmVyLCB3aWR0aCwgaGVpZ2h0KTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==