{"file":"M:\\Repo\\Farmers Market Platform web and app\\src\\lib\\ml\\recommendation-engine.ts","mappings":"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","names":[],"sources":["M:\\Repo\\Farmers Market Platform web and app\\src\\lib\\ml\\recommendation-engine.ts"],"sourcesContent":["/**\n * ML RECOMMENDATION ENGINE\n * GPU-accelerated collaborative filtering with browser fallback\n */\n\nlet tf: any;\ntry {\n  // Try to use GPU version if available\n  tf = require(\"@tensorflow/tfjs-node-gpu\");\n} catch {\n  try {\n    // Fallback to regular tfjs with WebGL backend\n    tf = require(\"@tensorflow/tfjs\");\n    require(\"@tensorflow/tfjs-backend-webgl\");\n  } catch {\n    // If all fails, use CPU backend\n    tf = require(\"@tensorflow/tfjs\");\n  }\n}\n\ninterface Product {\n  id: string;\n  name: string;\n  category: string;\n  price: number;\n  farmId: string;\n  seasonal: boolean;\n  organic: boolean;\n  tags: string[];\n}\n\ninterface UserPreferences {\n  userId: string;\n  viewedProducts: string[];\n  purchasedProducts: string[];\n  favoriteCategories: string[];\n  priceRange: { min: number; max: number };\n  preferOrganic: boolean;\n}\n\ninterface Recommendation {\n  productId: string;\n  score: number;\n  reason: string;\n}\n\nexport class GPURecommendationEngine {\n  private model: tf.LayersModel | null = null;\n  private productEmbeddings: Map<string, tf.Tensor> = new Map();\n  private initialized: boolean = false;\n\n  async initialize(): Promise<void> {\n    if (this.initialized) return;\n\n    try {\n      await tf.setBackend(\"tensorflow\");\n      await tf.ready();\n\n      console.log(\"ðŸ§  ML Recommendation Engine initialized\");\n      console.log(\"   Backend:\", tf.getBackend());\n      console.log(\n        \"   GPU available:\",\n        tf.env().getBool(\"IS_BROWSER\") === false\n      );\n\n      // Build simple neural network for collaborative filtering\n      this.model = this.buildRecommendationModel();\n\n      this.initialized = true;\n    } catch (error) {\n      console.error(\"âŒ ML engine initialization failed:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * BUILD RECOMMENDATION MODEL\n   * Simple neural network for collaborative filtering\n   */\n  private buildRecommendationModel(): tf.LayersModel {\n    const model = tf.sequential({\n      layers: [\n        // Input layer: user preferences + product features\n        tf.layers.dense({\n          inputShape: [20], // 20 features\n          units: 64,\n          activation: \"relu\",\n          kernelInitializer: \"heNormal\",\n        }),\n\n        // Hidden layers with dropout for regularization\n        tf.layers.dropout({ rate: 0.2 }),\n        tf.layers.dense({ units: 32, activation: \"relu\" }),\n        tf.layers.dropout({ rate: 0.2 }),\n        tf.layers.dense({ units: 16, activation: \"relu\" }),\n\n        // Output layer: recommendation score\n        tf.layers.dense({ units: 1, activation: \"sigmoid\" }),\n      ],\n    });\n\n    model.compile({\n      optimizer: tf.train.adam(0.001),\n      loss: \"binaryCrossentropy\",\n      metrics: [\"accuracy\"],\n    });\n\n    return model;\n  }\n\n  /**\n   * DIVINE PRODUCT ENCODING\n   * Convert product features to tensor representation\n   */\n  private encodeProduct(product: Product): tf.Tensor {\n    const features = [\n      // Price normalized (0-1)\n      Math.min(product.price / 100, 1),\n\n      // Boolean features\n      product.seasonal ? 1 : 0,\n      product.organic ? 1 : 0,\n\n      // Category one-hot encoding (simplified)\n      product.category === \"VEGETABLES\" ? 1 : 0,\n      product.category === \"FRUITS\" ? 1 : 0,\n      product.category === \"DAIRY\" ? 1 : 0,\n      product.category === \"MEAT\" ? 1 : 0,\n\n      // Tag features (top 13 common tags)\n      ...this.encodeTagsToVector(product.tags, 13),\n    ];\n\n    return tf.tensor1d(features);\n  }\n\n  /**\n   * ENCODE USER PREFERENCES\n   */\n  private encodeUserPreferences(prefs: UserPreferences): tf.Tensor {\n    const features = [\n      // Purchase history count (normalized)\n      Math.min(prefs.purchasedProducts.length / 50, 1),\n\n      // View history count (normalized)\n      Math.min(prefs.viewedProducts.length / 100, 1),\n\n      // Price preference (normalized)\n      Math.min(prefs.priceRange.min / 100, 1),\n      Math.min(prefs.priceRange.max / 100, 1),\n\n      // Organic preference\n      prefs.preferOrganic ? 1 : 0,\n\n      // Favorite categories (simplified)\n      prefs.favoriteCategories.includes(\"VEGETABLES\") ? 1 : 0,\n      prefs.favoriteCategories.includes(\"FRUITS\") ? 1 : 0,\n      prefs.favoriteCategories.includes(\"DAIRY\") ? 1 : 0,\n\n      // Padding to match product encoding length\n      ...Array(12).fill(0),\n    ];\n\n    return tf.tensor1d(features);\n  }\n\n  /**\n   * ENCODE TAGS TO VECTOR\n   */\n  private encodeTagsToVector(tags: string[], targetLength: number): number[] {\n    const commonTags = [\n      \"fresh\",\n      \"local\",\n      \"organic\",\n      \"seasonal\",\n      \"heirloom\",\n      \"grass-fed\",\n      \"free-range\",\n      \"non-gmo\",\n      \"pesticide-free\",\n      \"sustainable\",\n      \"biodynamic\",\n      \"certified\",\n      \"artisan\",\n    ];\n\n    return commonTags\n      .slice(0, targetLength)\n      .map((tag) => (tags.includes(tag) ? 1 : 0));\n  }\n\n  /**\n   * QUANTUM RECOMMENDATION GENERATION\n   * GPU-accelerated batch prediction\n   */\n  async generateRecommendations(\n    userId: string,\n    userPrefs: UserPreferences,\n    availableProducts: Product[],\n    topN: number = 10\n  ): Promise<Recommendation[]> {\n    if (!this.model || !this.initialized) {\n      throw new Error(\"Recommendation engine not initialized\");\n    }\n\n    const startTime = performance.now();\n\n    try {\n      // Encode user preferences\n      const userTensor = this.encodeUserPreferences(userPrefs);\n\n      // Encode all products and combine with user preferences\n      const productTensors = availableProducts.map((product) => {\n        const productTensor = this.encodeProduct(product);\n        return tf.concat([userTensor, productTensor]);\n      });\n\n      // Batch prediction on GPU\n      const batch = tf.stack(productTensors);\n      const predictions = this.model.predict(batch) as tf.Tensor;\n      const scores = await predictions.data();\n\n      // Cleanup tensors\n      userTensor.dispose();\n      productTensors.forEach((t) => t.dispose());\n      batch.dispose();\n      predictions.dispose();\n\n      // Create recommendations with scores\n      const recommendations: Recommendation[] = availableProducts.map(\n        (product, idx) => ({\n          productId: product.id,\n          score: scores[idx],\n          reason: this.generateReason(product, userPrefs, scores[idx]),\n        })\n      );\n\n      // Sort by score and take top N\n      recommendations.sort((a, b) => b.score - a.score);\n      const topRecommendations = recommendations.slice(0, topN);\n\n      const processingTime = performance.now() - startTime;\n      console.log(\n        `âœ… Generated ${topN} recommendations in ${processingTime.toFixed(2)}ms`\n      );\n      console.log(`   Processed ${availableProducts.length} products on GPU`);\n\n      return topRecommendations;\n    } catch (error) {\n      console.error(\"Recommendation generation failed:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * GENERATE HUMAN-READABLE REASON\n   */\n  private generateReason(\n    product: Product,\n    prefs: UserPreferences,\n    score: number\n  ): string {\n    const reasons: string[] = [];\n\n    if (product.organic && prefs.preferOrganic) {\n      reasons.push(\"organic preference\");\n    }\n\n    if (prefs.favoriteCategories.includes(product.category)) {\n      reasons.push(`favorite category (${product.category})`);\n    }\n\n    if (\n      product.price >= prefs.priceRange.min &&\n      product.price <= prefs.priceRange.max\n    ) {\n      reasons.push(\"in price range\");\n    }\n\n    if (product.seasonal) {\n      reasons.push(\"seasonal availability\");\n    }\n\n    if (reasons.length === 0) {\n      return `high compatibility score (${(score * 100).toFixed(0)}%)`;\n    }\n\n    return reasons.join(\", \");\n  }\n\n  /**\n   * TRAIN MODEL WITH USER INTERACTIONS\n   * (Placeholder for production implementation)\n   */\n  async trainModel(\n    interactions: Array<{\n      userId: string;\n      productId: string;\n      interaction: \"view\" | \"purchase\" | \"favorite\";\n    }>\n  ): Promise<void> {\n    console.log(`ðŸ“š Training model with ${interactions.length} interactions`);\n    // In production, this would train the model on historical data\n    // For now, we use the pre-built architecture\n  }\n\n  /**\n   * CLEANUP GPU RESOURCES\n   */\n  dispose(): void {\n    this.productEmbeddings.forEach((tensor) => tensor.dispose());\n    this.productEmbeddings.clear();\n\n    if (this.model) {\n      this.model.dispose();\n      this.model = null;\n    }\n\n    tf.disposeVariables();\n    this.initialized = false;\n\n    console.log(\"ðŸ§¹ ML engine resources cleaned up\");\n  }\n}\n\n// Singleton instance\nlet recommendationEngine: GPURecommendationEngine | null = null;\n\nexport async function getRecommendationEngine(): Promise<GPURecommendationEngine> {\n  if (!recommendationEngine) {\n    recommendationEngine = new GPURecommendationEngine();\n    await recommendationEngine.initialize();\n  }\n  return recommendationEngine;\n}\n\n/**\n * DIVINE CONVENIENCE FUNCTION\n */\nexport async function getProductRecommendations(\n  userId: string,\n  userPrefs: UserPreferences,\n  availableProducts: Product[],\n  topN: number = 10\n): Promise<Recommendation[]> {\n  const engine = await getRecommendationEngine();\n  return await engine.generateRecommendations(\n    userId,\n    userPrefs,\n    availableProducts,\n    topN\n  );\n}\n"],"version":3}