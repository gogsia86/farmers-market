4089a83023f57b67beec346d703fafbf
"use strict";
/**
 * ML RECOMMENDATION ENGINE
 * GPU-accelerated collaborative filtering with browser fallback
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.GPURecommendationEngine = void 0;
exports.getRecommendationEngine = getRecommendationEngine;
exports.getProductRecommendations = getProductRecommendations;
let tf;
try {
    // Try to use GPU version if available
    tf = require("@tensorflow/tfjs-node-gpu");
}
catch {
    try {
        // Fallback to regular tfjs with WebGL backend
        tf = require("@tensorflow/tfjs");
        require("@tensorflow/tfjs-backend-webgl");
    }
    catch {
        // If all fails, use CPU backend
        tf = require("@tensorflow/tfjs");
    }
}
class GPURecommendationEngine {
    model = null;
    productEmbeddings = new Map();
    initialized = false;
    async initialize() {
        if (this.initialized)
            return;
        try {
            await tf.setBackend("tensorflow");
            await tf.ready();
            console.log("ðŸ§  ML Recommendation Engine initialized");
            console.log("   Backend:", tf.getBackend());
            console.log("   GPU available:", tf.env().getBool("IS_BROWSER") === false);
            // Build simple neural network for collaborative filtering
            this.model = this.buildRecommendationModel();
            this.initialized = true;
        }
        catch (error) {
            console.error("âŒ ML engine initialization failed:", error);
            throw error;
        }
    }
    /**
     * BUILD RECOMMENDATION MODEL
     * Simple neural network for collaborative filtering
     */
    buildRecommendationModel() {
        const model = tf.sequential({
            layers: [
                // Input layer: user preferences + product features
                tf.layers.dense({
                    inputShape: [20], // 20 features
                    units: 64,
                    activation: "relu",
                    kernelInitializer: "heNormal",
                }),
                // Hidden layers with dropout for regularization
                tf.layers.dropout({ rate: 0.2 }),
                tf.layers.dense({ units: 32, activation: "relu" }),
                tf.layers.dropout({ rate: 0.2 }),
                tf.layers.dense({ units: 16, activation: "relu" }),
                // Output layer: recommendation score
                tf.layers.dense({ units: 1, activation: "sigmoid" }),
            ],
        });
        model.compile({
            optimizer: tf.train.adam(0.001),
            loss: "binaryCrossentropy",
            metrics: ["accuracy"],
        });
        return model;
    }
    /**
     * DIVINE PRODUCT ENCODING
     * Convert product features to tensor representation
     */
    encodeProduct(product) {
        const features = [
            // Price normalized (0-1)
            Math.min(product.price / 100, 1),
            // Boolean features
            product.seasonal ? 1 : 0,
            product.organic ? 1 : 0,
            // Category one-hot encoding (simplified)
            product.category === "VEGETABLES" ? 1 : 0,
            product.category === "FRUITS" ? 1 : 0,
            product.category === "DAIRY" ? 1 : 0,
            product.category === "MEAT" ? 1 : 0,
            // Tag features (top 13 common tags)
            ...this.encodeTagsToVector(product.tags, 13),
        ];
        return tf.tensor1d(features);
    }
    /**
     * ENCODE USER PREFERENCES
     */
    encodeUserPreferences(prefs) {
        const features = [
            // Purchase history count (normalized)
            Math.min(prefs.purchasedProducts.length / 50, 1),
            // View history count (normalized)
            Math.min(prefs.viewedProducts.length / 100, 1),
            // Price preference (normalized)
            Math.min(prefs.priceRange.min / 100, 1),
            Math.min(prefs.priceRange.max / 100, 1),
            // Organic preference
            prefs.preferOrganic ? 1 : 0,
            // Favorite categories (simplified)
            prefs.favoriteCategories.includes("VEGETABLES") ? 1 : 0,
            prefs.favoriteCategories.includes("FRUITS") ? 1 : 0,
            prefs.favoriteCategories.includes("DAIRY") ? 1 : 0,
            // Padding to match product encoding length
            ...Array(12).fill(0),
        ];
        return tf.tensor1d(features);
    }
    /**
     * ENCODE TAGS TO VECTOR
     */
    encodeTagsToVector(tags, targetLength) {
        const commonTags = [
            "fresh",
            "local",
            "organic",
            "seasonal",
            "heirloom",
            "grass-fed",
            "free-range",
            "non-gmo",
            "pesticide-free",
            "sustainable",
            "biodynamic",
            "certified",
            "artisan",
        ];
        return commonTags
            .slice(0, targetLength)
            .map((tag) => (tags.includes(tag) ? 1 : 0));
    }
    /**
     * QUANTUM RECOMMENDATION GENERATION
     * GPU-accelerated batch prediction
     */
    async generateRecommendations(userId, userPrefs, availableProducts, topN = 10) {
        if (!this.model || !this.initialized) {
            throw new Error("Recommendation engine not initialized");
        }
        const startTime = performance.now();
        try {
            // Encode user preferences
            const userTensor = this.encodeUserPreferences(userPrefs);
            // Encode all products and combine with user preferences
            const productTensors = availableProducts.map((product) => {
                const productTensor = this.encodeProduct(product);
                return tf.concat([userTensor, productTensor]);
            });
            // Batch prediction on GPU
            const batch = tf.stack(productTensors);
            const predictions = this.model.predict(batch);
            const scores = await predictions.data();
            // Cleanup tensors
            userTensor.dispose();
            productTensors.forEach((t) => t.dispose());
            batch.dispose();
            predictions.dispose();
            // Create recommendations with scores
            const recommendations = availableProducts.map((product, idx) => ({
                productId: product.id,
                score: scores[idx],
                reason: this.generateReason(product, userPrefs, scores[idx]),
            }));
            // Sort by score and take top N
            recommendations.sort((a, b) => b.score - a.score);
            const topRecommendations = recommendations.slice(0, topN);
            const processingTime = performance.now() - startTime;
            console.log(`âœ… Generated ${topN} recommendations in ${processingTime.toFixed(2)}ms`);
            console.log(`   Processed ${availableProducts.length} products on GPU`);
            return topRecommendations;
        }
        catch (error) {
            console.error("Recommendation generation failed:", error);
            throw error;
        }
    }
    /**
     * GENERATE HUMAN-READABLE REASON
     */
    generateReason(product, prefs, score) {
        const reasons = [];
        if (product.organic && prefs.preferOrganic) {
            reasons.push("organic preference");
        }
        if (prefs.favoriteCategories.includes(product.category)) {
            reasons.push(`favorite category (${product.category})`);
        }
        if (product.price >= prefs.priceRange.min &&
            product.price <= prefs.priceRange.max) {
            reasons.push("in price range");
        }
        if (product.seasonal) {
            reasons.push("seasonal availability");
        }
        if (reasons.length === 0) {
            return `high compatibility score (${(score * 100).toFixed(0)}%)`;
        }
        return reasons.join(", ");
    }
    /**
     * TRAIN MODEL WITH USER INTERACTIONS
     * (Placeholder for production implementation)
     */
    async trainModel(interactions) {
        console.log(`ðŸ“š Training model with ${interactions.length} interactions`);
        // In production, this would train the model on historical data
        // For now, we use the pre-built architecture
    }
    /**
     * CLEANUP GPU RESOURCES
     */
    dispose() {
        this.productEmbeddings.forEach((tensor) => tensor.dispose());
        this.productEmbeddings.clear();
        if (this.model) {
            this.model.dispose();
            this.model = null;
        }
        tf.disposeVariables();
        this.initialized = false;
        console.log("ðŸ§¹ ML engine resources cleaned up");
    }
}
exports.GPURecommendationEngine = GPURecommendationEngine;
// Singleton instance
let recommendationEngine = null;
async function getRecommendationEngine() {
    if (!recommendationEngine) {
        recommendationEngine = new GPURecommendationEngine();
        await recommendationEngine.initialize();
    }
    return recommendationEngine;
}
/**
 * DIVINE CONVENIENCE FUNCTION
 */
async function getProductRecommendations(userId, userPrefs, availableProducts, topN = 10) {
    const engine = await getRecommendationEngine();
    return await engine.generateRecommendations(userId, userPrefs, availableProducts, topN);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiTTpcXFJlcG9cXEZhcm1lcnMgTWFya2V0IFBsYXRmb3JtIHdlYiBhbmQgYXBwXFxzcmNcXGxpYlxcbWxcXHJlY29tbWVuZGF0aW9uLWVuZ2luZS50cyIsIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOzs7QUFxVUgsMERBTUM7QUFLRCw4REFhQztBQTNWRCxJQUFJLEVBQU8sQ0FBQztBQUNaLElBQUksQ0FBQztJQUNILHNDQUFzQztJQUN0QyxFQUFFLEdBQUcsT0FBTyxDQUFDLDJCQUEyQixDQUFDLENBQUM7QUFDNUMsQ0FBQztBQUFDLE1BQU0sQ0FBQztJQUNQLElBQUksQ0FBQztRQUNILDhDQUE4QztRQUM5QyxFQUFFLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDakMsT0FBTyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUFDLE1BQU0sQ0FBQztRQUNQLGdDQUFnQztRQUNoQyxFQUFFLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFDbkMsQ0FBQztBQUNILENBQUM7QUE0QkQsTUFBYSx1QkFBdUI7SUFDMUIsS0FBSyxHQUEwQixJQUFJLENBQUM7SUFDcEMsaUJBQWlCLEdBQTJCLElBQUksR0FBRyxFQUFFLENBQUM7SUFDdEQsV0FBVyxHQUFZLEtBQUssQ0FBQztJQUVyQyxLQUFLLENBQUMsVUFBVTtRQUNkLElBQUksSUFBSSxDQUFDLFdBQVc7WUFBRSxPQUFPO1FBRTdCLElBQUksQ0FBQztZQUNILE1BQU0sRUFBRSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUNsQyxNQUFNLEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUVqQixPQUFPLENBQUMsR0FBRyxDQUFDLHlDQUF5QyxDQUFDLENBQUM7WUFDdkQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsRUFBRSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7WUFDNUMsT0FBTyxDQUFDLEdBQUcsQ0FDVCxtQkFBbUIsRUFDbkIsRUFBRSxDQUFDLEdBQUcsRUFBRSxD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QUFVLHVCQUF1QjtJQUMzQyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztRQUMxQixvQkFBb0IsR0FBRyxJQUFJLHVCQUF1QixFQUFFLENBQUM7UUFDckQsTUFBTSxvQkFBb0IsQ0FBQyxVQUFVLEVBQUUsQ0FBQztJQUMxQyxDQUFDO0lBQ0QsT0FBTyxvQkFBb0IsQ0FBQztBQUM5QixDQUFDO0FBRUQ7O0dBRUc7QUFDSSxLQUFLLFVBQVUseUJBQXlCLENBQzdDLE1BQWMsRUFDZCxTQUEwQixFQUMxQixpQkFBNEIsRUFDNUIsT0FBZSxFQUFFO0lBRWpCLE1BQU0sTUFBTSxHQUFHLE1BQU0sdUJBQXVCLEVBQUUsQ0FBQztJQUMvQyxPQUFPLE1BQU0sTUFBTSxDQUFDLHVCQUF1QixDQUN6QyxNQUFNLEVBQ04sU0FBUyxFQUNULGlCQUFpQixFQUNqQixJQUFJLENBQ0wsQ0FBQztBQUNKLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiTTpcXFJlcG9cXEZhcm1lcnMgTWFya2V0IFBsYXRmb3JtIHdlYiBhbmQgYXBwXFxzcmNcXGxpYlxcbWxcXHJlY29tbWVuZGF0aW9uLWVuZ2luZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIE1MIFJFQ09NTUVOREFUSU9OIEVOR0lORVxuICogR1BVLWFjY2VsZXJhdGVkIGNvbGxhYm9yYXRpdmUgZmlsdGVyaW5nIHdpdGggYnJvd3NlciBmYWxsYmFja1xuICovXG5cbmxldCB0ZjogYW55O1xudHJ5IHtcbiAgLy8gVHJ5IHRvIHVzZSBHUFUgdmVyc2lvbiBpZiBhdmFpbGFibGVcbiAgdGYgPSByZXF1aXJlKFwiQHRlbnNvcmZsb3cvdGZqcy1ub2RlLWdwdVwiKTtcbn0gY2F0Y2gge1xuICB0cnkge1xuICAgIC8vIEZhbGxiYWNrIHRvIHJlZ3VsYXIgdGZqcyB3aXRoIFdlYkdMIGJhY2tlbmRcbiAgICB0ZiA9IHJlcXVpcmUoXCJAdGVuc29yZmxvdy90ZmpzXCIpO1xuICAgIHJlcXVpcmUoXCJAdGVuc29yZmxvdy90ZmpzLWJhY2tlbmQtd2ViZ2xcIik7XG4gIH0gY2F0Y2gge1xuICAgIC8vIElmIGFsbCBmYWlscywgdXNlIENQVSBiYWNrZW5kXG4gICAgdGYgPSByZXF1aXJlKFwiQHRlbnNvcmZsb3cvdGZqc1wiKTtcbiAgfVxufVxuXG5pbnRlcmZhY2UgUHJvZHVjdCB7XG4gIGlkOiBzdHJpbmc7XG4gIG5hbWU6IHN0cmluZztcbiAgY2F0ZWdvcnk6IHN0cmluZztcbiAgcHJpY2U6IG51bWJlcjtcbiAgZmFybUlkOiBzdHJpbmc7XG4gIHNlYXNvbmFsOiBib29sZWFuO1xuICBvcmdhbmljOiBib29sZWFuO1xuICB0YWdzOiBzdHJpbmdbXTtcbn1cblxuaW50ZXJmYWNlIFVzZXJQcmVmZXJlbmNlcyB7XG4gIHVzZXJJZDogc3RyaW5nO1xuICB2aWV3ZWRQcm9kdWN0czogc3RyaW5nW107XG4gIHB1cmNoYXNlZFByb2R1Y3RzOiBzdHJpbmdbXTtcbiAgZmF2b3JpdGVDYXRlZ29yaWVzOiBzdHJpbmdbXTtcbiAgcHJpY2VSYW5nZTogeyBtaW46IG51bWJlcjsgbWF4OiBudW1iZXIgfTtcbiAgcHJlZmVyT3JnYW5pYzogYm9vbGVhbjtcbn1cblxuaW50ZXJmYWNlIFJlY29tbWVuZGF0aW9uIHtcbiAgcHJvZHVjdElkOiBzdHJpbmc7XG4gIHNjb3JlOiBudW1iZXI7XG4gIHJlYXNvbjogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgR1BVUmVjb21tZW5kYXRpb25FbmdpbmUge1xuICBwcml2YXRlIG1vZGVsOiB0Zi5MYXllcnNNb2RlbCB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIHByb2R1Y3RFbWJlZGRpbmdzOiBNYXA8c3RyaW5nLCB0Zi5UZW5zb3I+ID0gbmV3IE1hcCgpO1xuICBwcml2YXRlIGluaXRpYWxpemVkOiBib29sZWFuID0gZmFsc2U7XG5cbiAgYXN5bmMgaW5pdGlhbGl6ZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAodGhpcy5pbml0aWFsaXplZCkgcmV0dXJuO1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRmLnNldEJhY2tlbmQoXCJ0ZW5zb3JmbG93XCIpO1xuICAgICAgYXdhaXQgdGYucmVhZHkoKTtcblxuICAgICAgY29uc29sZS5sb2coXCLwn6egIE1MIFJlY29tbWVuZGF0aW9uIEVuZ2luZSBpbml0aWFsaXplZFwiKTtcbiAgICAgIGNvbnNvbGUubG9nKFwiICAgQmFja2VuZDpcIiwgdGYuZ2V0QmFja2VuZCgpKTtcbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICBcIiAgIEdQVSBhdmFpbGFibGU6XCIsXG4gICAgICAgIHRmLmVudigpLmdldEJvb2woXCJJU19CUk9XU0VSXCIpID09PSBmYWxzZVxuICAgICAgKTtcblxuICAgICAgLy8gQnVpbGQgc2ltcGxlIG5ldXJhbCBuZXR3b3JrIGZvciBjb2xsYWJvcmF0aXZlIGZpbHRlcmluZ1xuICAgICAgdGhpcy5tb2RlbCA9IHRoaXMuYnVpbGRSZWNvbW1lbmRhdGlvbk1vZGVsKCk7XG5cbiAgICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwi4p2MIE1MIGVuZ2luZSBpbml0aWFsaXphdGlvbiBmYWlsZWQ6XCIsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBCVUlMRCBSRUNPTU1FTkRBVElPTiBNT0RFTFxuICAgKiBTaW1wbGUgbmV1cmFsIG5ldHdvcmsgZm9yIGNvbGxhYm9yYXRpdmUgZmlsdGVyaW5nXG4gICAqL1xuICBwcml2YXRlIGJ1aWxkUmVjb21tZW5kYXRpb25Nb2RlbCgpOiB0Zi5MYXllcnNNb2RlbCB7XG4gICAgY29uc3QgbW9kZWwgPSB0Zi5zZXF1ZW50aWFsKHtcbiAgICAgIGxheWVyczogW1xuICAgICAgICAvLyBJbnB1dCBsYXllcjogdXNlciBwcmVmZXJlbmNlcyArIHByb2R1Y3QgZmVhdHVyZXNcbiAgICAgICAgdGYubGF5ZXJzLmRlbnNlKHtcbiAgICAgICAgICBpbnB1dFNoYXBlOiBbMjBdLCAvLyAyMCBmZWF0dXJlc1xuICAgICAgICAgIHVuaXRzOiA2NCxcbiAgICAgICAgICBhY3RpdmF0aW9uOiBcInJlbHVcIixcbiAgICAgICAgICBrZXJuZWxJbml0aWFsaXplcjogXCJoZU5vcm1hbFwiLFxuICAgICAgICB9KSxcblxuICAgICAgICAvLyBIaWRkZW4gbGF5ZXJzIHdpdGggZHJvcG91dCBmb3IgcmVndWxhcml6YXRpb25cbiAgICAgICAgdGYubGF5ZXJzLmRyb3BvdXQoeyByYXRlOiAwLjIgfSksXG4gICAgICAgIHRmLmxheWVycy5kZW5zZSh7IHVuaXRzOiAzMiwgYWN0aXZhdGlvbjogXCJyZWx1XCIgfSksXG4gICAgICAgIHRmLmxheWVycy5kcm9wb3V0KHsgcmF0ZTogMC4yIH0pLFxuICAgICAgICB0Zi5sYXllcnMuZGVuc2UoeyB1bml0czogMTYsIGFjdGl2YXRpb246IFwicmVsdVwiIH0pLFxuXG4gICAgICAgIC8vIE91dHB1dCBsYXllcjogcmVjb21tZW5kYXRpb24gc2NvcmVcbiAgICAgICAgdGYubGF5ZXJzLmRlbnNlKHsgdW5pdHM6IDEsIGFjdGl2YXRpb246IFwic2lnbW9pZFwiIH0pLFxuICAgICAgXSxcbiAgICB9KTtcblxuICAgIG1vZGVsLmNvbXBpbGUoe1xuICAgICAgb3B0aW1pemVyOiB0Zi50cmFpbi5hZGFtKDAuMDAxKSxcbiAgICAgIGxvc3M6IFwiYmluYXJ5Q3Jvc3NlbnRyb3B5XCIsXG4gICAgICBtZXRyaWNzOiBbXCJhY2N1cmFjeVwiXSxcbiAgICB9KTtcblxuICAgIHJldHVybiBtb2RlbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBESVZJTkUgUFJPRFVDVCBFTkNPRElOR1xuICAgKiBDb252ZXJ0IHByb2R1Y3QgZmVhdHVyZXMgdG8gdGVuc29yIHJlcHJlc2VudGF0aW9uXG4gICAqL1xuICBwcml2YXRlIGVuY29kZVByb2R1Y3QocHJvZHVjdDogUHJvZHVjdCk6IHRmLlRlbnNvciB7XG4gICAgY29uc3QgZmVhdHVyZXMgPSBbXG4gICAgICAvLyBQcmljZSBub3JtYWxpemVkICgwLTEpXG4gICAgICBNYXRoLm1pbihwcm9kdWN0LnByaWNlIC8gMTAwLCAxKSxcblxuICAgICAgLy8gQm9vbGVhbiBmZWF0dXJlc1xuICAgICAgcHJvZHVjdC5zZWFzb25hbCA/IDEgOiAwLFxuICAgICAgcHJvZHVjdC5vcmdhbmljID8gMSA6IDAsXG5cbiAgICAgIC8vIENhdGVnb3J5IG9uZS1ob3QgZW5jb2RpbmcgKHNpbXBsaWZpZWQpXG4gICAgICBwcm9kdWN0LmNhdGVnb3J5ID09PSBcIlZFR0VUQUJMRVNcIiA/IDEgOiAwLFxuICAgICAgcHJvZHVjdC5jYXRlZ29yeSA9PT0gXCJGUlVJVFNcIiA/IDEgOiAwLFxuICAgICAgcHJvZHVjdC5jYXRlZ29yeSA9PT0gXCJEQUlSWVwiID8gMSA6IDAsXG4gICAgICBwcm9kdWN0LmNhdGVnb3J5ID09PSBcIk1FQVRcIiA/IDEgOiAwLFxuXG4gICAgICAvLyBUYWcgZmVhdHVyZXMgKHRvcCAxMyBjb21tb24gdGFncylcbiAgICAgIC4uLnRoaXMuZW5jb2RlVGFnc1RvVmVjdG9yKHByb2R1Y3QudGFncywgMTMpLFxuICAgIF07XG5cbiAgICByZXR1cm4gdGYudGVuc29yMWQoZmVhdHVyZXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEVOQ09ERSBVU0VSIFBSRUZFUkVOQ0VTXG4gICAqL1xuICBwcml2YXRlIGVuY29kZVVzZXJQcmVmZXJlbmNlcyhwcmVmczogVXNlclByZWZlcmVuY2VzKTogdGYuVGVuc29yIHtcbiAgICBjb25zdCBmZWF0dXJlcyA9IFtcbiAgICAgIC8vIFB1cmNoYXNlIGhpc3RvcnkgY291bnQgKG5vcm1hbGl6ZWQpXG4gICAgICBNYXRoLm1pbihwcmVmcy5wdXJjaGFzZWRQcm9kdWN0cy5sZW5ndGggLyA1MCwgMSksXG5cbiAgICAgIC8vIFZpZXcgaGlzdG9yeSBjb3VudCAobm9ybWFsaXplZClcbiAgICAgIE1hdGgubWluKHByZWZzLnZpZXdlZFByb2R1Y3RzLmxlbmd0aCAvIDEwMCwgMSksXG5cbiAgICAgIC8vIFByaWNlIHByZWZlcmVuY2UgKG5vcm1hbGl6ZWQpXG4gICAgICBNYXRoLm1pbihwcmVmcy5wcmljZVJhbmdlLm1pbiAvIDEwMCwgMSksXG4gICAgICBNYXRoLm1pbihwcmVmcy5wcmljZVJhbmdlLm1heCAvIDEwMCwgMSksXG5cbiAgICAgIC8vIE9yZ2FuaWMgcHJlZmVyZW5jZVxuICAgICAgcHJlZnMucHJlZmVyT3JnYW5pYyA/IDEgOiAwLFxuXG4gICAgICAvLyBGYXZvcml0ZSBjYXRlZ29yaWVzIChzaW1wbGlmaWVkKVxuICAgICAgcHJlZnMuZmF2b3JpdGVDYXRlZ29yaWVzLmluY2x1ZGVzKFwiVkVHRVRBQkxFU1wiKSA/IDEgOiAwLFxuICAgICAgcHJlZnMuZmF2b3JpdGVDYXRlZ29yaWVzLmluY2x1ZGVzKFwiRlJVSVRTXCIpID8gMSA6IDAsXG4gICAgICBwcmVmcy5mYXZvcml0ZUNhdGVnb3JpZXMuaW5jbHVkZXMoXCJEQUlSWVwiKSA/IDEgOiAwLFxuXG4gICAgICAvLyBQYWRkaW5nIHRvIG1hdGNoIHByb2R1Y3QgZW5jb2RpbmcgbGVuZ3RoXG4gICAgICAuLi5BcnJheSgxMikuZmlsbCgwKSxcbiAgICBdO1xuXG4gICAgcmV0dXJuIHRmLnRlbnNvcjFkKGZlYXR1cmVzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFTkNPREUgVEFHUyBUTyBWRUNUT1JcbiAgICovXG4gIHByaXZhdGUgZW5jb2RlVGFnc1RvVmVjdG9yKHRhZ3M6IHN0cmluZ1tdLCB0YXJnZXRMZW5ndGg6IG51bWJlcik6IG51bWJlcltdIHtcbiAgICBjb25zdCBjb21tb25UYWdzID0gW1xuICAgICAgXCJmcmVzaFwiLFxuICAgICAgXCJsb2NhbFwiLFxuICAgICAgXCJvcmdhbmljXCIsXG4gICAgICBcInNlYXNvbmFsXCIsXG4gICAgICBcImhlaXJsb29tXCIsXG4gICAgICBcImdyYXNzLWZlZFwiLFxuICAgICAgXCJmcmVlLXJhbmdlXCIsXG4gICAgICBcIm5vbi1nbW9cIixcbiAgICAgIFwicGVzdGljaWRlLWZyZWVcIixcbiAgICAgIFwic3VzdGFpbmFibGVcIixcbiAgICAgIFwiYmlvZHluYW1pY1wiLFxuICAgICAgXCJjZXJ0aWZpZWRcIixcbiAgICAgIFwiYXJ0aXNhblwiLFxuICAgIF07XG5cbiAgICByZXR1cm4gY29tbW9uVGFnc1xuICAgICAgLnNsaWNlKDAsIHRhcmdldExlbmd0aClcbiAgICAgIC5tYXAoKHRhZykgPT4gKHRhZ3MuaW5jbHVkZXModGFnKSA/IDEgOiAwKSk7XG4gIH1cblxuICAvKipcbiAgICogUVVBTlRVTSBSRUNPTU1FTkRBVElPTiBHRU5FUkFUSU9OXG4gICAqIEdQVS1hY2NlbGVyYXRlZCBiYXRjaCBwcmVkaWN0aW9uXG4gICAqL1xuICBhc3luYyBnZW5lcmF0ZVJlY29tbWVuZGF0aW9ucyhcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICB1c2VyUHJlZnM6IFVzZXJQcmVmZXJlbmNlcyxcbiAgICBhdmFpbGFibGVQcm9kdWN0czogUHJvZHVjdFtdLFxuICAgIHRvcE46IG51bWJlciA9IDEwXG4gICk6IFByb21pc2U8UmVjb21tZW5kYXRpb25bXT4ge1xuICAgIGlmICghdGhpcy5tb2RlbCB8fCAhdGhpcy5pbml0aWFsaXplZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUmVjb21tZW5kYXRpb24gZW5naW5lIG5vdCBpbml0aWFsaXplZFwiKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdGFydFRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKTtcblxuICAgIHRyeSB7XG4gICAgICAvLyBFbmNvZGUgdXNlciBwcmVmZXJlbmNlc1xuICAgICAgY29uc3QgdXNlclRlbnNvciA9IHRoaXMuZW5jb2RlVXNlclByZWZlcmVuY2VzKHVzZXJQcmVmcyk7XG5cbiAgICAgIC8vIEVuY29kZSBhbGwgcHJvZHVjdHMgYW5kIGNvbWJpbmUgd2l0aCB1c2VyIHByZWZlcmVuY2VzXG4gICAgICBjb25zdCBwcm9kdWN0VGVuc29ycyA9IGF2YWlsYWJsZVByb2R1Y3RzLm1hcCgocHJvZHVjdCkgPT4ge1xuICAgICAgICBjb25zdCBwcm9kdWN0VGVuc29yID0gdGhpcy5lbmNvZGVQcm9kdWN0KHByb2R1Y3QpO1xuICAgICAgICByZXR1cm4gdGYuY29uY2F0KFt1c2VyVGVuc29yLCBwcm9kdWN0VGVuc29yXSk7XG4gICAgICB9KTtcblxuICAgICAgLy8gQmF0Y2ggcHJlZGljdGlvbiBvbiBHUFVcbiAgICAgIGNvbnN0IGJhdGNoID0gdGYuc3RhY2socHJvZHVjdFRlbnNvcnMpO1xuICAgICAgY29uc3QgcHJlZGljdGlvbnMgPSB0aGlzLm1vZGVsLnByZWRpY3QoYmF0Y2gpIGFzIHRmLlRlbnNvcjtcbiAgICAgIGNvbnN0IHNjb3JlcyA9IGF3YWl0IHByZWRpY3Rpb25zLmRhdGEoKTtcblxuICAgICAgLy8gQ2xlYW51cCB0ZW5zb3JzXG4gICAgICB1c2VyVGVuc29yLmRpc3Bvc2UoKTtcbiAgICAgIHByb2R1Y3RUZW5zb3JzLmZvckVhY2goKHQpID0+IHQuZGlzcG9zZSgpKTtcbiAgICAgIGJhdGNoLmRpc3Bvc2UoKTtcbiAgICAgIHByZWRpY3Rpb25zLmRpc3Bvc2UoKTtcblxuICAgICAgLy8gQ3JlYXRlIHJlY29tbWVuZGF0aW9ucyB3aXRoIHNjb3Jlc1xuICAgICAgY29uc3QgcmVjb21tZW5kYXRpb25zOiBSZWNvbW1lbmRhdGlvbltdID0gYXZhaWxhYmxlUHJvZHVjdHMubWFwKFxuICAgICAgICAocHJvZHVjdCwgaWR4KSA9PiAoe1xuICAgICAgICAgIHByb2R1Y3RJZDogcHJvZHVjdC5pZCxcbiAgICAgICAgICBzY29yZTogc2NvcmVzW2lkeF0sXG4gICAgICAgICAgcmVhc29uOiB0aGlzLmdlbmVyYXRlUmVhc29uKHByb2R1Y3QsIHVzZXJQcmVmcywgc2NvcmVzW2lkeF0pLFxuICAgICAgICB9KVxuICAgICAgKTtcblxuICAgICAgLy8gU29ydCBieSBzY29yZSBhbmQgdGFrZSB0b3AgTlxuICAgICAgcmVjb21tZW5kYXRpb25zLnNvcnQoKGEsIGIpID0+IGIuc2NvcmUgLSBhLnNjb3JlKTtcbiAgICAgIGNvbnN0IHRvcFJlY29tbWVuZGF0aW9ucyA9IHJlY29tbWVuZGF0aW9ucy5zbGljZSgwLCB0b3BOKTtcblxuICAgICAgY29uc3QgcHJvY2Vzc2luZ1RpbWUgPSBwZXJmb3JtYW5jZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICBg4pyFIEdlbmVyYXRlZCAke3RvcE59IHJlY29tbWVuZGF0aW9ucyBpbiAke3Byb2Nlc3NpbmdUaW1lLnRvRml4ZWQoMil9bXNgXG4gICAgICApO1xuICAgICAgY29uc29sZS5sb2coYCAgIFByb2Nlc3NlZCAke2F2YWlsYWJsZVByb2R1Y3RzLmxlbmd0aH0gcHJvZHVjdHMgb24gR1BVYCk7XG5cbiAgICAgIHJldHVybiB0b3BSZWNvbW1lbmRhdGlvbnM7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJSZWNvbW1lbmRhdGlvbiBnZW5lcmF0aW9uIGZhaWxlZDpcIiwgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdFTkVSQVRFIEhVTUFOLVJFQURBQkxFIFJFQVNPTlxuICAgKi9cbiAgcHJpdmF0ZSBnZW5lcmF0ZVJlYXNvbihcbiAgICBwcm9kdWN0OiBQcm9kdWN0LFxuICAgIHByZWZzOiBVc2VyUHJlZmVyZW5jZXMsXG4gICAgc2NvcmU6IG51bWJlclxuICApOiBzdHJpbmcge1xuICAgIGNvbnN0IHJlYXNvbnM6IHN0cmluZ1tdID0gW107XG5cbiAgICBpZiAocHJvZHVjdC5vcmdhbmljICYmIHByZWZzLnByZWZlck9yZ2FuaWMpIHtcbiAgICAgIHJlYXNvbnMucHVzaChcIm9yZ2FuaWMgcHJlZmVyZW5jZVwiKTtcbiAgICB9XG5cbiAgICBpZiAocHJlZnMuZmF2b3JpdGVDYXRlZ29yaWVzLmluY2x1ZGVzKHByb2R1Y3QuY2F0ZWdvcnkpKSB7XG4gICAgICByZWFzb25zLnB1c2goYGZhdm9yaXRlIGNhdGVnb3J5ICgke3Byb2R1Y3QuY2F0ZWdvcnl9KWApO1xuICAgIH1cblxuICAgIGlmIChcbiAgICAgIHByb2R1Y3QucHJpY2UgPj0gcHJlZnMucHJpY2VSYW5nZS5taW4gJiZcbiAgICAgIHByb2R1Y3QucHJpY2UgPD0gcHJlZnMucHJpY2VSYW5nZS5tYXhcbiAgICApIHtcbiAgICAgIHJlYXNvbnMucHVzaChcImluIHByaWNlIHJhbmdlXCIpO1xuICAgIH1cblxuICAgIGlmIChwcm9kdWN0LnNlYXNvbmFsKSB7XG4gICAgICByZWFzb25zLnB1c2goXCJzZWFzb25hbCBhdmFpbGFiaWxpdHlcIik7XG4gICAgfVxuXG4gICAgaWYgKHJlYXNvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gYGhpZ2ggY29tcGF0aWJpbGl0eSBzY29yZSAoJHsoc2NvcmUgKiAxMDApLnRvRml4ZWQoMCl9JSlgO1xuICAgIH1cblxuICAgIHJldHVybiByZWFzb25zLmpvaW4oXCIsIFwiKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUUkFJTiBNT0RFTCBXSVRIIFVTRVIgSU5URVJBQ1RJT05TXG4gICAqIChQbGFjZWhvbGRlciBmb3IgcHJvZHVjdGlvbiBpbXBsZW1lbnRhdGlvbilcbiAgICovXG4gIGFzeW5jIHRyYWluTW9kZWwoXG4gICAgaW50ZXJhY3Rpb25zOiBBcnJheTx7XG4gICAgICB1c2VySWQ6IHN0cmluZztcbiAgICAgIHByb2R1Y3RJZDogc3RyaW5nO1xuICAgICAgaW50ZXJhY3Rpb246IFwidmlld1wiIHwgXCJwdXJjaGFzZVwiIHwgXCJmYXZvcml0ZVwiO1xuICAgIH0+XG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnNvbGUubG9nKGDwn5OaIFRyYWluaW5nIG1vZGVsIHdpdGggJHtpbnRlcmFjdGlvbnMubGVuZ3RofSBpbnRlcmFjdGlvbnNgKTtcbiAgICAvLyBJbiBwcm9kdWN0aW9uLCB0aGlzIHdvdWxkIHRyYWluIHRoZSBtb2RlbCBvbiBoaXN0b3JpY2FsIGRhdGFcbiAgICAvLyBGb3Igbm93LCB3ZSB1c2UgdGhlIHByZS1idWlsdCBhcmNoaXRlY3R1cmVcbiAgfVxuXG4gIC8qKlxuICAgKiBDTEVBTlVQIEdQVSBSRVNPVVJDRVNcbiAgICovXG4gIGRpc3Bvc2UoKTogdm9pZCB7XG4gICAgdGhpcy5wcm9kdWN0RW1iZWRkaW5ncy5mb3JFYWNoKCh0ZW5zb3IpID0+IHRlbnNvci5kaXNwb3NlKCkpO1xuICAgIHRoaXMucHJvZHVjdEVtYmVkZGluZ3MuY2xlYXIoKTtcblxuICAgIGlmICh0aGlzLm1vZGVsKSB7XG4gICAgICB0aGlzLm1vZGVsLmRpc3Bvc2UoKTtcbiAgICAgIHRoaXMubW9kZWwgPSBudWxsO1xuICAgIH1cblxuICAgIHRmLmRpc3Bvc2VWYXJpYWJsZXMoKTtcbiAgICB0aGlzLmluaXRpYWxpemVkID0gZmFsc2U7XG5cbiAgICBjb25zb2xlLmxvZyhcIvCfp7kgTUwgZW5naW5lIHJlc291cmNlcyBjbGVhbmVkIHVwXCIpO1xuICB9XG59XG5cbi8vIFNpbmdsZXRvbiBpbnN0YW5jZVxubGV0IHJlY29tbWVuZGF0aW9uRW5naW5lOiBHUFVSZWNvbW1lbmRhdGlvbkVuZ2luZSB8IG51bGwgPSBudWxsO1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0UmVjb21tZW5kYXRpb25FbmdpbmUoKTogUHJvbWlzZTxHUFVSZWNvbW1lbmRhdGlvbkVuZ2luZT4ge1xuICBpZiAoIXJlY29tbWVuZGF0aW9uRW5naW5lKSB7XG4gICAgcmVjb21tZW5kYXRpb25FbmdpbmUgPSBuZXcgR1BVUmVjb21tZW5kYXRpb25FbmdpbmUoKTtcbiAgICBhd2FpdCByZWNvbW1lbmRhdGlvbkVuZ2luZS5pbml0aWFsaXplKCk7XG4gIH1cbiAgcmV0dXJuIHJlY29tbWVuZGF0aW9uRW5naW5lO1xufVxuXG4vKipcbiAqIERJVklORSBDT05WRU5JRU5DRSBGVU5DVElPTlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0UHJvZHVjdFJlY29tbWVuZGF0aW9ucyhcbiAgdXNlcklkOiBzdHJpbmcsXG4gIHVzZXJQcmVmczogVXNlclByZWZlcmVuY2VzLFxuICBhdmFpbGFibGVQcm9kdWN0czogUHJvZHVjdFtdLFxuICB0b3BOOiBudW1iZXIgPSAxMFxuKTogUHJvbWlzZTxSZWNvbW1lbmRhdGlvbltdPiB7XG4gIGNvbnN0IGVuZ2luZSA9IGF3YWl0IGdldFJlY29tbWVuZGF0aW9uRW5naW5lKCk7XG4gIHJldHVybiBhd2FpdCBlbmdpbmUuZ2VuZXJhdGVSZWNvbW1lbmRhdGlvbnMoXG4gICAgdXNlcklkLFxuICAgIHVzZXJQcmVmcyxcbiAgICBhdmFpbGFibGVQcm9kdWN0cyxcbiAgICB0b3BOXG4gICk7XG59XG4iXSwidmVyc2lvbiI6M30=