fe3017a96acc087a4421b30aac9000b2
"use strict";
// ðŸ§  DIVINE PATTERN: Multi-Layer Caching with Agricultural Consciousness
// ðŸ“š Reference: 03_PERFORMANCE_REALITY_BENDING.instructions.md
// ðŸŒ¾ Domain: Biodynamic Cache with Seasonal TTL
// âš¡ Performance: Redis + Memory Layer
Object.defineProperty(exports, "__esModule", { value: true });
exports.AgriculturalCache = exports.cache = exports.CacheKeys = void 0;
exports.warmCache = warmCache;
const logger_1 = require("@/lib/monitoring/logger");
const ioredis_1 = require("ioredis");
/**
 * CACHE CONFIGURATION
 */
const REDIS_CONFIG = {
    host: process.env.REDIS_HOST || "localhost",
    port: parseInt(process.env.REDIS_PORT || "6379", 10),
    password: process.env.REDIS_PASSWORD,
    keyPrefix: "fm:", // Farmers Market prefix
    maxRetriesPerRequest: 3,
    retryStrategy: (times) => {
        const delay = Math.min(times * 50, 2000);
        return delay;
    },
};
/**
 * SEASON-AWARE TTL CONFIGURATION
 * Agricultural consciousness: different cache durations per season
 */
const SEASONAL_TTL = {
    SPRING: 3600, // 1 hour (planting season - frequent updates)
    SUMMER: 7200, // 2 hours (growing season - moderate updates)
    FALL: 1800, // 30 minutes (harvest season - rapid changes)
    WINTER: 14400, // 4 hours (rest season - slower updates)
};
/**
 * CACHE KEY PATTERNS
 */
exports.CacheKeys = {
    farm: (id) => `farm:${id}`,
    farmList: (filters) => `farms:list:${filters}`,
    product: (id) => `product:${id}`,
    productList: (farmId, filters) => `products:${farmId}:${filters}`,
    userProfile: (id) => `user:${id}`,
    seasonalData: (season) => `seasonal:${season}`,
};
/**
 * MEMORY CACHE LAYER
 * Fast in-memory cache for frequently accessed data
 */
class MemoryCache {
    cache = new Map();
    maxSize = 1000;
    async get(key) {
        const entry = this.cache.get(key);
        if (!entry)
            return null;
        if (Date.now() > entry.expiry) {
            this.cache.delete(key);
            return null;
        }
        return entry.value;
    }
    async set(key, value, ttl = 300) {
        // LRU eviction if cache is full
        if (this.cache.size >= this.maxSize) {
            const firstKey = this.cache.keys().next().value;
            if (firstKey)
                this.cache.delete(firstKey);
        }
        this.cache.set(key, {
            value,
            expiry: Date.now() + ttl * 1000,
        });
    }
    async del(key) {
        this.cache.delete(key);
    }
    async delPattern(pattern) {
        const regex = new RegExp(pattern.replace("*", ".*"));
        for (const key of this.cache.keys()) {
            if (regex.test(key)) {
                this.cache.delete(key);
            }
        }
    }
    async clear() {
        this.cache.clear();
    }
}
/**
 * REDIS CACHE LAYER
 * Distributed cache for multi-instance deployments
 */
class RedisCache {
    client = null;
    isConnected = false;
    constructor() {
        this.connect();
    }
    connect() {
        try {
            this.client = new ioredis_1.Redis(REDIS_CONFIG);
            this.client.on("connect", () => {
                this.isConnected = true;
                logger_1.logger.info("Redis cache connected");
            });
            this.client.on("error", (error) => {
                logger_1.logger.error("Redis cache error", { error });
                this.isConnected = false;
            });
        }
        catch (error) {
            logger_1.logger.error("Failed to initialize Redis", { error });
        }
    }
    async get(key) {
        if (!this.client || !this.isConnected)
            return null;
        try {
            const value = await this.client.get(key);
            if (!value)
                return null;
            return JSON.parse(value);
        }
        catch (error) {
            logger_1.logger.error("Redis get error", { key, error });
            return null;
        }
    }
    async set(key, value, ttl = 300) {
        if (!this.client || !this.isConnected)
            return;
        try {
            await this.client.setex(key, ttl, JSON.stringify(value));
        }
        catch (error) {
            logger_1.logger.error("Redis set error", { key, error });
        }
    }
    async del(key) {
        if (!this.client || !this.isConnected)
            return;
        try {
            await this.client.del(key);
        }
        catch (error) {
            logger_1.logger.error("Redis del error", { key, error });
        }
    }
    async delPattern(pattern) {
        if (!this.client || !this.isConnected)
            return;
        try {
            const keys = await this.client.keys(pattern);
            if (keys.length > 0) {
                await this.client.del(...keys);
            }
        }
        catch (error) {
            logger_1.logger.error("Redis delPattern error", { pattern, error });
        }
    }
    async clear() {
        if (!this.client || !this.isConnected)
            return;
        try {
            await this.client.flushdb();
        }
        catch (error) {
            logger_1.logger.error("Redis clear error", { error });
        }
    }
    async disconnect() {
        if (this.client) {
            await this.client.quit();
            this.isConnected = false;
        }
    }
}
/**
 * MULTI-LAYER CACHE MANAGER
 * Combines memory and Redis layers with fallback strategy
 */
class MultiLayerCache {
    memoryCache;
    redisCache;
    useRedis;
    constructor() {
        this.memoryCache = new MemoryCache();
        this.redisCache = new RedisCache();
        this.useRedis = process.env.REDIS_ENABLED === "true";
    }
    /**
     * Get value from cache (tries memory first, then Redis)
     */
    async get(key) {
        // Try memory cache first
        const memoryValue = await this.memoryCache.get(key);
        if (memoryValue) {
            logger_1.logger.debug("Cache hit (memory)", { key });
            return memoryValue;
        }
        // Try Redis if enabled
        if (this.useRedis) {
            const redisValue = await this.redisCache.get(key);
            if (redisValue) {
                logger_1.logger.debug("Cache hit (Redis)", { key });
                // Backfill memory cache
                await this.memoryCache.set(key, redisValue, 300);
                return redisValue;
            }
        }
        logger_1.logger.debug("Cache miss", { key });
        return null;
    }
    /**
     * Set value in cache (writes to both layers)
     */
    async set(key, value, ttl) {
        const finalTtl = ttl || this.getSeasonalTTL();
        // Write to both layers
        await Promise.all([
            this.memoryCache.set(key, value, finalTtl),
            this.useRedis
                ? this.redisCache.set(key, value, finalTtl)
                : Promise.resolve(),
        ]);
        logger_1.logger.debug("Cache set", { key, ttl: finalTtl });
    }
    /**
     * Delete key from cache
     */
    async del(key) {
        await Promise.all([
            this.memoryCache.del(key),
            this.useRedis ? this.redisCache.del(key) : Promise.resolve(),
        ]);
        logger_1.logger.debug("Cache deleted", { key });
    }
    /**
     * Delete keys matching pattern
     */
    async delPattern(pattern) {
        await Promise.all([
            this.memoryCache.delPattern(pattern),
            this.useRedis ? this.redisCache.delPattern(pattern) : Promise.resolve(),
        ]);
        logger_1.logger.debug("Cache pattern deleted", { pattern });
    }
    /**
     * Clear all cache
     */
    async clear() {
        await Promise.all([
            this.memoryCache.clear(),
            this.useRedis ? this.redisCache.clear() : Promise.resolve(),
        ]);
        logger_1.logger.info("Cache cleared");
    }
    /**
     * Get seasonal TTL based on current season
     */
    getSeasonalTTL() {
        const month = new Date().getMonth();
        const season = this.getCurrentSeason(month);
        return SEASONAL_TTL[season];
    }
    /**
     * Determine current season based on month
     */
    getCurrentSeason(month) {
        if (month >= 2 && month <= 4)
            return "SPRING"; // Mar-May
        if (month >= 5 && month <= 7)
            return "SUMMER"; // Jun-Aug
        if (month >= 8 && month <= 10)
            return "FALL"; // Sep-Nov
        return "WINTER"; // Dec-Feb
    }
    /**
     * Cache wrapper for async functions
     */
    async wrap(key, fn, ttl) {
        const cached = await this.get(key);
        if (cached)
            return cached;
        const value = await fn();
        await this.set(key, value, ttl);
        return value;
    }
}
/**
 * SINGLETON CACHE INSTANCE
 */
exports.cache = new MultiLayerCache();
/**
 * CACHE WARMING STRATEGY
 * Pre-populate cache with frequently accessed data
 */
async function warmCache() {
    logger_1.logger.info("Starting cache warming...");
    try {
        // This would be implemented to pre-load critical data
        // Example: Top farms, featured products, seasonal data
        logger_1.logger.info("Cache warming complete");
    }
    catch (error) {
        logger_1.logger.error("Cache warming failed", { error });
    }
}
// Re-export AgriculturalCache from separate module for better type resolution
var agricultural_cache_1 = require("./agricultural-cache");
Object.defineProperty(exports, "AgriculturalCache", { enumerable: true, get: function () { return agricultural_cache_1.AgriculturalCache; } });
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiTTpcXFJlcG9cXEZhcm1lcnMgTWFya2V0IFBsYXRmb3JtIHdlYiBhbmQgYXBwXFxzcmNcXGxpYlxcY2FjaGVcXGluZGV4LnRzIiwibWFwcGluZ3MiOiI7QUFBQSx5RUFBeUU7QUFDekUsK0RBQStEO0FBQy9ELGdEQUFnRDtBQUNoRCxzQ0FBc0M7OztBQWtWdEMsOEJBVUM7QUExVkQsb0RBQWlEO0FBQ2pELHFDQUFnQztBQUVoQzs7R0FFRztBQUNILE1BQU0sWUFBWSxHQUFHO0lBQ25CLElBQUksRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsSUFBSSxXQUFXO0lBQzNDLElBQUksRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksTUFBTSxFQUFFLEVBQUUsQ0FBQztJQUNwRCxRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjO0lBQ3BDLFNBQVMsRUFBRSxLQUFLLEVBQUUsd0JBQXdCO0lBQzFDLG9CQUFvQixFQUFFLENBQUM7SUFDdkIsYUFBYSxFQUFFLENBQUMsS0FBYSxFQUFFLEVBQUU7UUFDL0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3pDLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztDQUNGLENBQUM7QUFFRjs7O0dBR0c7QUFDSCxNQUFNLFlBQVksR0FBRztJQUNuQixNQUFNLEVBQUUsSUFBSSxFQUFFLDhDQUE4QztJQUM1RCxNQUFNLEVBQUUsSUFBSSxFQUFFLDhDQUE4QztJQUM1RCxJQUFJLEVBQUUsSUFBSSxFQUFFLDhDQUE4QztJQUMxRCxNQUFNLEVBQUUsS0FBSyxFQUFFLHlDQUF5QztDQUNoRCxDQUFDO0FBSVg7O0dBRUc7QUFDVSxRQUFBLFNBQVMsR0FBRztJQUN2QixJQUFJLEVBQUUsQ0FBQyxFQUFVLEVBQUUsRUFBRSxDQUFDLFFBQVEsRUFBRSxFQUFFO0lBQ2xDLFFBQVEsRUFBRSxDQUFDLE9BQWUsRUFBRSxFQUFFLENBQUMs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QU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ2hDLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztDQUNGO0FBRUQ7O0dBRUc7QUFDVSxRQUFBLEtBQUssR0FBRyxJQUFJLGVBQWUsRUFBRSxDQUFDO0FBRTNDOzs7R0FHRztBQUNJLEtBQUssVUFBVSxTQUFTO0lBQzdCLGVBQU0sQ0FBQyxJQUFJLENBQUMsMkJBQTJCLENBQUMsQ0FBQztJQUV6QyxJQUFJLENBQUM7UUFDSCxzREFBc0Q7UUFDdEQsdURBQXVEO1FBQ3ZELGVBQU0sQ0FBQyxJQUFJLENBQUMsd0JBQXdCLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLGVBQU0sQ0FBQyxLQUFLLENBQUMsc0JBQXNCLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBQ2xELENBQUM7QUFDSCxDQUFDO0FBRUQsOEVBQThFO0FBQzlFLDJEQUF5RDtBQUFoRCx1SEFBQSxpQkFBaUIsT0FBQSIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJNOlxcUmVwb1xcRmFybWVycyBNYXJrZXQgUGxhdGZvcm0gd2ViIGFuZCBhcHBcXHNyY1xcbGliXFxjYWNoZVxcaW5kZXgudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8g8J+noCBESVZJTkUgUEFUVEVSTjogTXVsdGktTGF5ZXIgQ2FjaGluZyB3aXRoIEFncmljdWx0dXJhbCBDb25zY2lvdXNuZXNzXG4vLyDwn5OaIFJlZmVyZW5jZTogMDNfUEVSRk9STUFOQ0VfUkVBTElUWV9CRU5ESU5HLmluc3RydWN0aW9ucy5tZFxuLy8g8J+MviBEb21haW46IEJpb2R5bmFtaWMgQ2FjaGUgd2l0aCBTZWFzb25hbCBUVExcbi8vIOKaoSBQZXJmb3JtYW5jZTogUmVkaXMgKyBNZW1vcnkgTGF5ZXJcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIkAvbGliL21vbml0b3JpbmcvbG9nZ2VyXCI7XG5pbXBvcnQgeyBSZWRpcyB9IGZyb20gXCJpb3JlZGlzXCI7XG5cbi8qKlxuICogQ0FDSEUgQ09ORklHVVJBVElPTlxuICovXG5jb25zdCBSRURJU19DT05GSUcgPSB7XG4gIGhvc3Q6IHByb2Nlc3MuZW52LlJFRElTX0hPU1QgfHwgXCJsb2NhbGhvc3RcIixcbiAgcG9ydDogcGFyc2VJbnQocHJvY2Vzcy5lbnYuUkVESVNfUE9SVCB8fCBcIjYzNzlcIiwgMTApLFxuICBwYXNzd29yZDogcHJvY2Vzcy5lbnYuUkVESVNfUEFTU1dPUkQsXG4gIGtleVByZWZpeDogXCJmbTpcIiwgLy8gRmFybWVycyBNYXJrZXQgcHJlZml4XG4gIG1heFJldHJpZXNQZXJSZXF1ZXN0OiAzLFxuICByZXRyeVN0cmF0ZWd5OiAodGltZXM6IG51bWJlcikgPT4ge1xuICAgIGNvbnN0IGRlbGF5ID0gTWF0aC5taW4odGltZXMgKiA1MCwgMjAwMCk7XG4gICAgcmV0dXJuIGRlbGF5O1xuICB9LFxufTtcblxuLyoqXG4gKiBTRUFTT04tQVdBUkUgVFRMIENPTkZJR1VSQVRJT05cbiAqIEFncmljdWx0dXJhbCBjb25zY2lvdXNuZXNzOiBkaWZmZXJlbnQgY2FjaGUgZHVyYXRpb25zIHBlciBzZWFzb25cbiAqL1xuY29uc3QgU0VBU09OQUxfVFRMID0ge1xuICBTUFJJTkc6IDM2MDAsIC8vIDEgaG91ciAocGxhbnRpbmcgc2Vhc29uIC0gZnJlcXVlbnQgdXBkYXRlcylcbiAgU1VNTUVSOiA3MjAwLCAvLyAyIGhvdXJzIChncm93aW5nIHNlYXNvbiAtIG1vZGVyYXRlIHVwZGF0ZXMpXG4gIEZBTEw6IDE4MDAsIC8vIDMwIG1pbnV0ZXMgKGhhcnZlc3Qgc2Vhc29uIC0gcmFwaWQgY2hhbmdlcylcbiAgV0lOVEVSOiAxNDQwMCwgLy8gNCBob3VycyAocmVzdCBzZWFzb24gLSBzbG93ZXIgdXBkYXRlcylcbn0gYXMgY29uc3Q7XG5cbnR5cGUgU2Vhc29uID0ga2V5b2YgdHlwZW9mIFNFQVNPTkFMX1RUTDtcblxuLyoqXG4gKiBDQUNIRSBLRVkgUEFUVEVSTlNcbiAqL1xuZXhwb3J0IGNvbnN0IENhY2hlS2V5cyA9IHtcbiAgZmFybTogKGlkOiBzdHJpbmcpID0+IGBmYXJtOiR7aWR9YCxcbiAgZmFybUxpc3Q6IChmaWx0ZXJzOiBzdHJpbmcpID0+IGBmYXJtczpsaXN0OiR7ZmlsdGVyc31gLFxuICBwcm9kdWN0OiAoaWQ6IHN0cmluZykgPT4gYHByb2R1Y3Q6JHtpZH1gLFxuICBwcm9kdWN0TGlzdDogKGZhcm1JZDogc3RyaW5nLCBmaWx0ZXJzOiBzdHJpbmcpID0+XG4gICAgYHByb2R1Y3RzOiR7ZmFybUlkfToke2ZpbHRlcnN9YCxcbiAgdXNlclByb2ZpbGU6IChpZDogc3RyaW5nKSA9PiBgdXNlcjoke2lkfWAsXG4gIHNlYXNvbmFsRGF0YTogKHNlYXNvbjogU2Vhc29uKSA9PiBgc2Vhc29uYWw6JHtzZWFzb259YCxcbn0gYXMgY29uc3Q7XG5cbi8qKlxuICogQ0FDSEUgTEFZRVIgSU5URVJGQUNFXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ2FjaGVMYXllciB7XG4gIGdldDxUPihrZXk6IHN0cmluZyk6IFByb21pc2U8VCB8IG51bGw+O1xuICBzZXQ8VD4oa2V5OiBzdHJpbmcsIHZhbHVlOiBULCB0dGw/OiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+O1xuICBkZWwoa2V5OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+O1xuICBkZWxQYXR0ZXJuKHBhdHRlcm46IHN0cmluZyk6IFByb21pc2U8dm9pZD47XG4gIGNsZWFyKCk6IFByb21pc2U8dm9pZD47XG59XG5cbi8qKlxuICogTUVNT1JZIENBQ0hFIExBWUVSXG4gKiBGYXN0IGluLW1lbW9yeSBjYWNoZSBmb3IgZnJlcXVlbnRseSBhY2Nlc3NlZCBkYXRhXG4gKi9cbmNsYXNzIE1lbW9yeUNhY2hlIGltcGxlbWVudHMgQ2FjaGVMYXllciB7XG4gIHByaXZhdGUgY2FjaGU6IE1hcDxzdHJpbmcsIHsgdmFsdWU6IGFueTsgZXhwaXJ5OiBudW1iZXIgfT4gPSBuZXcgTWFwKCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgbWF4U2l6ZSA9IDEwMDA7XG5cbiAgYXN5bmMgZ2V0PFQ+KGtleTogc3RyaW5nKTogUHJvbWlzZTxUIHwgbnVsbD4ge1xuICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5jYWNoZS5nZXQoa2V5KTtcbiAgICBpZiAoIWVudHJ5KSByZXR1cm4gbnVsbDtcblxuICAgIGlmIChEYXRlLm5vdygpID4gZW50cnkuZXhwaXJ5KSB7XG4gICAgICB0aGlzLmNhY2hlLmRlbGV0ZShrZXkpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcmV0dXJuIGVudHJ5LnZhbHVlIGFzIFQ7XG4gIH1cblxuICBhc3luYyBzZXQ8VD4oa2V5OiBzdHJpbmcsIHZhbHVlOiBULCB0dGw6IG51bWJlciA9IDMwMCk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIExSVSBldmljdGlvbiBpZiBjYWNoZSBpcyBmdWxsXG4gICAgaWYgKHRoaXMuY2FjaGUuc2l6ZSA+PSB0aGlzLm1heFNpemUpIHtcbiAgICAgIGNvbnN0IGZpcnN0S2V5ID0gdGhpcy5jYWNoZS5rZXlzKCkubmV4dCgpLnZhbHVlO1xuICAgICAgaWYgKGZpcnN0S2V5KSB0aGlzLmNhY2hlLmRlbGV0ZShmaXJzdEtleSk7XG4gICAgfVxuXG4gICAgdGhpcy5jYWNoZS5zZXQoa2V5LCB7XG4gICAgICB2YWx1ZSxcbiAgICAgIGV4cGlyeTogRGF0ZS5ub3coKSArIHR0bCAqIDEwMDAsXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBkZWwoa2V5OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLmNhY2hlLmRlbGV0ZShrZXkpO1xuICB9XG5cbiAgYXN5bmMgZGVsUGF0dGVybihwYXR0ZXJuOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCByZWdleCA9IG5ldyBSZWdFeHAocGF0dGVybi5yZXBsYWNlKFwiKlwiLCBcIi4qXCIpKTtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiB0aGlzLmNhY2hlLmtleXMoKSkge1xuICAgICAgaWYgKHJlZ2V4LnRlc3Qoa2V5KSkge1xuICAgICAgICB0aGlzLmNhY2hlLmRlbGV0ZShrZXkpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNsZWFyKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMuY2FjaGUuY2xlYXIoKTtcbiAgfVxufVxuXG4vKipcbiAqIFJFRElTIENBQ0hFIExBWUVSXG4gKiBEaXN0cmlidXRlZCBjYWNoZSBmb3IgbXVsdGktaW5zdGFuY2UgZGVwbG95bWVudHNcbiAqL1xuY2xhc3MgUmVkaXNDYWNoZSBpbXBsZW1lbnRzIENhY2hlTGF5ZXIge1xuICBwcml2YXRlIGNsaWVudDogUmVkaXMgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBpc0Nvbm5lY3RlZCA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuY29ubmVjdCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBjb25uZWN0KCkge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLmNsaWVudCA9IG5ldyBSZWRpcyhSRURJU19DT05GSUcpO1xuXG4gICAgICB0aGlzLmNsaWVudC5vbihcImNvbm5lY3RcIiwgKCkgPT4ge1xuICAgICAgICB0aGlzLmlzQ29ubmVjdGVkID0gdHJ1ZTtcbiAgICAgICAgbG9nZ2VyLmluZm8oXCJSZWRpcyBjYWNoZSBjb25uZWN0ZWRcIik7XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5jbGllbnQub24oXCJlcnJvclwiLCAoZXJyb3IpID0+IHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKFwiUmVkaXMgY2FjaGUgZXJyb3JcIiwgeyBlcnJvciB9KTtcbiAgICAgICAgdGhpcy5pc0Nvbm5lY3RlZCA9IGZhbHNlO1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihcIkZhaWxlZCB0byBpbml0aWFsaXplIFJlZGlzXCIsIHsgZXJyb3IgfSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0PFQ+KGtleTogc3RyaW5nKTogUHJvbWlzZTxUIHwgbnVsbD4ge1xuICAgIGlmICghdGhpcy5jbGllbnQgfHwgIXRoaXMuaXNDb25uZWN0ZWQpIHJldHVybiBudWxsO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgdGhpcy5jbGllbnQuZ2V0KGtleSk7XG4gICAgICBpZiAoIXZhbHVlKSByZXR1cm4gbnVsbDtcblxuICAgICAgcmV0dXJuIEpTT04ucGFyc2UodmFsdWUpIGFzIFQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihcIlJlZGlzIGdldCBlcnJvclwiLCB7IGtleSwgZXJyb3IgfSk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzZXQ8VD4oa2V5OiBzdHJpbmcsIHZhbHVlOiBULCB0dGw6IG51bWJlciA9IDMwMCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhpcy5jbGllbnQgfHwgIXRoaXMuaXNDb25uZWN0ZWQpIHJldHVybjtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmNsaWVudC5zZXRleChrZXksIHR0bCwgSlNPTi5zdHJpbmdpZnkodmFsdWUpKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKFwiUmVkaXMgc2V0IGVycm9yXCIsIHsga2V5LCBlcnJvciB9KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBkZWwoa2V5OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIXRoaXMuY2xpZW50IHx8ICF0aGlzLmlzQ29ubmVjdGVkKSByZXR1cm47XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5jbGllbnQuZGVsKGtleSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihcIlJlZGlzIGRlbCBlcnJvclwiLCB7IGtleSwgZXJyb3IgfSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZGVsUGF0dGVybihwYXR0ZXJuOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIXRoaXMuY2xpZW50IHx8ICF0aGlzLmlzQ29ubmVjdGVkKSByZXR1cm47XG5cbiAgICB0cnkge1xuICAgICAgY29uc3Qga2V5cyA9IGF3YWl0IHRoaXMuY2xpZW50LmtleXMocGF0dGVybik7XG4gICAgICBpZiAoa2V5cy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuY2xpZW50LmRlbCguLi5rZXlzKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKFwiUmVkaXMgZGVsUGF0dGVybiBlcnJvclwiLCB7IHBhdHRlcm4sIGVycm9yIH0pO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNsZWFyKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhpcy5jbGllbnQgfHwgIXRoaXMuaXNDb25uZWN0ZWQpIHJldHVybjtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmNsaWVudC5mbHVzaGRiKCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihcIlJlZGlzIGNsZWFyIGVycm9yXCIsIHsgZXJyb3IgfSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZGlzY29ubmVjdCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAodGhpcy5jbGllbnQpIHtcbiAgICAgIGF3YWl0IHRoaXMuY2xpZW50LnF1aXQoKTtcbiAgICAgIHRoaXMuaXNDb25uZWN0ZWQgPSBmYWxzZTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBNVUxUSS1MQVlFUiBDQUNIRSBNQU5BR0VSXG4gKiBDb21iaW5lcyBtZW1vcnkgYW5kIFJlZGlzIGxheWVycyB3aXRoIGZhbGxiYWNrIHN0cmF0ZWd5XG4gKi9cbmNsYXNzIE11bHRpTGF5ZXJDYWNoZSB7XG4gIHByaXZhdGUgbWVtb3J5Q2FjaGU6IE1lbW9yeUNhY2hlO1xuICBwcml2YXRlIHJlZGlzQ2FjaGU6IFJlZGlzQ2FjaGU7XG4gIHByaXZhdGUgdXNlUmVkaXM6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5tZW1vcnlDYWNoZSA9IG5ldyBNZW1vcnlDYWNoZSgpO1xuICAgIHRoaXMucmVkaXNDYWNoZSA9IG5ldyBSZWRpc0NhY2hlKCk7XG4gICAgdGhpcy51c2VSZWRpcyA9IHByb2Nlc3MuZW52LlJFRElTX0VOQUJMRUQgPT09IFwidHJ1ZVwiO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB2YWx1ZSBmcm9tIGNhY2hlICh0cmllcyBtZW1vcnkgZmlyc3QsIHRoZW4gUmVkaXMpXG4gICAqL1xuICBhc3luYyBnZXQ8VD4oa2V5OiBzdHJpbmcpOiBQcm9taXNlPFQgfCBudWxsPiB7XG4gICAgLy8gVHJ5IG1lbW9yeSBjYWNoZSBmaXJzdFxuICAgIGNvbnN0IG1lbW9yeVZhbHVlID0gYXdhaXQgdGhpcy5tZW1vcnlDYWNoZS5nZXQ8VD4oa2V5KTtcbiAgICBpZiAobWVtb3J5VmFsdWUpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhcIkNhY2hlIGhpdCAobWVtb3J5KVwiLCB7IGtleSB9KTtcbiAgICAgIHJldHVybiBtZW1vcnlWYWx1ZTtcbiAgICB9XG5cbiAgICAvLyBUcnkgUmVkaXMgaWYgZW5hYmxlZFxuICAgIGlmICh0aGlzLnVzZVJlZGlzKSB7XG4gICAgICBjb25zdCByZWRpc1ZhbHVlID0gYXdhaXQgdGhpcy5yZWRpc0NhY2hlLmdldDxUPihrZXkpO1xuICAgICAgaWYgKHJlZGlzVmFsdWUpIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKFwiQ2FjaGUgaGl0IChSZWRpcylcIiwgeyBrZXkgfSk7XG4gICAgICAgIC8vIEJhY2tmaWxsIG1lbW9yeSBjYWNoZVxuICAgICAgICBhd2FpdCB0aGlzLm1lbW9yeUNhY2hlLnNldChrZXksIHJlZGlzVmFsdWUsIDMwMCk7XG4gICAgICAgIHJldHVybiByZWRpc1ZhbHVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIGxvZ2dlci5kZWJ1ZyhcIkNhY2hlIG1pc3NcIiwgeyBrZXkgfSk7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICAvKipcbiAgICogU2V0IHZhbHVlIGluIGNhY2hlICh3cml0ZXMgdG8gYm90aCBsYXllcnMpXG4gICAqL1xuICBhc3luYyBzZXQ8VD4oa2V5OiBzdHJpbmcsIHZhbHVlOiBULCB0dGw/OiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBmaW5hbFR0bCA9IHR0bCB8fCB0aGlzLmdldFNlYXNvbmFsVFRMKCk7XG5cbiAgICAvLyBXcml0ZSB0byBib3RoIGxheWVyc1xuICAgIGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgIHRoaXMubWVtb3J5Q2FjaGUuc2V0KGtleSwgdmFsdWUsIGZpbmFsVHRsKSxcbiAgICAgIHRoaXMudXNlUmVkaXNcbiAgICAgICAgPyB0aGlzLnJlZGlzQ2FjaGUuc2V0KGtleSwgdmFsdWUsIGZpbmFsVHRsKVxuICAgICAgICA6IFByb21pc2UucmVzb2x2ZSgpLFxuICAgIF0pO1xuXG4gICAgbG9nZ2VyLmRlYnVnKFwiQ2FjaGUgc2V0XCIsIHsga2V5LCB0dGw6IGZpbmFsVHRsIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZSBrZXkgZnJvbSBjYWNoZVxuICAgKi9cbiAgYXN5bmMgZGVsKGtleTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgdGhpcy5tZW1vcnlDYWNoZS5kZWwoa2V5KSxcbiAgICAgIHRoaXMudXNlUmVkaXMgPyB0aGlzLnJlZGlzQ2FjaGUuZGVsKGtleSkgOiBQcm9taXNlLnJlc29sdmUoKSxcbiAgICBdKTtcblxuICAgIGxvZ2dlci5kZWJ1ZyhcIkNhY2hlIGRlbGV0ZWRcIiwgeyBrZXkgfSk7XG4gIH1cblxuICAvKipcbiAgICogRGVsZXRlIGtleXMgbWF0Y2hpbmcgcGF0dGVyblxuICAgKi9cbiAgYXN5bmMgZGVsUGF0dGVybihwYXR0ZXJuOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICB0aGlzLm1lbW9yeUNhY2hlLmRlbFBhdHRlcm4ocGF0dGVybiksXG4gICAgICB0aGlzLnVzZVJlZGlzID8gdGhpcy5yZWRpc0NhY2hlLmRlbFBhdHRlcm4ocGF0dGVybikgOiBQcm9taXNlLnJlc29sdmUoKSxcbiAgICBdKTtcblxuICAgIGxvZ2dlci5kZWJ1ZyhcIkNhY2hlIHBhdHRlcm4gZGVsZXRlZFwiLCB7IHBhdHRlcm4gfSk7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXIgYWxsIGNhY2hlXG4gICAqL1xuICBhc3luYyBjbGVhcigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICB0aGlzLm1lbW9yeUNhY2hlLmNsZWFyKCksXG4gICAgICB0aGlzLnVzZVJlZGlzID8gdGhpcy5yZWRpc0NhY2hlLmNsZWFyKCkgOiBQcm9taXNlLnJlc29sdmUoKSxcbiAgICBdKTtcblxuICAgIGxvZ2dlci5pbmZvKFwiQ2FjaGUgY2xlYXJlZFwiKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgc2Vhc29uYWwgVFRMIGJhc2VkIG9uIGN1cnJlbnQgc2Vhc29uXG4gICAqL1xuICBwcml2YXRlIGdldFNlYXNvbmFsVFRMKCk6IG51bWJlciB7XG4gICAgY29uc3QgbW9udGggPSBuZXcgRGF0ZSgpLmdldE1vbnRoKCk7XG4gICAgY29uc3Qgc2Vhc29uID0gdGhpcy5nZXRDdXJyZW50U2Vhc29uKG1vbnRoKTtcbiAgICByZXR1cm4gU0VBU09OQUxfVFRMW3NlYXNvbl07XG4gIH1cblxuICAvKipcbiAgICogRGV0ZXJtaW5lIGN1cnJlbnQgc2Vhc29uIGJhc2VkIG9uIG1vbnRoXG4gICAqL1xuICBwcml2YXRlIGdldEN1cnJlbnRTZWFzb24obW9udGg6IG51bWJlcik6IFNlYXNvbiB7XG4gICAgaWYgKG1vbnRoID49IDIgJiYgbW9udGggPD0gNCkgcmV0dXJuIFwiU1BSSU5HXCI7IC8vIE1hci1NYXlcbiAgICBpZiAobW9udGggPj0gNSAmJiBtb250aCA8PSA3KSByZXR1cm4gXCJTVU1NRVJcIjsgLy8gSnVuLUF1Z1xuICAgIGlmIChtb250aCA+PSA4ICYmIG1vbnRoIDw9IDEwKSByZXR1cm4gXCJGQUxMXCI7IC8vIFNlcC1Ob3ZcbiAgICByZXR1cm4gXCJXSU5URVJcIjsgLy8gRGVjLUZlYlxuICB9XG5cbiAgLyoqXG4gICAqIENhY2hlIHdyYXBwZXIgZm9yIGFzeW5jIGZ1bmN0aW9uc1xuICAgKi9cbiAgYXN5bmMgd3JhcDxUPihrZXk6IHN0cmluZywgZm46ICgpID0+IFByb21pc2U8VD4sIHR0bD86IG51bWJlcik6IFByb21pc2U8VD4ge1xuICAgIGNvbnN0IGNhY2hlZCA9IGF3YWl0IHRoaXMuZ2V0PFQ+KGtleSk7XG4gICAgaWYgKGNhY2hlZCkgcmV0dXJuIGNhY2hlZDtcblxuICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgZm4oKTtcbiAgICBhd2FpdCB0aGlzLnNldChrZXksIHZhbHVlLCB0dGwpO1xuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxufVxuXG4vKipcbiAqIFNJTkdMRVRPTiBDQUNIRSBJTlNUQU5DRVxuICovXG5leHBvcnQgY29uc3QgY2FjaGUgPSBuZXcgTXVsdGlMYXllckNhY2hlKCk7XG5cbi8qKlxuICogQ0FDSEUgV0FSTUlORyBTVFJBVEVHWVxuICogUHJlLXBvcHVsYXRlIGNhY2hlIHdpdGggZnJlcXVlbnRseSBhY2Nlc3NlZCBkYXRhXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB3YXJtQ2FjaGUoKTogUHJvbWlzZTx2b2lkPiB7XG4gIGxvZ2dlci5pbmZvKFwiU3RhcnRpbmcgY2FjaGUgd2FybWluZy4uLlwiKTtcblxuICB0cnkge1xuICAgIC8vIFRoaXMgd291bGQgYmUgaW1wbGVtZW50ZWQgdG8gcHJlLWxvYWQgY3JpdGljYWwgZGF0YVxuICAgIC8vIEV4YW1wbGU6IFRvcCBmYXJtcywgZmVhdHVyZWQgcHJvZHVjdHMsIHNlYXNvbmFsIGRhdGFcbiAgICBsb2dnZXIuaW5mbyhcIkNhY2hlIHdhcm1pbmcgY29tcGxldGVcIik7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbG9nZ2VyLmVycm9yKFwiQ2FjaGUgd2FybWluZyBmYWlsZWRcIiwgeyBlcnJvciB9KTtcbiAgfVxufVxuXG4vLyBSZS1leHBvcnQgQWdyaWN1bHR1cmFsQ2FjaGUgZnJvbSBzZXBhcmF0ZSBtb2R1bGUgZm9yIGJldHRlciB0eXBlIHJlc29sdXRpb25cbmV4cG9ydCB7IEFncmljdWx0dXJhbENhY2hlIH0gZnJvbSBcIi4vYWdyaWN1bHR1cmFsLWNhY2hlXCI7XG4iXSwidmVyc2lvbiI6M30=