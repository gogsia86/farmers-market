bfe192920905cf9d0dffa7bbc65e8ab3
"use strict";
/**
 * ðŸ›¡ï¸ RATE LIMITING UTILITY
 * Protects against brute force attacks and API abuse
 *
 * Features:
 * - IP-based rate limiting
 * - Configurable time windows
 * - Memory storage (upgrade to Redis in production)
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.SENSITIVE_RATE_LIMIT = exports.API_RATE_LIMIT = exports.LOGIN_RATE_LIMIT = void 0;
exports.checkRateLimit = checkRateLimit;
exports.getClientIp = getClientIp;
exports.resetRateLimit = resetRateLimit;
exports.getRateLimitStatus = getRateLimitStatus;
exports.clearAllRateLimits = clearAllRateLimits;
// In-memory store (use Redis in production for distributed systems)
const store = {};
// Cleanup old entries every minute
setInterval(() => {
    const now = Date.now();
    Object.keys(store).forEach((key) => {
        const entry = store[key];
        if (entry && entry.resetTime < now) {
            delete store[key];
        }
    });
}, 60000);
/**
 * Check if a request should be rate limited
 *
 * @param identifier - Unique identifier (IP address, user ID, etc.)
 * @param config - Rate limit configuration
 * @returns Rate limit result
 */
function checkRateLimit(identifier, config) {
    const now = Date.now();
    const key = `${identifier}:${config.windowMs}`;
    // Get or create entry
    if (!store[key] || store[key].resetTime < now) {
        store[key] = {
            count: 1,
            resetTime: now + config.windowMs,
        };
        const allowed = 1 <= config.maxRequests;
        return {
            allowed,
            remaining: Math.max(0, config.maxRequests - 1),
            resetTime: Math.ceil(config.windowMs / 1000),
            current: 1,
            limit: config.maxRequests,
        };
    }
    // Increment count
    store[key].count++;
    const allowed = store[key].count <= config.maxRequests;
    const remaining = Math.max(0, config.maxRequests - store[key].count);
    const resetTime = Math.ceil((store[key].resetTime - now) / 1000);
    return {
        allowed,
        remaining,
        resetTime,
        current: store[key].count,
        limit: config.maxRequests,
    };
}
/**
 * Middleware helper to get client IP address
 */
function getClientIp(request) {
    // Check various headers for the real IP (in case behind proxy/CDN)
    const headers = request.headers;
    return ((headers.get("x-forwarded-for")?.split(",")[0] ?? "").trim() ||
        headers.get("x-real-ip") ||
        headers.get("cf-connecting-ip") || // Cloudflare
        headers.get("x-client-ip") ||
        "unknown");
}
/**
 * Pre-configured rate limit for login attempts
 * 5 attempts per 15 minutes per IP
 */
exports.LOGIN_RATE_LIMIT = {
    maxRequests: 5,
    windowMs: 15 * 60 * 1000, // 15 minutes
};
/**
 * Pre-configured rate limit for API endpoints
 * 100 requests per minute per IP
 */
exports.API_RATE_LIMIT = {
    maxRequests: 100,
    windowMs: 60 * 1000, // 1 minute
};
/**
 * Pre-configured rate limit for sensitive operations
 * 10 requests per hour per user
 */
exports.SENSITIVE_RATE_LIMIT = {
    maxRequests: 10,
    windowMs: 60 * 60 * 1000, // 1 hour
};
/**
 * Reset rate limit for a specific identifier
 * Useful for testing or manual resets
 */
function resetRateLimit(identifier, windowMs) {
    const key = `${identifier}:${windowMs}`;
    delete store[key];
}
/**
 * Get current rate limit status without incrementing
 */
function getRateLimitStatus(identifier, config) {
    const now = Date.now();
    const key = `${identifier}:${config.windowMs}`;
    if (!store[key] || store[key].resetTime < now) {
        return null;
    }
    const remaining = Math.max(0, config.maxRequests - store[key].count);
    const resetTime = Math.ceil((store[key].resetTime - now) / 1000);
    return {
        allowed: store[key].count <= config.maxRequests,
        remaining,
        resetTime,
        current: store[key].count,
        limit: config.maxRequests,
    };
}
/**
 * Clear all rate limit data (for testing)
 */
function clearAllRateLimits() {
    Object.keys(store).forEach((key) => delete store[key]);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiTTpcXFJlcG9cXEZhcm1lcnMgTWFya2V0IFBsYXRmb3JtIHdlYiBhbmQgYXBwXFxzcmNcXGxpYlxccmF0ZS1saW1pdC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7O0dBUUc7OztBQTBFSCx3Q0F1Q0M7QUFLRCxrQ0FXQztBQWlDRCx3Q0FHQztBQUtELGdEQXFCQztBQUtELGdEQUVDO0FBN0xELG9FQUFvRTtBQUNwRSxNQUFNLEtBQUssR0FBbUIsRUFBRSxDQUFDO0FBRWpDLG1DQUFtQztBQUNuQyxXQUFXLENBQUMsR0FBRyxFQUFFO0lBQ2YsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ3ZCLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7UUFDakMsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3pCLElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxTQUFTLEdBQUcsR0FBRyxFQUFFLENBQUM7WUFDbkMsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDcEIsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBOENWOzs7Ozs7R0FNRztBQUNILFNBQWdCLGNBQWMsQ0FDNUIsVUFBa0IsRUFDbEIsTUFBdUI7SUFFdkIsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ3ZCLE1BQU0sR0FBRyxHQUFHLEdBQUcsVUFBVSxJQUFJLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUUvQyxzQkFBc0I7SUFDdEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsU0FBUyxHQUFHLEdBQUcsRUFBRSxDQUFDO1FBQzlDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRztZQUNYLEtBQUssRUFBRSxDQUFDO1lBQ1IsU0FBUyxF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VSxJQUFJLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUUvQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxTQUFTLEdBQUcsR0FBRyxFQUFFLENBQUM7UUFDOUMsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDckUsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxTQUFTLEdBQUcsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7SUFFakUsT0FBTztRQUNMLE9BQU8sRUFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxJQUFJLE1BQU0sQ0FBQyxXQUFXO1FBQy9DLFNBQVM7UUFDVCxTQUFTO1FBQ1QsT0FBTyxFQUFFLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLO1FBQ3pCLEtBQUssRUFBRSxNQUFNLENBQUMsV0FBVztLQUMxQixDQUFDO0FBQ0osQ0FBQztBQUVEOztHQUVHO0FBQ0gsU0FBZ0Isa0JBQWtCO0lBQ2hDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxPQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQ3pELENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiTTpcXFJlcG9cXEZhcm1lcnMgTWFya2V0IFBsYXRmb3JtIHdlYiBhbmQgYXBwXFxzcmNcXGxpYlxccmF0ZS1saW1pdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIPCfm6HvuI8gUkFURSBMSU1JVElORyBVVElMSVRZXG4gKiBQcm90ZWN0cyBhZ2FpbnN0IGJydXRlIGZvcmNlIGF0dGFja3MgYW5kIEFQSSBhYnVzZVxuICpcbiAqIEZlYXR1cmVzOlxuICogLSBJUC1iYXNlZCByYXRlIGxpbWl0aW5nXG4gKiAtIENvbmZpZ3VyYWJsZSB0aW1lIHdpbmRvd3NcbiAqIC0gTWVtb3J5IHN0b3JhZ2UgKHVwZ3JhZGUgdG8gUmVkaXMgaW4gcHJvZHVjdGlvbilcbiAqL1xuXG5pbnRlcmZhY2UgUmF0ZUxpbWl0U3RvcmUge1xuICBba2V5OiBzdHJpbmddOiB7XG4gICAgY291bnQ6IG51bWJlcjtcbiAgICByZXNldFRpbWU6IG51bWJlcjtcbiAgfTtcbn1cblxuLy8gSW4tbWVtb3J5IHN0b3JlICh1c2UgUmVkaXMgaW4gcHJvZHVjdGlvbiBmb3IgZGlzdHJpYnV0ZWQgc3lzdGVtcylcbmNvbnN0IHN0b3JlOiBSYXRlTGltaXRTdG9yZSA9IHt9O1xuXG4vLyBDbGVhbnVwIG9sZCBlbnRyaWVzIGV2ZXJ5IG1pbnV0ZVxuc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICBPYmplY3Qua2V5cyhzdG9yZSkuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgY29uc3QgZW50cnkgPSBzdG9yZVtrZXldO1xuICAgIGlmIChlbnRyeSAmJiBlbnRyeS5yZXNldFRpbWUgPCBub3cpIHtcbiAgICAgIGRlbGV0ZSBzdG9yZVtrZXldO1xuICAgIH1cbiAgfSk7XG59LCA2MDAwMCk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmF0ZUxpbWl0Q29uZmlnIHtcbiAgLyoqXG4gICAqIE1heGltdW0gbnVtYmVyIG9mIHJlcXVlc3RzIGFsbG93ZWQgaW4gdGhlIHRpbWUgd2luZG93XG4gICAqL1xuICBtYXhSZXF1ZXN0czogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBUaW1lIHdpbmRvdyBpbiBtaWxsaXNlY29uZHNcbiAgICovXG4gIHdpbmRvd01zOiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIEN1c3RvbSBpZGVudGlmaWVyIChkZWZhdWx0cyB0byBJUClcbiAgICovXG4gIGlkZW50aWZpZXI/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmF0ZUxpbWl0UmVzdWx0IHtcbiAgLyoqXG4gICAqIFdoZXRoZXIgdGhlIHJlcXVlc3QgaXMgYWxsb3dlZFxuICAgKi9cbiAgYWxsb3dlZDogYm9vbGVhbjtcblxuICAvKipcbiAgICogTnVtYmVyIG9mIHJlcXVlc3RzIHJlbWFpbmluZyBpbiBjdXJyZW50IHdpbmRvd1xuICAgKi9cbiAgcmVtYWluaW5nOiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIFRpbWUgdW50aWwgcmF0ZSBsaW1pdCByZXNldHMgKGluIHNlY29uZHMpXG4gICAqL1xuICByZXNldFRpbWU6IG51bWJlcjtcblxuICAvKipcbiAgICogQ3VycmVudCByZXF1ZXN0IGNvdW50XG4gICAqL1xuICBjdXJyZW50OiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIE1heGltdW0gcmVxdWVzdHMgYWxsb3dlZFxuICAgKi9cbiAgbGltaXQ6IG51bWJlcjtcbn1cblxuLyoqXG4gKiBDaGVjayBpZiBhIHJlcXVlc3Qgc2hvdWxkIGJlIHJhdGUgbGltaXRlZFxuICpcbiAqIEBwYXJhbSBpZGVudGlmaWVyIC0gVW5pcXVlIGlkZW50aWZpZXIgKElQIGFkZHJlc3MsIHVzZXIgSUQsIGV0Yy4pXG4gKiBAcGFyYW0gY29uZmlnIC0gUmF0ZSBsaW1pdCBjb25maWd1cmF0aW9uXG4gKiBAcmV0dXJucyBSYXRlIGxpbWl0IHJlc3VsdFxuICovXG5leHBvcnQgZnVuY3Rpb24gY2hlY2tSYXRlTGltaXQoXG4gIGlkZW50aWZpZXI6IHN0cmluZyxcbiAgY29uZmlnOiBSYXRlTGltaXRDb25maWdcbik6IFJhdGVMaW1pdFJlc3VsdCB7XG4gIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gIGNvbnN0IGtleSA9IGAke2lkZW50aWZpZXJ9OiR7Y29uZmlnLndpbmRvd01zfWA7XG5cbiAgLy8gR2V0IG9yIGNyZWF0ZSBlbnRyeVxuICBpZiAoIXN0b3JlW2tleV0gfHwgc3RvcmVba2V5XS5yZXNldFRpbWUgPCBub3cpIHtcbiAgICBzdG9yZVtrZXldID0ge1xuICAgICAgY291bnQ6IDEsXG4gICAgICByZXNldFRpbWU6IG5vdyArIGNvbmZpZy53aW5kb3dNcyxcbiAgICB9O1xuXG4gICAgY29uc3QgYWxsb3dlZCA9IDEgPD0gY29uZmlnLm1heFJlcXVlc3RzO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGFsbG93ZWQsXG4gICAgICByZW1haW5pbmc6IE1hdGgubWF4KDAsIGNvbmZpZy5tYXhSZXF1ZXN0cyAtIDEpLFxuICAgICAgcmVzZXRUaW1lOiBNYXRoLmNlaWwoY29uZmlnLndpbmRvd01zIC8gMTAwMCksXG4gICAgICBjdXJyZW50OiAxLFxuICAgICAgbGltaXQ6IGNvbmZpZy5tYXhSZXF1ZXN0cyxcbiAgICB9O1xuICB9XG5cbiAgLy8gSW5jcmVtZW50IGNvdW50XG4gIHN0b3JlW2tleV0uY291bnQrKztcblxuICBjb25zdCBhbGxvd2VkID0gc3RvcmVba2V5XS5jb3VudCA8PSBjb25maWcubWF4UmVxdWVzdHM7XG4gIGNvbnN0IHJlbWFpbmluZyA9IE1hdGgubWF4KDAsIGNvbmZpZy5tYXhSZXF1ZXN0cyAtIHN0b3JlW2tleV0uY291bnQpO1xuICBjb25zdCByZXNldFRpbWUgPSBNYXRoLmNlaWwoKHN0b3JlW2tleV0ucmVzZXRUaW1lIC0gbm93KSAvIDEwMDApO1xuXG4gIHJldHVybiB7XG4gICAgYWxsb3dlZCxcbiAgICByZW1haW5pbmcsXG4gICAgcmVzZXRUaW1lLFxuICAgIGN1cnJlbnQ6IHN0b3JlW2tleV0uY291bnQsXG4gICAgbGltaXQ6IGNvbmZpZy5tYXhSZXF1ZXN0cyxcbiAgfTtcbn1cblxuLyoqXG4gKiBNaWRkbGV3YXJlIGhlbHBlciB0byBnZXQgY2xpZW50IElQIGFkZHJlc3NcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldENsaWVudElwKHJlcXVlc3Q6IFJlcXVlc3QpOiBzdHJpbmcge1xuICAvLyBDaGVjayB2YXJpb3VzIGhlYWRlcnMgZm9yIHRoZSByZWFsIElQIChpbiBjYXNlIGJlaGluZCBwcm94eS9DRE4pXG4gIGNvbnN0IGhlYWRlcnMgPSByZXF1ZXN0LmhlYWRlcnM7XG5cbiAgcmV0dXJuIChcbiAgICAoaGVhZGVycy5nZXQoXCJ4LWZvcndhcmRlZC1mb3JcIik/LnNwbGl0KFwiLFwiKVswXSA/PyBcIlwiKS50cmltKCkgfHxcbiAgICBoZWFkZXJzLmdldChcIngtcmVhbC1pcFwiKSB8fFxuICAgIGhlYWRlcnMuZ2V0KFwiY2YtY29ubmVjdGluZy1pcFwiKSB8fCAvLyBDbG91ZGZsYXJlXG4gICAgaGVhZGVycy5nZXQoXCJ4LWNsaWVudC1pcFwiKSB8fFxuICAgIFwidW5rbm93blwiXG4gICk7XG59XG5cbi8qKlxuICogUHJlLWNvbmZpZ3VyZWQgcmF0ZSBsaW1pdCBmb3IgbG9naW4gYXR0ZW1wdHNcbiAqIDUgYXR0ZW1wdHMgcGVyIDE1IG1pbnV0ZXMgcGVyIElQXG4gKi9cbmV4cG9ydCBjb25zdCBMT0dJTl9SQVRFX0xJTUlUOiBSYXRlTGltaXRDb25maWcgPSB7XG4gIG1heFJlcXVlc3RzOiA1LFxuICB3aW5kb3dNczogMTUgKiA2MCAqIDEwMDAsIC8vIDE1IG1pbnV0ZXNcbn07XG5cbi8qKlxuICogUHJlLWNvbmZpZ3VyZWQgcmF0ZSBsaW1pdCBmb3IgQVBJIGVuZHBvaW50c1xuICogMTAwIHJlcXVlc3RzIHBlciBtaW51dGUgcGVyIElQXG4gKi9cbmV4cG9ydCBjb25zdCBBUElfUkFURV9MSU1JVDogUmF0ZUxpbWl0Q29uZmlnID0ge1xuICBtYXhSZXF1ZXN0czogMTAwLFxuICB3aW5kb3dNczogNjAgKiAxMDAwLCAvLyAxIG1pbnV0ZVxufTtcblxuLyoqXG4gKiBQcmUtY29uZmlndXJlZCByYXRlIGxpbWl0IGZvciBzZW5zaXRpdmUgb3BlcmF0aW9uc1xuICogMTAgcmVxdWVzdHMgcGVyIGhvdXIgcGVyIHVzZXJcbiAqL1xuZXhwb3J0IGNvbnN0IFNFTlNJVElWRV9SQVRFX0xJTUlUOiBSYXRlTGltaXRDb25maWcgPSB7XG4gIG1heFJlcXVlc3RzOiAxMCxcbiAgd2luZG93TXM6IDYwICogNjAgKiAxMDAwLCAvLyAxIGhvdXJcbn07XG5cbi8qKlxuICogUmVzZXQgcmF0ZSBsaW1pdCBmb3IgYSBzcGVjaWZpYyBpZGVudGlmaWVyXG4gKiBVc2VmdWwgZm9yIHRlc3Rpbmcgb3IgbWFudWFsIHJlc2V0c1xuICovXG5leHBvcnQgZnVuY3Rpb24gcmVzZXRSYXRlTGltaXQoaWRlbnRpZmllcjogc3RyaW5nLCB3aW5kb3dNczogbnVtYmVyKTogdm9pZCB7XG4gIGNvbnN0IGtleSA9IGAke2lkZW50aWZpZXJ9OiR7d2luZG93TXN9YDtcbiAgZGVsZXRlIHN0b3JlW2tleV07XG59XG5cbi8qKlxuICogR2V0IGN1cnJlbnQgcmF0ZSBsaW1pdCBzdGF0dXMgd2l0aG91dCBpbmNyZW1lbnRpbmdcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFJhdGVMaW1pdFN0YXR1cyhcbiAgaWRlbnRpZmllcjogc3RyaW5nLFxuICBjb25maWc6IFJhdGVMaW1pdENvbmZpZ1xuKTogUmF0ZUxpbWl0UmVzdWx0IHwgbnVsbCB7XG4gIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gIGNvbnN0IGtleSA9IGAke2lkZW50aWZpZXJ9OiR7Y29uZmlnLndpbmRvd01zfWA7XG5cbiAgaWYgKCFzdG9yZVtrZXldIHx8IHN0b3JlW2tleV0ucmVzZXRUaW1lIDwgbm93KSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBjb25zdCByZW1haW5pbmcgPSBNYXRoLm1heCgwLCBjb25maWcubWF4UmVxdWVzdHMgLSBzdG9yZVtrZXldLmNvdW50KTtcbiAgY29uc3QgcmVzZXRUaW1lID0gTWF0aC5jZWlsKChzdG9yZVtrZXldLnJlc2V0VGltZSAtIG5vdykgLyAxMDAwKTtcblxuICByZXR1cm4ge1xuICAgIGFsbG93ZWQ6IHN0b3JlW2tleV0uY291bnQgPD0gY29uZmlnLm1heFJlcXVlc3RzLFxuICAgIHJlbWFpbmluZyxcbiAgICByZXNldFRpbWUsXG4gICAgY3VycmVudDogc3RvcmVba2V5XS5jb3VudCxcbiAgICBsaW1pdDogY29uZmlnLm1heFJlcXVlc3RzLFxuICB9O1xufVxuXG4vKipcbiAqIENsZWFyIGFsbCByYXRlIGxpbWl0IGRhdGEgKGZvciB0ZXN0aW5nKVxuICovXG5leHBvcnQgZnVuY3Rpb24gY2xlYXJBbGxSYXRlTGltaXRzKCk6IHZvaWQge1xuICBPYmplY3Qua2V5cyhzdG9yZSkuZm9yRWFjaCgoa2V5KSA9PiBkZWxldGUgc3RvcmVba2V5XSk7XG59XG4iXSwidmVyc2lvbiI6M30=