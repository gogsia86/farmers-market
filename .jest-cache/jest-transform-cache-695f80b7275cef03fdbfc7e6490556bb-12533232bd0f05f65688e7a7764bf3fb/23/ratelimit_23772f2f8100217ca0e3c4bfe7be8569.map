{"file":"M:\\Repo\\Farmers Market Platform web and app\\src\\lib\\rate-limit.ts","mappings":"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","names":[],"sources":["M:\\Repo\\Farmers Market Platform web and app\\src\\lib\\rate-limit.ts"],"sourcesContent":["/**\n * ðŸ›¡ï¸ RATE LIMITING UTILITY\n * Protects against brute force attacks and API abuse\n *\n * Features:\n * - IP-based rate limiting\n * - Configurable time windows\n * - Memory storage (upgrade to Redis in production)\n */\n\ninterface RateLimitStore {\n  [key: string]: {\n    count: number;\n    resetTime: number;\n  };\n}\n\n// In-memory store (use Redis in production for distributed systems)\nconst store: RateLimitStore = {};\n\n// Cleanup old entries every minute\nsetInterval(() => {\n  const now = Date.now();\n  Object.keys(store).forEach((key) => {\n    const entry = store[key];\n    if (entry && entry.resetTime < now) {\n      delete store[key];\n    }\n  });\n}, 60000);\n\nexport interface RateLimitConfig {\n  /**\n   * Maximum number of requests allowed in the time window\n   */\n  maxRequests: number;\n\n  /**\n   * Time window in milliseconds\n   */\n  windowMs: number;\n\n  /**\n   * Custom identifier (defaults to IP)\n   */\n  identifier?: string;\n}\n\nexport interface RateLimitResult {\n  /**\n   * Whether the request is allowed\n   */\n  allowed: boolean;\n\n  /**\n   * Number of requests remaining in current window\n   */\n  remaining: number;\n\n  /**\n   * Time until rate limit resets (in seconds)\n   */\n  resetTime: number;\n\n  /**\n   * Current request count\n   */\n  current: number;\n\n  /**\n   * Maximum requests allowed\n   */\n  limit: number;\n}\n\n/**\n * Check if a request should be rate limited\n *\n * @param identifier - Unique identifier (IP address, user ID, etc.)\n * @param config - Rate limit configuration\n * @returns Rate limit result\n */\nexport function checkRateLimit(\n  identifier: string,\n  config: RateLimitConfig\n): RateLimitResult {\n  const now = Date.now();\n  const key = `${identifier}:${config.windowMs}`;\n\n  // Get or create entry\n  if (!store[key] || store[key].resetTime < now) {\n    store[key] = {\n      count: 1,\n      resetTime: now + config.windowMs,\n    };\n\n    const allowed = 1 <= config.maxRequests;\n\n    return {\n      allowed,\n      remaining: Math.max(0, config.maxRequests - 1),\n      resetTime: Math.ceil(config.windowMs / 1000),\n      current: 1,\n      limit: config.maxRequests,\n    };\n  }\n\n  // Increment count\n  store[key].count++;\n\n  const allowed = store[key].count <= config.maxRequests;\n  const remaining = Math.max(0, config.maxRequests - store[key].count);\n  const resetTime = Math.ceil((store[key].resetTime - now) / 1000);\n\n  return {\n    allowed,\n    remaining,\n    resetTime,\n    current: store[key].count,\n    limit: config.maxRequests,\n  };\n}\n\n/**\n * Middleware helper to get client IP address\n */\nexport function getClientIp(request: Request): string {\n  // Check various headers for the real IP (in case behind proxy/CDN)\n  const headers = request.headers;\n\n  return (\n    (headers.get(\"x-forwarded-for\")?.split(\",\")[0] ?? \"\").trim() ||\n    headers.get(\"x-real-ip\") ||\n    headers.get(\"cf-connecting-ip\") || // Cloudflare\n    headers.get(\"x-client-ip\") ||\n    \"unknown\"\n  );\n}\n\n/**\n * Pre-configured rate limit for login attempts\n * 5 attempts per 15 minutes per IP\n */\nexport const LOGIN_RATE_LIMIT: RateLimitConfig = {\n  maxRequests: 5,\n  windowMs: 15 * 60 * 1000, // 15 minutes\n};\n\n/**\n * Pre-configured rate limit for API endpoints\n * 100 requests per minute per IP\n */\nexport const API_RATE_LIMIT: RateLimitConfig = {\n  maxRequests: 100,\n  windowMs: 60 * 1000, // 1 minute\n};\n\n/**\n * Pre-configured rate limit for sensitive operations\n * 10 requests per hour per user\n */\nexport const SENSITIVE_RATE_LIMIT: RateLimitConfig = {\n  maxRequests: 10,\n  windowMs: 60 * 60 * 1000, // 1 hour\n};\n\n/**\n * Reset rate limit for a specific identifier\n * Useful for testing or manual resets\n */\nexport function resetRateLimit(identifier: string, windowMs: number): void {\n  const key = `${identifier}:${windowMs}`;\n  delete store[key];\n}\n\n/**\n * Get current rate limit status without incrementing\n */\nexport function getRateLimitStatus(\n  identifier: string,\n  config: RateLimitConfig\n): RateLimitResult | null {\n  const now = Date.now();\n  const key = `${identifier}:${config.windowMs}`;\n\n  if (!store[key] || store[key].resetTime < now) {\n    return null;\n  }\n\n  const remaining = Math.max(0, config.maxRequests - store[key].count);\n  const resetTime = Math.ceil((store[key].resetTime - now) / 1000);\n\n  return {\n    allowed: store[key].count <= config.maxRequests,\n    remaining,\n    resetTime,\n    current: store[key].count,\n    limit: config.maxRequests,\n  };\n}\n\n/**\n * Clear all rate limit data (for testing)\n */\nexport function clearAllRateLimits(): void {\n  Object.keys(store).forEach((key) => delete store[key]);\n}\n"],"version":3}