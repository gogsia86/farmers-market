60619204da604034e123924c2ffcb912
"use strict";
/**
 * âš¡ DIVINE CACHE UTILITY
 * Quantum caching with agricultural consciousness and biodynamic TTL
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.cache = exports.CacheTTL = exports.CacheKeys = void 0;
const redis_1 = require("@/lib/cache/redis");
/**
 * In-memory cache with agricultural consciousness
 */
class BiodynamicCache {
    cache = new Map();
    constructor() {
        // Clean up expired entries every minute
        setInterval(() => this.cleanup(), 60000);
    }
    /**
     * Set cache value with optional TTL
     */
    async set(key, value, ttlSeconds = 3600) {
        const expiresAt = Date.now() + ttlSeconds * 1000;
        this.cache.set(key, { value, expiresAt });
    }
    /**
     * Get cache value
     */
    async get(key) {
        const cached = this.cache.get(key);
        if (!cached) {
            return null;
        }
        // Check if expired
        if (Date.now() > cached.expiresAt) {
            this.cache.delete(key);
            return null;
        }
        return cached.value;
    }
    /**
     * Delete cache entry
     */
    async delete(key) {
        this.cache.delete(key);
    }
    /**
     * Clear all cache entries
     */
    async clear() {
        this.cache.clear();
    }
    /**
     * Check if key exists and is not expired
     */
    async has(key) {
        const cached = this.cache.get(key);
        if (!cached)
            return false;
        if (Date.now() > cached.expiresAt) {
            this.cache.delete(key);
            return false;
        }
        return true;
    }
    /**
     * Get or set pattern (fetch if not cached)
     */
    async getOrSet(key, fetcher, ttlSeconds = 3600) {
        const cached = await this.get(key);
        if (cached !== null) {
            return cached;
        }
        const value = await fetcher();
        await this.set(key, value, ttlSeconds);
        return value;
    }
    /**
     * Set with seasonal awareness
     * Longer TTL for stable seasonal data
     */
    async setSeasonalData(key, value, season) {
        const seasonalTTL = {
            SPRING: 7 * 24 * 3600, // 1 week
            SUMMER: 14 * 24 * 3600, // 2 weeks
            FALL: 7 * 24 * 3600, // 1 week
            WINTER: 30 * 24 * 3600, // 1 month (longer rest period)
        };
        await this.set(key, value, seasonalTTL[season]);
    }
    /**
     * Invalidate cache by pattern
     */
    async invalidatePattern(pattern) {
        const regex = new RegExp(pattern);
        const keysToDelete = [];
        for (const key of this.cache.keys()) {
            if (regex.test(key)) {
                keysToDelete.push(key);
            }
        }
        for (const key of keysToDelete) {
            this.cache.delete(key);
        }
    }
    /**
     * Clean up expired entries
     */
    cleanup() {
        const now = Date.now();
        const keysToDelete = [];
        for (const [key, cached] of this.cache.entries()) {
            if (now > cached.expiresAt) {
                keysToDelete.push(key);
            }
        }
        for (const key of keysToDelete) {
            this.cache.delete(key);
        }
    }
    /**
     * Get cache statistics
     */
    getStats() {
        return {
            size: this.cache.size,
            keys: Array.from(this.cache.keys()),
        };
    }
}
class RedisCacheAdapter {
    svc = (0, redis_1.getRedisCache)();
    async set(key, value, ttlSeconds = 3600) {
        await this.svc.set(key, value, { ttl: ttlSeconds });
    }
    async get(key) {
        return this.svc.get(key);
    }
    async delete(key) {
        await this.svc.delete(key);
    }
    async clear() {
        await this.svc.flushAll();
    }
    async has(key) {
        return this.svc.exists(key);
    }
    async getOrSet(key, fetcher, ttlSeconds = 3600) {
        return this.svc.getOrSet(key, fetcher, { ttl: ttlSeconds });
    }
    async setSeasonalData(key, value, season) {
        const seasonalTTL = {
            SPRING: 7 * 24 * 3600,
            SUMMER: 14 * 24 * 3600,
            FALL: 7 * 24 * 3600,
            WINTER: 30 * 24 * 3600,
        };
        await this.set(key, value, seasonalTTL[season]);
    }
    async invalidatePattern(pattern) {
        await this.svc.deletePattern(pattern);
    }
    getStats() {
        return { provider: "redis" };
    }
}
// Singleton instance - select Redis in production if configured
const isRedisEnabled = Boolean(process.env.REDIS_HOST);
const cache = isRedisEnabled
    ? new RedisCacheAdapter()
    : new BiodynamicCache();
exports.cache = cache;
/**
 * Cache key generators for consistent naming
 */
exports.CacheKeys = {
    // Product caching
    product: (id) => `product:${id}`,
    productsByFarm: (farmId) => `products:farm:${farmId}`,
    productsByCategory: (category) => `products:category:${category}`,
    // Farm caching
    farm: (id) => `farm:${id}`,
    farmsByRegion: (region) => `farms:region:${region}`,
    // Order caching
    order: (id) => `order:${id}`,
    userOrders: (userId) => `orders:user:${userId}`,
    // User caching
    user: (id) => `user:${id}`,
    userSession: (userId) => `session:${userId}`,
    // Seasonal data
    seasonalCrops: (season) => `crops:season:${season}`,
    seasonalProducts: (season) => `products:season:${season}`,
    // Analytics
    analytics: (type, date) => `analytics:${type}:${date}`,
};
/**
 * Cache TTL constants (in seconds)
 */
exports.CacheTTL = {
    SHORT: 5 * 60, // 5 minutes
    MEDIUM: 30 * 60, // 30 minutes
    LONG: 2 * 3600, // 2 hours
    DAY: 24 * 3600, // 1 day
    WEEK: 7 * 24 * 3600, // 1 week
    SEASONAL: 30 * 24 * 3600, // 1 month
};
exports.default = cache;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiTTpcXFJlcG9cXEZhcm1lcnMgTWFya2V0IFBsYXRmb3JtIHdlYiBhbmQgYXBwXFxzcmNcXGxpYlxcY2FjaGUudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7O0FBRUgsNkNBQWtEO0FBSWxEOztHQUVHO0FBQ0gsTUFBTSxlQUFlO0lBQ0YsS0FBSyxHQUNwQixJQUFJLEdBQUcsRUFBRSxDQUFDO0lBRVo7UUFDRSx3Q0FBd0M7UUFDeEMsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsR0FBRyxDQUNQLEdBQVcsRUFDWCxLQUFjLEVBQ2QsYUFBcUIsSUFBSTtRQUV6QixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsVUFBVSxHQUFHLElBQUksQ0FBQztRQUNqRCxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsR0FBRyxDQUFjLEdBQVc7UUFDaEMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFbkMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ1osT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBRUQsbUJBQW1CO1FBQ25CLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUNsQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN2QixPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFFRCxPQUFPLE1BQU0sQ0FBQyxLQUFVLENBQUM7SUFDM0IsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFXO1FBQ3RCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3pCLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxLQUFLO1FBQ1QsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNyQixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQVc7UUFDbkIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbkMsSUFBSSxDQUFDLE1BQU07WUFBRSxPQUFPLEtBQUssQ0FBQztRQUUxQixJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDbEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdkIsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsUUFBUSxDQUNaLEdBQVcsRUFDWCxPQUF5QixFQUN6QixhQUFxQixJQUFJO1FBRXpCLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBSSxHQUFHLENBQUMsQ0FBQztRQUV0QyxJQUFJLE1BQU0sS0FBSyxJQUFJLEVBQUUsQ0FBQztZQUNwQixPQUFPLE1BQU0sQ0FBQztRQUNoQixDQUFDO1FBRUQsTUFBTSxLQUFLLEdBQUcsTUFBTSxPQUFPLEVBQUUsQ0FBQztRQUM5QixNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxVQUFVLENBQUMsQ0FBQztRQUN2QyxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFFRDs7O09BR0c7SUFDSCxLQUFLLENBQUMsZUFBZSxDQUNuQixHQUFXLEVBQ1gsS0FBYyxFQUNkLE1BQWM7UUFFZCxNQUFNLFdBQVcsR0FBRztZQUNsQixNQUFNLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLEVBQUUsU0FBUztZQUNoQyxNQUFNLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLEVBQUUsVUFBVTtZQUNsQyxJQUFJLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLEVBQUUsU0FBUztZQUM5QixNQUFNLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLEVBQUUsK0JBQStCO1NBQ3hELENBQUM7UUFFRixNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsaUJBQWlCLENBQUMsT0FBZTtRQUNyQyxNQUFNLEtBQUssR0FBRyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNsQyxNQUFNLFlBQVksR0FBYSxFQUFFLENBQUM7UUFFbEMsS0FBSyxNQUFNLEdBQUcsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUM7WUFDcEMsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7Z0JBQ3BCLFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDekIsQ0FBQztRQUNILENBQUM7UUFFRCxLQUFLLE1BQU0sR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1lBQy9CLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3pCLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSyxPQUFPO1FBQ2IsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLE1BQU0sWUFBWSxHQUFhLEVBQUUsQ0FBQztRQUVsQyxLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDO1lBQ2pELElBQUksR0FBRyxHQUFHLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFDM0IsWUFBWSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN6QixDQUFDO1FBQ0gsQ0FBQztRQUVELEtBQUssTUFBTSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7WUFDL0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDekIsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNILFFBQVE7UUFDTixPQUFPO1lBQ0wsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSTtZQUNyQixJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1NBQ3BDLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUEyQkQsTUFBTSxpQkFBaUI7SUFDSixHQUFHLEdBQUcsSUFBQSxxQkFBYSxHQUFFLENBQUM7SUFFdkMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFXLEVBQUUsS0FBYyxFQUFFLGFBQXFCLElBQUk7UUFDOUQsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVELEtBQUssQ0FBQyxHQUFHLENBQWMsR0FBVztRQUNoQyxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFJLEdBQUcsQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFFRCxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQVc7UUFDdEIsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUM3QixDQUFDO0lBRUQsS0FBSyxDQUFDLEtBQUs7UUFDVCxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVELEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBVztRQUNuQixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFFRCxLQUFLLENBQUMsUUFBUSxDQUNaLEdBQVcsRUFDWCxPQUF5QixFQUN6QixhQUFxQixJQUFJO1FBRXpCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUksR0FBRyxFQUFFLE9BQU8sRUFBRSxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDO0lBQ2pFLENBQUM7SUFFRCxLQUFLLENBQUMsZUFBZSxDQUFDLEdBQVcsRUFBRSxLQUFjLEVBQUUsTUFBYztRQUMvRCxNQUFNLFdBQVcsR0FBRztZQUNsQixNQUFNLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJO1lBQ3JCLE1BQU0sRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUk7WUFDdEIsSUFBSSxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSTtZQUNuQixNQUFNLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJO1NBQ2QsQ0FBQztRQUNYLE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFFRCxLQUFLLENBQUMsaUJBQWlCLENBQUMsT0FBZTtRQUNyQyxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFFRCxRQUFRO1FBQ04sT0FBTyxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsQ0FBQztJQUMvQixDQUFDO0NBQ0Y7QUFFRCxnRUFBZ0U7QUFDaEUsTUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDdkQsTUFBTSxLQUFLLEdBQWlCLGNBQWM7SUFDeEMsQ0FBQyxDQUFDLElBQUksaUJBQWlCLEVBQUU7SUFDekIsQ0FBQyxDQUFDLElBQUksZUFBZSxFQUFFLENBQUM7QUEyQ2pCLHNCQUFLO0FBekNkOztHQUVHO0FBQ1UsUUFBQSxTQUFTLEdBQUc7SUFDdkIsa0JBQWtCO0lBQ2xCLE9BQU8sRUFBRSxDQUFDLEVBQVUsRUFBRSxFQUFFLENBQUMsV0FBVyxFQUFFLEVBQUU7SUFDeEMsY0FBYyxFQUFFLENBQUMsTUFBYyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsTUFBTSxFQUFFO0lBQzdELGtCQUFrQixFQUFFLENBQUMsUUFBZ0IsRUFBRSxFQUFFLENBQUMscUJBQXFCLFFBQVEsRUFBRTtJQUV6RSxlQUFlO0lBQ2YsSUFBSSxFQUFFLENBQUMsRUFBVSxFQUFFLEVBQUUsQ0FBQyxRQUFRLEVBQUUsRUFBRTtJQUNsQyxhQUFhLEVBQUUsQ0FBQyxNQUFjLEVBQUUsRUFBRSxDQUFDLGdCQUFnQixNQUFNLEVBQUU7SUFFM0QsZ0JBQWdCO0lBQ2hCLEtBQUssRUFBRSxDQUFDLEVBQVUsRUFBRSxFQUFFLENBQUMsU0FBUyxFQUFFLEVBQUU7SUFDcEMsVUFBVSxFQUFFLENBQUMsTUFBYyxFQUFFLEVBQUUsQ0FBQyxlQUFlLE1BQU0sRUFBRTtJQUV2RCxlQUFlO0lBQ2YsSUFBSSxFQUFFLENBQUMsRUFBVSxFQUFFLEVBQUUsQ0FBQyxRQUFRLEVBQUUsRUFBRTtJQUNsQyxXQUFXLEVBQUUsQ0FBQyxNQUFjLEVBQUUsRUFBRSxDQUFDLFdBQVcsTUFBTSxFQUFFO0lBRXBELGdCQUFnQjtJQUNoQixhQUFhLEVBQUUsQ0FBQyxNQUFjLEVBQUUsRUFBRSxDQUFDLGdCQUFnQixNQUFNLEVBQUU7SUFDM0QsZ0JBQWdCLEVBQUUsQ0FBQyxNQUFjLEVBQUUsRUFBRSxDQUFDLG1CQUFtQixNQUFNLEVBQUU7SUFFakUsWUFBWTtJQUNaLFNBQVMsRUFBRSxDQUFDLElBQVksRUFBRSxJQUFZLEVBQUUsRUFBRSxDQUFDLGFBQWEsSUFBSSxJQUFJLElBQUksRUFBRTtDQUN2RSxDQUFDO0FBRUY7O0dBRUc7QUFDVSxRQUFBLFFBQVEsR0FBRztJQUN0QixLQUFLLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRSxZQUFZO0lBQzNCLE1BQU0sRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLGFBQWE7SUFDOUIsSUFBSSxFQUFFLENBQUMsR0FBRyxJQUFJLEVBQUUsVUFBVTtJQUMxQixHQUFHLEVBQUUsRUFBRSxHQUFHLElBQUksRUFBRSxRQUFRO0lBQ3hCLElBQUksRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksRUFBRSxTQUFTO0lBQzlCLFFBQVEsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksRUFBRSxVQUFVO0NBQ3JDLENBQUM7QUFHRixrQkFBZSxLQUFLLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiTTpcXFJlcG9cXEZhcm1lcnMgTWFya2V0IFBsYXRmb3JtIHdlYiBhbmQgYXBwXFxzcmNcXGxpYlxcY2FjaGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiDimqEgRElWSU5FIENBQ0hFIFVUSUxJVFlcbiAqIFF1YW50dW0gY2FjaGluZyB3aXRoIGFncmljdWx0dXJhbCBjb25zY2lvdXNuZXNzIGFuZCBiaW9keW5hbWljIFRUTFxuICovXG5cbmltcG9ydCB7IGdldFJlZGlzQ2FjaGUgfSBmcm9tIFwiQC9saWIvY2FjaGUvcmVkaXNcIjtcblxudHlwZSBTZWFzb24gPSBcIlNQUklOR1wiIHwgXCJTVU1NRVJcIiB8IFwiRkFMTFwiIHwgXCJXSU5URVJcIjtcblxuLyoqXG4gKiBJbi1tZW1vcnkgY2FjaGUgd2l0aCBhZ3JpY3VsdHVyYWwgY29uc2Npb3VzbmVzc1xuICovXG5jbGFzcyBCaW9keW5hbWljQ2FjaGUge1xuICBwcml2YXRlIHJlYWRvbmx5IGNhY2hlOiBNYXA8c3RyaW5nLCB7IHZhbHVlOiB1bmtub3duOyBleHBpcmVzQXQ6IG51bWJlciB9PiA9XG4gICAgbmV3IE1hcCgpO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIC8vIENsZWFuIHVwIGV4cGlyZWQgZW50cmllcyBldmVyeSBtaW51dGVcbiAgICBzZXRJbnRlcnZhbCgoKSA9PiB0aGlzLmNsZWFudXAoKSwgNjAwMDApO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCBjYWNoZSB2YWx1ZSB3aXRoIG9wdGlvbmFsIFRUTFxuICAgKi9cbiAgYXN5bmMgc2V0KFxuICAgIGtleTogc3RyaW5nLFxuICAgIHZhbHVlOiB1bmtub3duLFxuICAgIHR0bFNlY29uZHM6IG51bWJlciA9IDM2MDBcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZXhwaXJlc0F0ID0gRGF0ZS5ub3coKSArIHR0bFNlY29uZHMgKiAxMDAwO1xuICAgIHRoaXMuY2FjaGUuc2V0KGtleSwgeyB2YWx1ZSwgZXhwaXJlc0F0IH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjYWNoZSB2YWx1ZVxuICAgKi9cbiAgYXN5bmMgZ2V0PFQgPSB1bmtub3duPihrZXk6IHN0cmluZyk6IFByb21pc2U8VCB8IG51bGw+IHtcbiAgICBjb25zdCBjYWNoZWQgPSB0aGlzLmNhY2hlLmdldChrZXkpO1xuXG4gICAgaWYgKCFjYWNoZWQpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIGV4cGlyZWRcbiAgICBpZiAoRGF0ZS5ub3coKSA+IGNhY2hlZC5leHBpcmVzQXQpIHtcbiAgICAgIHRoaXMuY2FjaGUuZGVsZXRlKGtleSk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gY2FjaGVkLnZhbHVlIGFzIFQ7XG4gIH1cblxuICAvKipcbiAgICogRGVsZXRlIGNhY2hlIGVudHJ5XG4gICAqL1xuICBhc3luYyBkZWxldGUoa2V5OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLmNhY2hlLmRlbGV0ZShrZXkpO1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFyIGFsbCBjYWNoZSBlbnRyaWVzXG4gICAqL1xuICBhc3luYyBjbGVhcigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLmNhY2hlLmNsZWFyKCk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYga2V5IGV4aXN0cyBhbmQgaXMgbm90IGV4cGlyZWRcbiAgICovXG4gIGFzeW5jIGhhcyhrZXk6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IGNhY2hlZCA9IHRoaXMuY2FjaGUuZ2V0KGtleSk7XG4gICAgaWYgKCFjYWNoZWQpIHJldHVybiBmYWxzZTtcblxuICAgIGlmIChEYXRlLm5vdygpID4gY2FjaGVkLmV4cGlyZXNBdCkge1xuICAgICAgdGhpcy5jYWNoZS5kZWxldGUoa2V5KTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgb3Igc2V0IHBhdHRlcm4gKGZldGNoIGlmIG5vdCBjYWNoZWQpXG4gICAqL1xuICBhc3luYyBnZXRPclNldDxUPihcbiAgICBrZXk6IHN0cmluZyxcbiAgICBmZXRjaGVyOiAoKSA9PiBQcm9taXNlPFQ+LFxuICAgIHR0bFNlY29uZHM6IG51bWJlciA9IDM2MDBcbiAgKTogUHJvbWlzZTxUPiB7XG4gICAgY29uc3QgY2FjaGVkID0gYXdhaXQgdGhpcy5nZXQ8VD4oa2V5KTtcblxuICAgIGlmIChjYWNoZWQgIT09IG51bGwpIHtcbiAgICAgIHJldHVybiBjYWNoZWQ7XG4gICAgfVxuXG4gICAgY29uc3QgdmFsdWUgPSBhd2FpdCBmZXRjaGVyKCk7XG4gICAgYXdhaXQgdGhpcy5zZXQoa2V5LCB2YWx1ZSwgdHRsU2Vjb25kcyk7XG4gICAgcmV0dXJuIHZhbHVlO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCB3aXRoIHNlYXNvbmFsIGF3YXJlbmVzc1xuICAgKiBMb25nZXIgVFRMIGZvciBzdGFibGUgc2Vhc29uYWwgZGF0YVxuICAgKi9cbiAgYXN5bmMgc2V0U2Vhc29uYWxEYXRhKFxuICAgIGtleTogc3RyaW5nLFxuICAgIHZhbHVlOiB1bmtub3duLFxuICAgIHNlYXNvbjogU2Vhc29uXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHNlYXNvbmFsVFRMID0ge1xuICAgICAgU1BSSU5HOiA3ICogMjQgKiAzNjAwLCAvLyAxIHdlZWtcbiAgICAgIFNVTU1FUjogMTQgKiAyNCAqIDM2MDAsIC8vIDIgd2Vla3NcbiAgICAgIEZBTEw6IDcgKiAyNCAqIDM2MDAsIC8vIDEgd2Vla1xuICAgICAgV0lOVEVSOiAzMCAqIDI0ICogMzYwMCwgLy8gMSBtb250aCAobG9uZ2VyIHJlc3QgcGVyaW9kKVxuICAgIH07XG5cbiAgICBhd2FpdCB0aGlzLnNldChrZXksIHZhbHVlLCBzZWFzb25hbFRUTFtzZWFzb25dKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZhbGlkYXRlIGNhY2hlIGJ5IHBhdHRlcm5cbiAgICovXG4gIGFzeW5jIGludmFsaWRhdGVQYXR0ZXJuKHBhdHRlcm46IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHJlZ2V4ID0gbmV3IFJlZ0V4cChwYXR0ZXJuKTtcbiAgICBjb25zdCBrZXlzVG9EZWxldGU6IHN0cmluZ1tdID0gW107XG5cbiAgICBmb3IgKGNvbnN0IGtleSBvZiB0aGlzLmNhY2hlLmtleXMoKSkge1xuICAgICAgaWYgKHJlZ2V4LnRlc3Qoa2V5KSkge1xuICAgICAgICBrZXlzVG9EZWxldGUucHVzaChrZXkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXNUb0RlbGV0ZSkge1xuICAgICAgdGhpcy5jYWNoZS5kZWxldGUoa2V5KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2xlYW4gdXAgZXhwaXJlZCBlbnRyaWVzXG4gICAqL1xuICBwcml2YXRlIGNsZWFudXAoKTogdm9pZCB7XG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBjb25zdCBrZXlzVG9EZWxldGU6IHN0cmluZ1tdID0gW107XG5cbiAgICBmb3IgKGNvbnN0IFtrZXksIGNhY2hlZF0gb2YgdGhpcy5jYWNoZS5lbnRyaWVzKCkpIHtcbiAgICAgIGlmIChub3cgPiBjYWNoZWQuZXhwaXJlc0F0KSB7XG4gICAgICAgIGtleXNUb0RlbGV0ZS5wdXNoKGtleSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBrZXkgb2Yga2V5c1RvRGVsZXRlKSB7XG4gICAgICB0aGlzLmNhY2hlLmRlbGV0ZShrZXkpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY2FjaGUgc3RhdGlzdGljc1xuICAgKi9cbiAgZ2V0U3RhdHMoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNpemU6IHRoaXMuY2FjaGUuc2l6ZSxcbiAgICAgIGtleXM6IEFycmF5LmZyb20odGhpcy5jYWNoZS5rZXlzKCkpLFxuICAgIH07XG4gIH1cbn1cblxuLy8gQWRhcHRlciBpbnRlcmZhY2UgZm9yIGNhY2hlIHByb3ZpZGVyc1xuaW50ZXJmYWNlIENhY2hlQWRhcHRlciB7XG4gIHNldChcbiAgICBrZXk6IHN0cmluZyxcbiAgICB2YWx1ZTogdW5rbm93bixcbiAgICB0dGxTZWNvbmRzPzogbnVtYmVyXG4gICk6IFByb21pc2U8dm9pZCB8IGJvb2xlYW4+O1xuICBnZXQ8VCA9IHVua25vd24+KGtleTogc3RyaW5nKTogUHJvbWlzZTxUIHwgbnVsbD47XG4gIGRlbGV0ZShrZXk6IHN0cmluZyk6IFByb21pc2U8dm9pZCB8IGJvb2xlYW4+O1xuICBjbGVhcigpOiBQcm9taXNlPHZvaWQgfCBib29sZWFuPjtcbiAgaGFzKGtleTogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPjtcbiAgZ2V0T3JTZXQ8VD4oXG4gICAga2V5OiBzdHJpbmcsXG4gICAgZmV0Y2hlcjogKCkgPT4gUHJvbWlzZTxUPixcbiAgICB0dGxTZWNvbmRzPzogbnVtYmVyXG4gICk6IFByb21pc2U8VD47XG4gIHNldFNlYXNvbmFsRGF0YShcbiAgICBrZXk6IHN0cmluZyxcbiAgICB2YWx1ZTogdW5rbm93bixcbiAgICBzZWFzb246IFwiU1BSSU5HXCIgfCBcIlNVTU1FUlwiIHwgXCJGQUxMXCIgfCBcIldJTlRFUlwiXG4gICk6IFByb21pc2U8dm9pZCB8IGJvb2xlYW4+O1xuICBpbnZhbGlkYXRlUGF0dGVybihwYXR0ZXJuOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQgfCBudW1iZXI+O1xuICBnZXRTdGF0cygpOiB1bmtub3duO1xufVxuXG5jbGFzcyBSZWRpc0NhY2hlQWRhcHRlciBpbXBsZW1lbnRzIENhY2hlQWRhcHRlciB7XG4gIHByaXZhdGUgcmVhZG9ubHkgc3ZjID0gZ2V0UmVkaXNDYWNoZSgpO1xuXG4gIGFzeW5jIHNldChrZXk6IHN0cmluZywgdmFsdWU6IHVua25vd24sIHR0bFNlY29uZHM6IG51bWJlciA9IDM2MDApIHtcbiAgICBhd2FpdCB0aGlzLnN2Yy5zZXQoa2V5LCB2YWx1ZSwgeyB0dGw6IHR0bFNlY29uZHMgfSk7XG4gIH1cblxuICBhc3luYyBnZXQ8VCA9IHVua25vd24+KGtleTogc3RyaW5nKTogUHJvbWlzZTxUIHwgbnVsbD4ge1xuICAgIHJldHVybiB0aGlzLnN2Yy5nZXQ8VD4oa2V5KTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZShrZXk6IHN0cmluZykge1xuICAgIGF3YWl0IHRoaXMuc3ZjLmRlbGV0ZShrZXkpO1xuICB9XG5cbiAgYXN5bmMgY2xlYXIoKSB7XG4gICAgYXdhaXQgdGhpcy5zdmMuZmx1c2hBbGwoKTtcbiAgfVxuXG4gIGFzeW5jIGhhcyhrZXk6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLnN2Yy5leGlzdHMoa2V5KTtcbiAgfVxuXG4gIGFzeW5jIGdldE9yU2V0PFQ+KFxuICAgIGtleTogc3RyaW5nLFxuICAgIGZldGNoZXI6ICgpID0+IFByb21pc2U8VD4sXG4gICAgdHRsU2Vjb25kczogbnVtYmVyID0gMzYwMFxuICApOiBQcm9taXNlPFQ+IHtcbiAgICByZXR1cm4gdGhpcy5zdmMuZ2V0T3JTZXQ8VD4oa2V5LCBmZXRjaGVyLCB7IHR0bDogdHRsU2Vjb25kcyB9KTtcbiAgfVxuXG4gIGFzeW5jIHNldFNlYXNvbmFsRGF0YShrZXk6IHN0cmluZywgdmFsdWU6IHVua25vd24sIHNlYXNvbjogU2Vhc29uKSB7XG4gICAgY29uc3Qgc2Vhc29uYWxUVEwgPSB7XG4gICAgICBTUFJJTkc6IDcgKiAyNCAqIDM2MDAsXG4gICAgICBTVU1NRVI6IDE0ICogMjQgKiAzNjAwLFxuICAgICAgRkFMTDogNyAqIDI0ICogMzYwMCxcbiAgICAgIFdJTlRFUjogMzAgKiAyNCAqIDM2MDAsXG4gICAgfSBhcyBjb25zdDtcbiAgICBhd2FpdCB0aGlzLnNldChrZXksIHZhbHVlLCBzZWFzb25hbFRUTFtzZWFzb25dKTtcbiAgfVxuXG4gIGFzeW5jIGludmFsaWRhdGVQYXR0ZXJuKHBhdHRlcm46IHN0cmluZykge1xuICAgIGF3YWl0IHRoaXMuc3ZjLmRlbGV0ZVBhdHRlcm4ocGF0dGVybik7XG4gIH1cblxuICBnZXRTdGF0cygpIHtcbiAgICByZXR1cm4geyBwcm92aWRlcjogXCJyZWRpc1wiIH07XG4gIH1cbn1cblxuLy8gU2luZ2xldG9uIGluc3RhbmNlIC0gc2VsZWN0IFJlZGlzIGluIHByb2R1Y3Rpb24gaWYgY29uZmlndXJlZFxuY29uc3QgaXNSZWRpc0VuYWJsZWQgPSBCb29sZWFuKHByb2Nlc3MuZW52LlJFRElTX0hPU1QpO1xuY29uc3QgY2FjaGU6IENhY2hlQWRhcHRlciA9IGlzUmVkaXNFbmFibGVkXG4gID8gbmV3IFJlZGlzQ2FjaGVBZGFwdGVyKClcbiAgOiBuZXcgQmlvZHluYW1pY0NhY2hlKCk7XG5cbi8qKlxuICogQ2FjaGUga2V5IGdlbmVyYXRvcnMgZm9yIGNvbnNpc3RlbnQgbmFtaW5nXG4gKi9cbmV4cG9ydCBjb25zdCBDYWNoZUtleXMgPSB7XG4gIC8vIFByb2R1Y3QgY2FjaGluZ1xuICBwcm9kdWN0OiAoaWQ6IHN0cmluZykgPT4gYHByb2R1Y3Q6JHtpZH1gLFxuICBwcm9kdWN0c0J5RmFybTogKGZhcm1JZDogc3RyaW5nKSA9PiBgcHJvZHVjdHM6ZmFybToke2Zhcm1JZH1gLFxuICBwcm9kdWN0c0J5Q2F0ZWdvcnk6IChjYXRlZ29yeTogc3RyaW5nKSA9PiBgcHJvZHVjdHM6Y2F0ZWdvcnk6JHtjYXRlZ29yeX1gLFxuXG4gIC8vIEZhcm0gY2FjaGluZ1xuICBmYXJtOiAoaWQ6IHN0cmluZykgPT4gYGZhcm06JHtpZH1gLFxuICBmYXJtc0J5UmVnaW9uOiAocmVnaW9uOiBzdHJpbmcpID0+IGBmYXJtczpyZWdpb246JHtyZWdpb259YCxcblxuICAvLyBPcmRlciBjYWNoaW5nXG4gIG9yZGVyOiAoaWQ6IHN0cmluZykgPT4gYG9yZGVyOiR7aWR9YCxcbiAgdXNlck9yZGVyczogKHVzZXJJZDogc3RyaW5nKSA9PiBgb3JkZXJzOnVzZXI6JHt1c2VySWR9YCxcblxuICAvLyBVc2VyIGNhY2hpbmdcbiAgdXNlcjogKGlkOiBzdHJpbmcpID0+IGB1c2VyOiR7aWR9YCxcbiAgdXNlclNlc3Npb246ICh1c2VySWQ6IHN0cmluZykgPT4gYHNlc3Npb246JHt1c2VySWR9YCxcblxuICAvLyBTZWFzb25hbCBkYXRhXG4gIHNlYXNvbmFsQ3JvcHM6IChzZWFzb246IHN0cmluZykgPT4gYGNyb3BzOnNlYXNvbjoke3NlYXNvbn1gLFxuICBzZWFzb25hbFByb2R1Y3RzOiAoc2Vhc29uOiBzdHJpbmcpID0+IGBwcm9kdWN0czpzZWFzb246JHtzZWFzb259YCxcblxuICAvLyBBbmFseXRpY3NcbiAgYW5hbHl0aWNzOiAodHlwZTogc3RyaW5nLCBkYXRlOiBzdHJpbmcpID0+IGBhbmFseXRpY3M6JHt0eXBlfToke2RhdGV9YCxcbn07XG5cbi8qKlxuICogQ2FjaGUgVFRMIGNvbnN0YW50cyAoaW4gc2Vjb25kcylcbiAqL1xuZXhwb3J0IGNvbnN0IENhY2hlVFRMID0ge1xuICBTSE9SVDogNSAqIDYwLCAvLyA1IG1pbnV0ZXNcbiAgTUVESVVNOiAzMCAqIDYwLCAvLyAzMCBtaW51dGVzXG4gIExPTkc6IDIgKiAzNjAwLCAvLyAyIGhvdXJzXG4gIERBWTogMjQgKiAzNjAwLCAvLyAxIGRheVxuICBXRUVLOiA3ICogMjQgKiAzNjAwLCAvLyAxIHdlZWtcbiAgU0VBU09OQUw6IDMwICogMjQgKiAzNjAwLCAvLyAxIG1vbnRoXG59O1xuXG5leHBvcnQgeyBjYWNoZSB9O1xuZXhwb3J0IGRlZmF1bHQgY2FjaGU7XG4iXSwidmVyc2lvbiI6M30=