3a5e86c9870b4e1bc54c7acba68f50c4
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.prisma = exports.isDatabaseConnected = exports.database = void 0;
/**
 * ðŸ—„ï¸ PRISMA DATABASE SINGLETON
 * Divine database connection with quantum consciousness
 * @reference .github/instructions/07_DATABASE_QUANTUM_MASTERY.instructions.md
 */
const client_1 = require("@prisma/client");
let connectionAttempts = 0;
const MAX_RETRIES = 3;
const RETRY_DELAY = 2000; // 2 seconds
// Prisma v7 configuration with adapter support
const createPrismaClient = () => {
    const client = new client_1.PrismaClient({
        log: process.env.NODE_ENV === "development"
            ? ["query", "error", "warn"]
            : ["error"],
        // Prisma v7: Pass datasourceUrl via client config
        datasourceUrl: process.env.DATABASE_URL,
    });
    return client;
};
// Sleep utility for retries
const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));
// Enhanced connection handling with retries
const connectWithRetry = async (client) => {
    while (connectionAttempts < MAX_RETRIES) {
        try {
            await client.$connect();
            console.log("âœ… Database connection established successfully");
            globalThis.databaseConnected = true;
            return;
        }
        catch (error) {
            connectionAttempts++;
            console.warn(`âš ï¸  Database connection attempt ${connectionAttempts}/${MAX_RETRIES} failed:`, error instanceof Error ? error.message : error);
            if (connectionAttempts < MAX_RETRIES) {
                console.log(`ðŸ”„ Retrying in ${RETRY_DELAY / 1000} seconds...`);
                await sleep(RETRY_DELAY);
            }
            else {
                console.error("âŒ Database connection failed after", MAX_RETRIES, "attempts");
                console.error("âš ï¸  Server will start but database operations will fail");
                console.error("ðŸ’¡ Tip: Make sure PostgreSQL is running and DATABASE_URL is correct");
                globalThis.databaseConnected = false;
                // Don't exit - allow server to start for development
                if (process.env.NODE_ENV === "production") {
                    throw error;
                }
            }
        }
    }
};
// Initialize with logging configuration based on environment
const initializeDatabase = () => {
    const client = createPrismaClient();
    // Attempt connection asynchronously (non-blocking)
    connectWithRetry(client).catch((error) => {
        console.error("ðŸš¨ Fatal database connection error:", error);
    });
    return client;
};
exports.database = globalThis.prisma ?? initializeDatabase();
// Prevent hot reload from creating new instances in development
if (process.env.NODE_ENV !== "production") {
    globalThis.prisma = exports.database;
}
// Helper to check database connection status
const isDatabaseConnected = () => globalThis.databaseConnected ?? false;
exports.isDatabaseConnected = isDatabaseConnected;
// Re-export as both database and prisma for compatibility
exports.prisma = exports.database;
exports.default = exports.database;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiTTpcXFJlcG9cXEZhcm1lcnMgTWFya2V0IFBsYXRmb3JtIHdlYiBhbmQgYXBwXFxzcmNcXGxpYlxcZGF0YWJhc2VcXGluZGV4LnRzIiwibWFwcGluZ3MiOiI7OztBQUFBOzs7O0dBSUc7QUFDSCwyQ0FBOEM7QUFTOUMsSUFBSSxrQkFBa0IsR0FBRyxDQUFDLENBQUM7QUFDM0IsTUFBTSxXQUFXLEdBQUcsQ0FBQyxDQUFDO0FBQ3RCLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxDQUFDLFlBQVk7QUFFdEMsK0NBQStDO0FBQy9DLE1BQU0sa0JBQWtCLEdBQUcsR0FBRyxFQUFFO0lBQzlCLE1BQU0sTUFBTSxHQUFHLElBQUkscUJBQVksQ0FBQztRQUM5QixHQUFHLEVBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssYUFBYTtZQUNwQyxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sQ0FBQztZQUM1QixDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFDZixrREFBa0Q7UUFDbEQsYUFBYSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWTtLQUN4QyxDQUFDLENBQUM7SUFFSCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDLENBQUM7QUFFRiw0QkFBNEI7QUFDNUIsTUFBTSxLQUFLLEdBQUcsQ0FBQyxFQUFVLEVBQUUsRUFBRSxDQUFDLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFFaEYsNENBQTRDO0FBQzVDLE1BQU0sZ0JBQWdCLEdBQUcsS0FBSyxFQUFFLE1BQW9CLEVBQUUsRUFBRTtJQUN0RCxPQUFPLGtCQUFrQixHQUFHLFdBQVcsRUFBRSxDQUFDO1FBQ3hDLElBQUksQ0FBQztZQUNILE1BQU0sTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ3hCLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0RBQWdELENBQUMsQ0FBQztZQUM5RCxVQUFVLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDO1lBQ3BDLE9BQU87UUFDVCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLGtCQUFrQixFQUFFLENBQUM7WUFDckIsT0FBTyxDQUFDLElBQUksQ0FDVixtQ0FBbUMsa0JBQWtCLElBQUksV0FBVyxVQUFVLEVBQzlFLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FDL0MsQ0FBQztZQUVGLElBQUksa0JBQWtCLEdBQUcsV0FBVyxFQUFFLENBQUM7Z0JBQ3JDLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLFdBQVcsR0FBRyxJQUFJLGFBQWEsQ0FBQyxDQUFDO2dCQUMvRCxNQUFNLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUMzQixDQUFDO2lCQUFNLENBQUM7Z0JBQ04sT0FBTyxDQUFDLEtBQUssQ0FDWCxvQ0FBb0MsRUFDcEMsV0FBVyxFQUNYLFVBQVUsQ0FDWCxDQUFDO2dCQUNGLE9BQU8sQ0FBQyxLQUFLLENBQUMseURBQXlELENBQUMsQ0FBQztnQkFDekUsT0FBTyxDQUFDLEtBQUssQ0FDWCxxRUFBcUUsQ0FDdEUsQ0FBQztnQkFDRixVQUFVLENBQUMsaUJBQWlCLEdBQUcsS0FBSyxDQUFDO2dCQUNyQyxxREFBcUQ7Z0JBQ3JELElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssWUFBWSxFQUFFLENBQUM7b0JBQzFDLE1BQU0sS0FBSyxDQUFDO2dCQUNkLENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7QUFDSCxDQUFDLENBQUM7QUFFRiw2REFBNkQ7QUFDN0QsTUFBTSxrQkFBa0IsR0FBRyxHQUFHLEVBQUU7SUFDOUIsTUFBTSxNQUFNLEdBQUcsa0JBQWtCLEVBQUUsQ0FBQztJQUVwQyxtREFBbUQ7SUFDbkQsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUU7UUFDdkMsT0FBTyxDQUFDLEtBQUssQ0FBQyxxQ0FBcUMsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUM5RCxDQUFDLENBQUMsQ0FBQztJQUVILE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUMsQ0FBQztBQUVXLFFBQUEsUUFBUSxHQUFHLFVBQVUsQ0FBQyxNQUFNLElBQUksa0JBQWtCLEVBQUUsQ0FBQztBQUVsRSxnRUFBZ0U7QUFDaEUsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxZQUFZLEVBQUUsQ0FBQztJQUMxQyxVQUFVLENBQUMsTUFBTSxHQUFHLGdCQUFRLENBQUM7QUFDL0IsQ0FBQztBQUVELDZDQUE2QztBQUN0QyxNQUFNLG1CQUFtQixHQUFHLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsSUFBSSxLQUFLLENBQUM7QUFBbEUsUUFBQSxtQkFBbUIsdUJBQStDO0FBRS9FLDBEQUEwRDtBQUM3QyxRQUFBLE1BQU0sR0FBRyxnQkFBUSxDQUFDO0FBQy9CLGtCQUFlLGdCQUFRLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiTTpcXFJlcG9cXEZhcm1lcnMgTWFya2V0IFBsYXRmb3JtIHdlYiBhbmQgYXBwXFxzcmNcXGxpYlxcZGF0YWJhc2VcXGluZGV4LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICog8J+XhO+4jyBQUklTTUEgREFUQUJBU0UgU0lOR0xFVE9OXG4gKiBEaXZpbmUgZGF0YWJhc2UgY29ubmVjdGlvbiB3aXRoIHF1YW50dW0gY29uc2Npb3VzbmVzc1xuICogQHJlZmVyZW5jZSAuZ2l0aHViL2luc3RydWN0aW9ucy8wN19EQVRBQkFTRV9RVUFOVFVNX01BU1RFUlkuaW5zdHJ1Y3Rpb25zLm1kXG4gKi9cbmltcG9ydCB7IFByaXNtYUNsaWVudCB9IGZyb20gXCJAcHJpc21hL2NsaWVudFwiO1xuXG5kZWNsYXJlIGdsb2JhbCB7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXJcbiAgdmFyIHByaXNtYTogUHJpc21hQ2xpZW50IHwgdW5kZWZpbmVkO1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyXG4gIHZhciBkYXRhYmFzZUNvbm5lY3RlZDogYm9vbGVhbiB8IHVuZGVmaW5lZDtcbn1cblxubGV0IGNvbm5lY3Rpb25BdHRlbXB0cyA9IDA7XG5jb25zdCBNQVhfUkVUUklFUyA9IDM7XG5jb25zdCBSRVRSWV9ERUxBWSA9IDIwMDA7IC8vIDIgc2Vjb25kc1xuXG4vLyBQcmlzbWEgdjcgY29uZmlndXJhdGlvbiB3aXRoIGFkYXB0ZXIgc3VwcG9ydFxuY29uc3QgY3JlYXRlUHJpc21hQ2xpZW50ID0gKCkgPT4ge1xuICBjb25zdCBjbGllbnQgPSBuZXcgUHJpc21hQ2xpZW50KHtcbiAgICBsb2c6XG4gICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gXCJkZXZlbG9wbWVudFwiXG4gICAgICAgID8gW1wicXVlcnlcIiwgXCJlcnJvclwiLCBcIndhcm5cIl1cbiAgICAgICAgOiBbXCJlcnJvclwiXSxcbiAgICAvLyBQcmlzbWEgdjc6IFBhc3MgZGF0YXNvdXJjZVVybCB2aWEgY2xpZW50IGNvbmZpZ1xuICAgIGRhdGFzb3VyY2VVcmw6IHByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTCxcbiAgfSk7XG5cbiAgcmV0dXJuIGNsaWVudDtcbn07XG5cbi8vIFNsZWVwIHV0aWxpdHkgZm9yIHJldHJpZXNcbmNvbnN0IHNsZWVwID0gKG1zOiBudW1iZXIpID0+IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIG1zKSk7XG5cbi8vIEVuaGFuY2VkIGNvbm5lY3Rpb24gaGFuZGxpbmcgd2l0aCByZXRyaWVzXG5jb25zdCBjb25uZWN0V2l0aFJldHJ5ID0gYXN5bmMgKGNsaWVudDogUHJpc21hQ2xpZW50KSA9PiB7XG4gIHdoaWxlIChjb25uZWN0aW9uQXR0ZW1wdHMgPCBNQVhfUkVUUklFUykge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBjbGllbnQuJGNvbm5lY3QoKTtcbiAgICAgIGNvbnNvbGUubG9nKFwi4pyFIERhdGFiYXNlIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQgc3VjY2Vzc2Z1bGx5XCIpO1xuICAgICAgZ2xvYmFsVGhpcy5kYXRhYmFzZUNvbm5lY3RlZCA9IHRydWU7XG4gICAgICByZXR1cm47XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbm5lY3Rpb25BdHRlbXB0cysrO1xuICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICBg4pqg77iPICBEYXRhYmFzZSBjb25uZWN0aW9uIGF0dGVtcHQgJHtjb25uZWN0aW9uQXR0ZW1wdHN9LyR7TUFYX1JFVFJJRVN9IGZhaWxlZDpgLFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yXG4gICAgICApO1xuXG4gICAgICBpZiAoY29ubmVjdGlvbkF0dGVtcHRzIDwgTUFYX1JFVFJJRVMpIHtcbiAgICAgICAgY29uc29sZS5sb2coYPCflIQgUmV0cnlpbmcgaW4gJHtSRVRSWV9ERUxBWSAvIDEwMDB9IHNlY29uZHMuLi5gKTtcbiAgICAgICAgYXdhaXQgc2xlZXAoUkVUUllfREVMQVkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgICBcIuKdjCBEYXRhYmFzZSBjb25uZWN0aW9uIGZhaWxlZCBhZnRlclwiLFxuICAgICAgICAgIE1BWF9SRVRSSUVTLFxuICAgICAgICAgIFwiYXR0ZW1wdHNcIlxuICAgICAgICApO1xuICAgICAgICBjb25zb2xlLmVycm9yKFwi4pqg77iPICBTZXJ2ZXIgd2lsbCBzdGFydCBidXQgZGF0YWJhc2Ugb3BlcmF0aW9ucyB3aWxsIGZhaWxcIik7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgICAgXCLwn5KhIFRpcDogTWFrZSBzdXJlIFBvc3RncmVTUUwgaXMgcnVubmluZyBhbmQgREFUQUJBU0VfVVJMIGlzIGNvcnJlY3RcIlxuICAgICAgICApO1xuICAgICAgICBnbG9iYWxUaGlzLmRhdGFiYXNlQ29ubmVjdGVkID0gZmFsc2U7XG4gICAgICAgIC8vIERvbid0IGV4aXQgLSBhbGxvdyBzZXJ2ZXIgdG8gc3RhcnQgZm9yIGRldmVsb3BtZW50XG4gICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gXCJwcm9kdWN0aW9uXCIpIHtcbiAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxufTtcblxuLy8gSW5pdGlhbGl6ZSB3aXRoIGxvZ2dpbmcgY29uZmlndXJhdGlvbiBiYXNlZCBvbiBlbnZpcm9ubWVudFxuY29uc3QgaW5pdGlhbGl6ZURhdGFiYXNlID0gKCkgPT4ge1xuICBjb25zdCBjbGllbnQgPSBjcmVhdGVQcmlzbWFDbGllbnQoKTtcblxuICAvLyBBdHRlbXB0IGNvbm5lY3Rpb24gYXN5bmNocm9ub3VzbHkgKG5vbi1ibG9ja2luZylcbiAgY29ubmVjdFdpdGhSZXRyeShjbGllbnQpLmNhdGNoKChlcnJvcikgPT4ge1xuICAgIGNvbnNvbGUuZXJyb3IoXCLwn5qoIEZhdGFsIGRhdGFiYXNlIGNvbm5lY3Rpb24gZXJyb3I6XCIsIGVycm9yKTtcbiAgfSk7XG5cbiAgcmV0dXJuIGNsaWVudDtcbn07XG5cbmV4cG9ydCBjb25zdCBkYXRhYmFzZSA9IGdsb2JhbFRoaXMucHJpc21hID8/IGluaXRpYWxpemVEYXRhYmFzZSgpO1xuXG4vLyBQcmV2ZW50IGhvdCByZWxvYWQgZnJvbSBjcmVhdGluZyBuZXcgaW5zdGFuY2VzIGluIGRldmVsb3BtZW50XG5pZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09IFwicHJvZHVjdGlvblwiKSB7XG4gIGdsb2JhbFRoaXMucHJpc21hID0gZGF0YWJhc2U7XG59XG5cbi8vIEhlbHBlciB0byBjaGVjayBkYXRhYmFzZSBjb25uZWN0aW9uIHN0YXR1c1xuZXhwb3J0IGNvbnN0IGlzRGF0YWJhc2VDb25uZWN0ZWQgPSAoKSA9PiBnbG9iYWxUaGlzLmRhdGFiYXNlQ29ubmVjdGVkID8/IGZhbHNlO1xuXG4vLyBSZS1leHBvcnQgYXMgYm90aCBkYXRhYmFzZSBhbmQgcHJpc21hIGZvciBjb21wYXRpYmlsaXR5XG5leHBvcnQgY29uc3QgcHJpc21hID0gZGF0YWJhc2U7XG5leHBvcnQgZGVmYXVsdCBkYXRhYmFzZTtcbiJdLCJ2ZXJzaW9uIjozfQ==