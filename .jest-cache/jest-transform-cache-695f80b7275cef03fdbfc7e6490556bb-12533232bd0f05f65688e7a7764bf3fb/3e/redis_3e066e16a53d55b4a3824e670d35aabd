8d384c2c1818f0c2c06a66dd0ead80e7
"use strict";
/**
 * REDIS CACHE INFRASTRUCTURE
 * Divine caching with agricultural consciousness
 *
 * Reference: 03_PERFORMANCE_REALITY_BENDING.instructions.md
 * Domain: Agricultural cache management with seasonal awareness
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.RedisCacheService = void 0;
exports.getRedisCache = getRedisCache;
exports.checkRedisHealth = checkRedisHealth;
const ioredis_1 = __importDefault(require("ioredis"));
/**
 * REDIS QUANTUM CLIENT
 * High-performance Redis client with connection management
 */
class RedisQuantumClient {
    client = null;
    config;
    isConnecting = false;
    connectionPromise = null;
    constructor(config) {
        this.config = config;
    }
    /**
     * Connect to Redis with retry logic
     */
    async connect() {
        if (this.client &&
            (this.client.status === "ready" || this.client.status === "connecting")) {
            return;
        }
        if (this.isConnecting && this.connectionPromise) {
            return this.connectionPromise;
        }
        this.isConnecting = true;
        this.connectionPromise = this.performConnection();
        try {
            await this.connectionPromise;
        }
        finally {
            this.isConnecting = false;
            this.connectionPromise = null;
        }
    }
    async performConnection() {
        try {
            this.client = new ioredis_1.default({
                host: this.config.host,
                port: this.config.port,
                password: this.config.password,
                db: this.config.db || 0,
                retryStrategy: this.config.retryStrategy || ((times) => Math.min(times * 100, 3000)),
            });
            this.client.on("error", (error) => {
                console.error("Redis client error", error);
            });
            this.client.on("connect", () => {
                console.info("Redis client connected", {
                    host: this.config.host,
                    port: this.config.port,
                });
            });
            this.client.on("close", () => {
                console.warn("Redis client disconnected");
            });
            // ioredis connects automatically on instantiation, but ensure readiness
            await this.client.connect();
        }
        catch (error) {
            console.error("Failed to connect to Redis", error);
            throw error;
        }
    }
    /**
     * Disconnect from Redis
     */
    async disconnect() {
        if (this.client) {
            await this.client.quit();
            this.client = null;
        }
    }
    /**
     * Get Redis client instance
     */
    async getClient() {
        await this.connect();
        if (!this.client) {
            throw new Error("Redis client not initialized");
        }
        return this.client;
    }
    /**
     * Build cache key with prefix
     */
    buildKey(key) {
        return `${this.config.keyPrefix}${key}`;
    }
}
/**
 * REDIS CACHE SERVICE
 * High-level caching operations with agricultural consciousness
 */
class RedisCacheService {
    redisClient;
    DEFAULT_TTL = 3600; // 1 hour
    constructor(config) {
        this.redisClient = new RedisQuantumClient(config);
    }
    /**
     * Get value from cache
     */
    async get(key) {
        try {
            const client = await this.redisClient.getClient();
            const fullKey = this.redisClient.buildKey(key);
            const value = await client.get(fullKey);
            if (!value) {
                console.debug("Cache miss", { key });
                return null;
            }
            console.debug("Cache hit", { key });
            return JSON.parse(value);
        }
        catch (error) {
            console.error("Redis get error", error, { key });
            return null;
        }
    }
    /**
     * Set value in cache
     */
    async set(key, value, options = {}) {
        try {
            const client = await this.redisClient.getClient();
            const fullKey = this.redisClient.buildKey(key);
            const serialized = JSON.stringify(value);
            const ttl = options.ttl || this.DEFAULT_TTL;
            await client.setex(fullKey, ttl, serialized);
            console.debug("Cache set", { key, ttl });
            return true;
        }
        catch (error) {
            console.error("Redis set error", error, { key });
            return false;
        }
    }
    /**
     * Delete key from cache
     */
    async delete(key) {
        try {
            const client = await this.redisClient.getClient();
            const fullKey = this.redisClient.buildKey(key);
            await client.del(fullKey);
            console.debug("Cache delete", { key });
            return true;
        }
        catch (error) {
            console.error("Redis delete error", error, { key });
            return false;
        }
    }
    /**
     * Delete keys matching pattern
     */
    async deletePattern(pattern) {
        try {
            const client = await this.redisClient.getClient();
            const fullPattern = this.redisClient.buildKey(pattern);
            const keys = await client.keys(fullPattern);
            if (keys.length === 0) {
                return 0;
            }
            await client.del(keys);
            console.debug("Cache pattern delete", { pattern, count: keys.length });
            return keys.length;
        }
        catch (error) {
            console.error("Redis pattern delete error", error, { pattern });
            return 0;
        }
    }
    /**
     * Get or set pattern - fetch from cache or compute
     */
    async getOrSet(key, factory, options = {}) {
        // Try to get from cache first
        const cached = await this.get(key);
        if (cached !== null) {
            return cached;
        }
        // Compute value
        const value = await factory();
        // Store in cache
        await this.set(key, value, options);
        return value;
    }
    /**
     * Check if key exists
     */
    async exists(key) {
        try {
            const client = await this.redisClient.getClient();
            const fullKey = this.redisClient.buildKey(key);
            const exists = await client.exists(fullKey);
            return exists === 1;
        }
        catch (error) {
            console.error("Redis exists error", error, { key });
            return false;
        }
    }
    /**
     * Get TTL for key
     */
    async ttl(key) {
        try {
            const client = await this.redisClient.getClient();
            const fullKey = this.redisClient.buildKey(key);
            return await client.ttl(fullKey);
        }
        catch (error) {
            console.error("Redis TTL error", error, { key });
            return -1;
        }
    }
    /**
     * Increment counter
     */
    async increment(key, amount = 1) {
        try {
            const client = await this.redisClient.getClient();
            const fullKey = this.redisClient.buildKey(key);
            return await client.incrby(fullKey, amount);
        }
        catch (error) {
            console.error("Redis increment error", error, { key });
            return 0;
        }
    }
    /**
     * Flush all cache
     */
    async flushAll() {
        try {
            const client = await this.redisClient.getClient();
            await client.flushdb();
            console.warn("Cache flushed");
            return true;
        }
        catch (error) {
            console.error("Redis flush error", error);
            return false;
        }
    }
    /**
     * Disconnect from Redis
     */
    async disconnect() {
        await this.redisClient.disconnect();
    }
}
exports.RedisCacheService = RedisCacheService;
/**
 * SINGLETON REDIS INSTANCE
 * Global Redis cache service
 */
let redisInstance = null;
function getRedisCache() {
    if (!redisInstance) {
        const config = {
            host: process.env.REDIS_HOST || "localhost",
            port: Number.parseInt(process.env.REDIS_PORT || "6379", 10),
            password: process.env.REDIS_PASSWORD,
            db: Number.parseInt(process.env.REDIS_DB || "0", 10),
            keyPrefix: process.env.REDIS_KEY_PREFIX || "fm:",
            maxRetries: 3,
        };
        redisInstance = new RedisCacheService(config);
    }
    return redisInstance;
}
/**
 * HEALTH CHECK
 */
async function checkRedisHealth() {
    try {
        const redis = getRedisCache();
        await redis.set("health:check", { timestamp: Date.now() }, { ttl: 10 });
        const result = await redis.get("health:check");
        return result !== null;
    }
    catch (error) {
        console.error("Redis health check failed", error);
        return false;
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiTTpcXFJlcG9cXEZhcm1lcnMgTWFya2V0IFBsYXRmb3JtIHdlYiBhbmQgYXBwXFxzcmNcXGxpYlxcY2FjaGVcXHJlZGlzLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7O0dBTUc7Ozs7OztBQW9VSCxzQ0FlQztBQUtELDRDQVVDO0FBaFdELHNEQUE0QjtBQWtCNUI7OztHQUdHO0FBQ0gsTUFBTSxrQkFBa0I7SUFDZCxNQUFNLEdBQWlCLElBQUksQ0FBQztJQUNuQixNQUFNLENBQW1CO0lBQ2xDLFlBQVksR0FBRyxLQUFLLENBQUM7SUFDckIsaUJBQWlCLEdBQXlCLElBQUksQ0FBQztJQUV2RCxZQUFZLE1BQXdCO1FBQ2xDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO0lBQ3ZCLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxPQUFPO1FBQ1gsSUFDRSxJQUFJLENBQUMsTUFBTTtZQUNYLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEtBQUssT0FBTyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxLQUFLLFlBQVksQ0FBQyxFQUN2RSxDQUFDO1lBQ0QsT0FBTztRQUNULENBQUM7UUFFRCxJQUFJLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7WUFDaEQsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUM7UUFDaEMsQ0FBQztRQUVELElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUVsRCxJQUFJLENBQUM7WUFDSCxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQztRQUMvQixDQUFDO2dCQUFTLENBQUM7WUFDVCxJQUFJLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQztZQUMxQixJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDO1FBQ2hDLENBQUM7SUFDSCxDQUFDO0lBRU8sS0FBSyxDQUFDLGlCQUFpQjtR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LElBQUksTUFBTSxFQUFFLEVBQUUsQ0FBQztZQUMzRCxRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjO1lBQ3BDLEVBQUUsRUFBRSxNQUFNLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxJQUFJLEdBQUcsRUFBRSxFQUFFLENBQUM7WUFDcEQsU0FBUyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLElBQUksS0FBSztZQUNoRCxVQUFVLEVBQUUsQ0FBQztTQUNkLENBQUM7UUFFRixhQUFhLEdBQUcsSUFBSSxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNoRCxDQUFDO0lBRUQsT0FBTyxhQUFhLENBQUM7QUFDdkIsQ0FBQztBQUVEOztHQUVHO0FBQ0ksS0FBSyxVQUFVLGdCQUFnQjtJQUNwQyxJQUFJLENBQUM7UUFDSCxNQUFNLEtBQUssR0FBRyxhQUFhLEVBQUUsQ0FBQztRQUM5QixNQUFNLEtBQUssQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDeEUsTUFBTSxNQUFNLEdBQUcsTUFBTSxLQUFLLENBQUMsR0FBRyxDQUF3QixjQUFjLENBQUMsQ0FBQztRQUN0RSxPQUFPLE1BQU0sS0FBSyxJQUFJLENBQUM7SUFDekIsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLDJCQUEyQixFQUFFLEtBQWMsQ0FBQyxDQUFDO1FBQzNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztBQUNILENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiTTpcXFJlcG9cXEZhcm1lcnMgTWFya2V0IFBsYXRmb3JtIHdlYiBhbmQgYXBwXFxzcmNcXGxpYlxcY2FjaGVcXHJlZGlzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogUkVESVMgQ0FDSEUgSU5GUkFTVFJVQ1RVUkVcbiAqIERpdmluZSBjYWNoaW5nIHdpdGggYWdyaWN1bHR1cmFsIGNvbnNjaW91c25lc3NcbiAqXG4gKiBSZWZlcmVuY2U6IDAzX1BFUkZPUk1BTkNFX1JFQUxJVFlfQkVORElORy5pbnN0cnVjdGlvbnMubWRcbiAqIERvbWFpbjogQWdyaWN1bHR1cmFsIGNhY2hlIG1hbmFnZW1lbnQgd2l0aCBzZWFzb25hbCBhd2FyZW5lc3NcbiAqL1xuXG5pbXBvcnQgUmVkaXMgZnJvbSBcImlvcmVkaXNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBSZWRpc0NhY2hlQ29uZmlnIHtcbiAgaG9zdDogc3RyaW5nO1xuICBwb3J0OiBudW1iZXI7XG4gIHBhc3N3b3JkPzogc3RyaW5nO1xuICBkYj86IG51bWJlcjtcbiAga2V5UHJlZml4OiBzdHJpbmc7XG4gIG1heFJldHJpZXM6IG51bWJlcjtcbiAgcmV0cnlTdHJhdGVneT86ICh0aW1lczogbnVtYmVyKSA9PiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2FjaGVPcHRpb25zIHtcbiAgdHRsPzogbnVtYmVyOyAvLyBzZWNvbmRzXG4gIHNlYXNvbmFsPzogYm9vbGVhbjtcbiAgY29tcHJlc3M/OiBib29sZWFuO1xufVxuXG4vKipcbiAqIFJFRElTIFFVQU5UVU0gQ0xJRU5UXG4gKiBIaWdoLXBlcmZvcm1hbmNlIFJlZGlzIGNsaWVudCB3aXRoIGNvbm5lY3Rpb24gbWFuYWdlbWVudFxuICovXG5jbGFzcyBSZWRpc1F1YW50dW1DbGllbnQge1xuICBwcml2YXRlIGNsaWVudDogUmVkaXMgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSByZWFkb25seSBjb25maWc6IFJlZGlzQ2FjaGVDb25maWc7XG4gIHByaXZhdGUgaXNDb25uZWN0aW5nID0gZmFsc2U7XG4gIHByaXZhdGUgY29ubmVjdGlvblByb21pc2U6IFByb21pc2U8dm9pZD4gfCBudWxsID0gbnVsbDtcblxuICBjb25zdHJ1Y3Rvcihjb25maWc6IFJlZGlzQ2FjaGVDb25maWcpIHtcbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgfVxuXG4gIC8qKlxuICAgKiBDb25uZWN0IHRvIFJlZGlzIHdpdGggcmV0cnkgbG9naWNcbiAgICovXG4gIGFzeW5jIGNvbm5lY3QoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKFxuICAgICAgdGhpcy5jbGllbnQgJiZcbiAgICAgICh0aGlzLmNsaWVudC5zdGF0dXMgPT09IFwicmVhZHlcIiB8fCB0aGlzLmNsaWVudC5zdGF0dXMgPT09IFwiY29ubmVjdGluZ1wiKVxuICAgICkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlzQ29ubmVjdGluZyAmJiB0aGlzLmNvbm5lY3Rpb25Qcm9taXNlKSB7XG4gICAgICByZXR1cm4gdGhpcy5jb25uZWN0aW9uUHJvbWlzZTtcbiAgICB9XG5cbiAgICB0aGlzLmlzQ29ubmVjdGluZyA9IHRydWU7XG4gICAgdGhpcy5jb25uZWN0aW9uUHJvbWlzZSA9IHRoaXMucGVyZm9ybUNvbm5lY3Rpb24oKTtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmNvbm5lY3Rpb25Qcm9taXNlO1xuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLmlzQ29ubmVjdGluZyA9IGZhbHNlO1xuICAgICAgdGhpcy5jb25uZWN0aW9uUHJvbWlzZSA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBwZXJmb3JtQ29ubmVjdGlvbigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5jbGllbnQgPSBuZXcgUmVkaXMoe1xuICAgICAgICBob3N0OiB0aGlzLmNvbmZpZy5ob3N0LFxuICAgICAgICBwb3J0OiB0aGlzLmNvbmZpZy5wb3J0LFxuICAgICAgICBwYXNzd29yZDogdGhpcy5jb25maWcucGFzc3dvcmQsXG4gICAgICAgIGRiOiB0aGlzLmNvbmZpZy5kYiB8fCAwLFxuICAgICAgICByZXRyeVN0cmF0ZWd5OlxuICAgICAgICAgIHRoaXMuY29uZmlnLnJldHJ5U3RyYXRlZ3kgfHwgKCh0aW1lcykgPT4gTWF0aC5taW4odGltZXMgKiAxMDAsIDMwMDApKSxcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmNsaWVudC5vbihcImVycm9yXCIsIChlcnJvcikgPT4ge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiUmVkaXMgY2xpZW50IGVycm9yXCIsIGVycm9yKTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmNsaWVudC5vbihcImNvbm5lY3RcIiwgKCkgPT4ge1xuICAgICAgICBjb25zb2xlLmluZm8oXCJSZWRpcyBjbGllbnQgY29ubmVjdGVkXCIsIHtcbiAgICAgICAgICBob3N0OiB0aGlzLmNvbmZpZy5ob3N0LFxuICAgICAgICAgIHBvcnQ6IHRoaXMuY29uZmlnLnBvcnQsXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuY2xpZW50Lm9uKFwiY2xvc2VcIiwgKCkgPT4ge1xuICAgICAgICBjb25zb2xlLndhcm4oXCJSZWRpcyBjbGllbnQgZGlzY29ubmVjdGVkXCIpO1xuICAgICAgfSk7XG5cbiAgICAgIC8vIGlvcmVkaXMgY29ubmVjdHMgYXV0b21hdGljYWxseSBvbiBpbnN0YW50aWF0aW9uLCBidXQgZW5zdXJlIHJlYWRpbmVzc1xuICAgICAgYXdhaXQgdGhpcy5jbGllbnQuY29ubmVjdCgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIGNvbm5lY3QgdG8gUmVkaXNcIiwgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIERpc2Nvbm5lY3QgZnJvbSBSZWRpc1xuICAgKi9cbiAgYXN5bmMgZGlzY29ubmVjdCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAodGhpcy5jbGllbnQpIHtcbiAgICAgIGF3YWl0IHRoaXMuY2xpZW50LnF1aXQoKTtcbiAgICAgIHRoaXMuY2xpZW50ID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IFJlZGlzIGNsaWVudCBpbnN0YW5jZVxuICAgKi9cbiAgYXN5bmMgZ2V0Q2xpZW50KCk6IFByb21pc2U8UmVkaXM+IHtcbiAgICBhd2FpdCB0aGlzLmNvbm5lY3QoKTtcbiAgICBpZiAoIXRoaXMuY2xpZW50KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJSZWRpcyBjbGllbnQgbm90IGluaXRpYWxpemVkXCIpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5jbGllbnQ7XG4gIH1cblxuICAvKipcbiAgICogQnVpbGQgY2FjaGUga2V5IHdpdGggcHJlZml4XG4gICAqL1xuICBidWlsZEtleShrZXk6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGAke3RoaXMuY29uZmlnLmtleVByZWZpeH0ke2tleX1gO1xuICB9XG59XG5cbi8qKlxuICogUkVESVMgQ0FDSEUgU0VSVklDRVxuICogSGlnaC1sZXZlbCBjYWNoaW5nIG9wZXJhdGlvbnMgd2l0aCBhZ3JpY3VsdHVyYWwgY29uc2Npb3VzbmVzc1xuICovXG5leHBvcnQgY2xhc3MgUmVkaXNDYWNoZVNlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IHJlZGlzQ2xpZW50OiBSZWRpc1F1YW50dW1DbGllbnQ7XG4gIHByaXZhdGUgcmVhZG9ubHkgREVGQVVMVF9UVEwgPSAzNjAwOyAvLyAxIGhvdXJcblxuICBjb25zdHJ1Y3Rvcihjb25maWc6IFJlZGlzQ2FjaGVDb25maWcpIHtcbiAgICB0aGlzLnJlZGlzQ2xpZW50ID0gbmV3IFJlZGlzUXVhbnR1bUNsaWVudChjb25maWcpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB2YWx1ZSBmcm9tIGNhY2hlXG4gICAqL1xuICBhc3luYyBnZXQ8VD4oa2V5OiBzdHJpbmcpOiBQcm9taXNlPFQgfCBudWxsPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IHRoaXMucmVkaXNDbGllbnQuZ2V0Q2xpZW50KCk7XG4gICAgICBjb25zdCBmdWxsS2V5ID0gdGhpcy5yZWRpc0NsaWVudC5idWlsZEtleShrZXkpO1xuXG4gICAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IGNsaWVudC5nZXQoZnVsbEtleSk7XG5cbiAgICAgIGlmICghdmFsdWUpIHtcbiAgICAgICAgY29uc29sZS5kZWJ1ZyhcIkNhY2hlIG1pc3NcIiwgeyBrZXkgfSk7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuXG4gICAgICBjb25zb2xlLmRlYnVnKFwiQ2FjaGUgaGl0XCIsIHsga2V5IH0pO1xuICAgICAgcmV0dXJuIEpTT04ucGFyc2UodmFsdWUpIGFzIFQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJSZWRpcyBnZXQgZXJyb3JcIiwgZXJyb3IsIHsga2V5IH0pO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNldCB2YWx1ZSBpbiBjYWNoZVxuICAgKi9cbiAgYXN5bmMgc2V0PFQ+KFxuICAgIGtleTogc3RyaW5nLFxuICAgIHZhbHVlOiBULFxuICAgIG9wdGlvbnM6IENhY2hlT3B0aW9ucyA9IHt9XG4gICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBjbGllbnQgPSBhd2FpdCB0aGlzLnJlZGlzQ2xpZW50LmdldENsaWVudCgpO1xuICAgICAgY29uc3QgZnVsbEtleSA9IHRoaXMucmVkaXNDbGllbnQuYnVpbGRLZXkoa2V5KTtcblxuICAgICAgY29uc3Qgc2VyaWFsaXplZCA9IEpTT04uc3RyaW5naWZ5KHZhbHVlKTtcbiAgICAgIGNvbnN0IHR0bCA9IG9wdGlvbnMudHRsIHx8IHRoaXMuREVGQVVMVF9UVEw7XG5cbiAgICAgIGF3YWl0IGNsaWVudC5zZXRleChmdWxsS2V5LCB0dGwsIHNlcmlhbGl6ZWQpO1xuXG4gICAgICBjb25zb2xlLmRlYnVnKFwiQ2FjaGUgc2V0XCIsIHsga2V5LCB0dGwgfSk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcIlJlZGlzIHNldCBlcnJvclwiLCBlcnJvciwgeyBrZXkgfSk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZSBrZXkgZnJvbSBjYWNoZVxuICAgKi9cbiAgYXN5bmMgZGVsZXRlKGtleTogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IHRoaXMucmVkaXNDbGllbnQuZ2V0Q2xpZW50KCk7XG4gICAgICBjb25zdCBmdWxsS2V5ID0gdGhpcy5yZWRpc0NsaWVudC5idWlsZEtleShrZXkpO1xuXG4gICAgICBhd2FpdCBjbGllbnQuZGVsKGZ1bGxLZXkpO1xuXG4gICAgICBjb25zb2xlLmRlYnVnKFwiQ2FjaGUgZGVsZXRlXCIsIHsga2V5IH0pO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJSZWRpcyBkZWxldGUgZXJyb3JcIiwgZXJyb3IsIHsga2V5IH0pO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBEZWxldGUga2V5cyBtYXRjaGluZyBwYXR0ZXJuXG4gICAqL1xuICBhc3luYyBkZWxldGVQYXR0ZXJuKHBhdHRlcm46IHN0cmluZyk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IHRoaXMucmVkaXNDbGllbnQuZ2V0Q2xpZW50KCk7XG4gICAgICBjb25zdCBmdWxsUGF0dGVybiA9IHRoaXMucmVkaXNDbGllbnQuYnVpbGRLZXkocGF0dGVybik7XG5cbiAgICAgIGNvbnN0IGtleXMgPSBhd2FpdCBjbGllbnQua2V5cyhmdWxsUGF0dGVybik7XG5cbiAgICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gMDtcbiAgICAgIH1cblxuICAgICAgYXdhaXQgY2xpZW50LmRlbChrZXlzKTtcblxuICAgICAgY29uc29sZS5kZWJ1ZyhcIkNhY2hlIHBhdHRlcm4gZGVsZXRlXCIsIHsgcGF0dGVybiwgY291bnQ6IGtleXMubGVuZ3RoIH0pO1xuICAgICAgcmV0dXJuIGtleXMubGVuZ3RoO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiUmVkaXMgcGF0dGVybiBkZWxldGUgZXJyb3JcIiwgZXJyb3IsIHsgcGF0dGVybiB9KTtcbiAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgb3Igc2V0IHBhdHRlcm4gLSBmZXRjaCBmcm9tIGNhY2hlIG9yIGNvbXB1dGVcbiAgICovXG4gIGFzeW5jIGdldE9yU2V0PFQ+KFxuICAgIGtleTogc3RyaW5nLFxuICAgIGZhY3Rvcnk6ICgpID0+IFByb21pc2U8VD4sXG4gICAgb3B0aW9uczogQ2FjaGVPcHRpb25zID0ge31cbiAgKTogUHJvbWlzZTxUPiB7XG4gICAgLy8gVHJ5IHRvIGdldCBmcm9tIGNhY2hlIGZpcnN0XG4gICAgY29uc3QgY2FjaGVkID0gYXdhaXQgdGhpcy5nZXQ8VD4oa2V5KTtcbiAgICBpZiAoY2FjaGVkICE9PSBudWxsKSB7XG4gICAgICByZXR1cm4gY2FjaGVkO1xuICAgIH1cblxuICAgIC8vIENvbXB1dGUgdmFsdWVcbiAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IGZhY3RvcnkoKTtcblxuICAgIC8vIFN0b3JlIGluIGNhY2hlXG4gICAgYXdhaXQgdGhpcy5zZXQoa2V5LCB2YWx1ZSwgb3B0aW9ucyk7XG5cbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYga2V5IGV4aXN0c1xuICAgKi9cbiAgYXN5bmMgZXhpc3RzKGtleTogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IHRoaXMucmVkaXNDbGllbnQuZ2V0Q2xpZW50KCk7XG4gICAgICBjb25zdCBmdWxsS2V5ID0gdGhpcy5yZWRpc0NsaWVudC5idWlsZEtleShrZXkpO1xuXG4gICAgICBjb25zdCBleGlzdHMgPSBhd2FpdCBjbGllbnQuZXhpc3RzKGZ1bGxLZXkpO1xuICAgICAgcmV0dXJuIGV4aXN0cyA9PT0gMTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcIlJlZGlzIGV4aXN0cyBlcnJvclwiLCBlcnJvciwgeyBrZXkgfSk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBUVEwgZm9yIGtleVxuICAgKi9cbiAgYXN5bmMgdHRsKGtleTogc3RyaW5nKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY2xpZW50ID0gYXdhaXQgdGhpcy5yZWRpc0NsaWVudC5nZXRDbGllbnQoKTtcbiAgICAgIGNvbnN0IGZ1bGxLZXkgPSB0aGlzLnJlZGlzQ2xpZW50LmJ1aWxkS2V5KGtleSk7XG5cbiAgICAgIHJldHVybiBhd2FpdCBjbGllbnQudHRsKGZ1bGxLZXkpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiUmVkaXMgVFRMIGVycm9yXCIsIGVycm9yLCB7IGtleSB9KTtcbiAgICAgIHJldHVybiAtMTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSW5jcmVtZW50IGNvdW50ZXJcbiAgICovXG4gIGFzeW5jIGluY3JlbWVudChrZXk6IHN0cmluZywgYW1vdW50OiBudW1iZXIgPSAxKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY2xpZW50ID0gYXdhaXQgdGhpcy5yZWRpc0NsaWVudC5nZXRDbGllbnQoKTtcbiAgICAgIGNvbnN0IGZ1bGxLZXkgPSB0aGlzLnJlZGlzQ2xpZW50LmJ1aWxkS2V5KGtleSk7XG5cbiAgICAgIHJldHVybiBhd2FpdCBjbGllbnQuaW5jcmJ5KGZ1bGxLZXksIGFtb3VudCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJSZWRpcyBpbmNyZW1lbnQgZXJyb3JcIiwgZXJyb3IsIHsga2V5IH0pO1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEZsdXNoIGFsbCBjYWNoZVxuICAgKi9cbiAgYXN5bmMgZmx1c2hBbGwoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IHRoaXMucmVkaXNDbGllbnQuZ2V0Q2xpZW50KCk7XG4gICAgICBhd2FpdCBjbGllbnQuZmx1c2hkYigpO1xuXG4gICAgICBjb25zb2xlLndhcm4oXCJDYWNoZSBmbHVzaGVkXCIpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJSZWRpcyBmbHVzaCBlcnJvclwiLCBlcnJvcik7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIERpc2Nvbm5lY3QgZnJvbSBSZWRpc1xuICAgKi9cbiAgYXN5bmMgZGlzY29ubmVjdCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLnJlZGlzQ2xpZW50LmRpc2Nvbm5lY3QoKTtcbiAgfVxufVxuXG4vKipcbiAqIFNJTkdMRVRPTiBSRURJUyBJTlNUQU5DRVxuICogR2xvYmFsIFJlZGlzIGNhY2hlIHNlcnZpY2VcbiAqL1xubGV0IHJlZGlzSW5zdGFuY2U6IFJlZGlzQ2FjaGVTZXJ2aWNlIHwgbnVsbCA9IG51bGw7XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRSZWRpc0NhY2hlKCk6IFJlZGlzQ2FjaGVTZXJ2aWNlIHtcbiAgaWYgKCFyZWRpc0luc3RhbmNlKSB7XG4gICAgY29uc3QgY29uZmlnOiBSZWRpc0NhY2hlQ29uZmlnID0ge1xuICAgICAgaG9zdDogcHJvY2Vzcy5lbnYuUkVESVNfSE9TVCB8fCBcImxvY2FsaG9zdFwiLFxuICAgICAgcG9ydDogTnVtYmVyLnBhcnNlSW50KHByb2Nlc3MuZW52LlJFRElTX1BPUlQgfHwgXCI2Mzc5XCIsIDEwKSxcbiAgICAgIHBhc3N3b3JkOiBwcm9jZXNzLmVudi5SRURJU19QQVNTV09SRCxcbiAgICAgIGRiOiBOdW1iZXIucGFyc2VJbnQocHJvY2Vzcy5lbnYuUkVESVNfREIgfHwgXCIwXCIsIDEwKSxcbiAgICAgIGtleVByZWZpeDogcHJvY2Vzcy5lbnYuUkVESVNfS0VZX1BSRUZJWCB8fCBcImZtOlwiLFxuICAgICAgbWF4UmV0cmllczogMyxcbiAgICB9O1xuXG4gICAgcmVkaXNJbnN0YW5jZSA9IG5ldyBSZWRpc0NhY2hlU2VydmljZShjb25maWcpO1xuICB9XG5cbiAgcmV0dXJuIHJlZGlzSW5zdGFuY2U7XG59XG5cbi8qKlxuICogSEVBTFRIIENIRUNLXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjaGVja1JlZGlzSGVhbHRoKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICB0cnkge1xuICAgIGNvbnN0IHJlZGlzID0gZ2V0UmVkaXNDYWNoZSgpO1xuICAgIGF3YWl0IHJlZGlzLnNldChcImhlYWx0aDpjaGVja1wiLCB7IHRpbWVzdGFtcDogRGF0ZS5ub3coKSB9LCB7IHR0bDogMTAgfSk7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVkaXMuZ2V0PHsgdGltZXN0YW1wOiBudW1iZXIgfT4oXCJoZWFsdGg6Y2hlY2tcIik7XG4gICAgcmV0dXJuIHJlc3VsdCAhPT0gbnVsbDtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKFwiUmVkaXMgaGVhbHRoIGNoZWNrIGZhaWxlZFwiLCBlcnJvciBhcyBFcnJvcik7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=